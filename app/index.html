<!--/app/index.html-->
<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tax Monitor Pro Dashboard</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <link rel="apple-touch-icon" href="/assets/favicon.ico" />
  <link rel="icon" href="/assets/favicon.ico" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            jakarta: ['Plus Jakarta Sans', 'sans-serif']
          },
          colors: {
            amber: {
              50: '#fffbeb',
              100: '#fef3c7',
              200: '#fde68a',
              300: '#fcd34d',
              400: '#fbbf24',
              500: '#f59e0b',
              600: '#d97706',
              700: '#b45309',
              800: '#92400e',
              900: '#78350f'
            }
          }
        }
      }
    };
  </script>

  <style>
    * { box-sizing: border-box; }

    /* Animated gradient text */
    .gradient-text {
      background: linear-gradient(135deg, #f59e0b, #ef4444, #f59e0b, #fbbf24);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientShift 4s ease infinite;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* Glassmorphism card */
    .glass-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    /* Gradient border */
    .gradient-border {
      position: relative;
    }

    .gradient-border::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: inherit;
      padding: 2px;
      background: linear-gradient(135deg, #f59e0b, #ef4444, #fbbf24);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.6;
      animation: borderGlow 3s ease-in-out infinite;
    }

    @keyframes borderGlow {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    /* Aurora background */
    .aurora {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      overflow: hidden;
      z-index: 0;
      pointer-events: none;
    }

    .aurora-blob {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.4;
      animation: float 20s ease-in-out infinite;
    }

    .aurora-blob-1 {
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, #f59e0b 0%, transparent 70%);
      top: -200px;
      right: -100px;
      animation-delay: 0s;
    }

    .aurora-blob-2 {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, #ef4444 0%, transparent 70%);
      bottom: -150px;
      left: -100px;
      animation-delay: -7s;
    }

    .aurora-blob-3 {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, #fbbf24 0%, transparent 70%);
      top: 40%;
      left: 30%;
      animation-delay: -14s;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(30px, -30px) scale(1.05); }
      50% { transform: translate(-20px, 20px) scale(0.95); }
      75% { transform: translate(20px, 30px) scale(1.02); }
    }

    /* Noise overlay */
    .noise-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      opacity: 0.03;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    }

    * { outline-color: transparent !important; }
    *:focus { outline: none !important; }
    *:focus-visible { outline: none !important; }

    /* Progress ring */
    .progress-ring-circle {
      transition: stroke-dashoffset 1s ease-in-out;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }

    /* Pulse animation */
    .pulse-amber {
      animation: pulseAmber 2s ease-in-out infinite;
    }

    @keyframes pulseAmber {
      0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
      50% { box-shadow: 0 0 0 12px rgba(245, 158, 11, 0); }
    }

    /* Button glow */
    .glow-button {
      position: relative;
      overflow: hidden;
    }

    .glow-button::before {
      content: '';
      position: absolute;
      inset: -2px;
      background: linear-gradient(135deg, #f59e0b, #ef4444, #fbbf24);
      border-radius: inherit;
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .glow-button:hover::before {
      opacity: 1;
    }

    .glow-button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }

    .glow-button:active::after {
      width: 300px;
      height: 300px;
    }

    /* Badge shine */
    .badge-shine {
      position: relative;
      overflow: hidden;
    }

    .badge-shine::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.4) 50%, transparent 60%);
      transform: rotate(45deg);
      animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
      0%, 100% { transform: translateX(-100%) rotate(45deg); }
      50% { transform: translateX(100%) rotate(45deg); }
    }

    /* Timeline connector */
    .timeline-connector {
      position: absolute;
      left: 20px;
      top: 40px;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom, #f59e0b, #10b981, #64748b);
    }

    /* Keep app frame from squishing the Canva layout */
    .tm-shell { min-height: 100%; }
    .tm-main { min-width: 0; }
  </style>
</head>

<body class="h-full font-jakarta bg-slate-900 text-white overflow-auto">
  <!-- APP_SIDEBAR -->
  <!-- APP_TOPBAR -->

  <!-- Aurora Background -->
  <div class="aurora" aria-hidden="true">
    <div class="aurora-blob aurora-blob-1"></div>
    <div class="aurora-blob aurora-blob-2"></div>
    <div class="aurora-blob aurora-blob-3"></div>
  </div>

  <!-- Noise Overlay -->
  <div class="noise-overlay" aria-hidden="true"></div>

  <!-- Main Container -->
  <div class="relative z-10 tm-shell w-full p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-6">
      <!-- Hero Section -->
      <section class="glass-card gradient-border rounded-3xl p-6 md:p-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="space-y-2">
            <div class="flex items-center gap-3">
              <h1 class="text-2xl md:text-4xl font-bold">Welcome back, <span id="user-name" class="gradient-text">Sarah</span></h1>

              <!-- Animated Shield Badge -->
              <div class="badge-shine bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-full p-2 shadow-lg shadow-emerald-500/30" aria-label="Monitoring badge">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                  <path class="text-emerald-200" fill="currentColor" d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" />
                </svg>
              </div>
            </div>

            <p id="trust-line" class="text-slate-400 text-sm md:text-base flex items-center gap-2">
              <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
              Your IRS monitoring command center — built for clarity and control
            </p>
          </div>

          <div class="flex items-center gap-3">
            <div class="text-right hidden md:block">
              <p class="text-xs text-slate-500">Tax Years Covered</p>
              <p class="text-lg font-bold text-amber-300"><span id="tax-years-covered">2016 - 2025</span></p>
            </div>
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-400 to-orange-600 flex items-center justify-center text-xl font-bold shadow-lg shadow-amber-500/30">
              S
            </div>
          </div>
        </div>

        <!-- Progress & Snapshot Grid -->
        <section class="mt-12 grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Onboarding Progress Card -->
          <div class="glass-card rounded-3xl p-6">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-lg font-bold text-white">Onboarding Progress</h2>
              <span class="text-xs bg-amber-500/20 text-amber-400 px-3 py-1 rounded-full font-medium">~5 min left</span>
            </div>

            <div class="flex items-center gap-6 mb-6">
              <!-- Circular Progress -->
              <div class="relative flex-shrink-0" style="width: 160px; height: 160px;">
                <svg class="absolute inset-0 w-full h-full transform -rotate-90" viewBox="0 0 160 160" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
                  <circle cx="80" cy="80" r="70" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="10" />
                  <circle cx="80" cy="80" r="70" fill="none" stroke="url(#progressGradient)" stroke-width="10" stroke-linecap="round" stroke-dasharray="439.82" stroke-dashoffset="131.95" class="progress-ring-circle" />
                  <defs>
                    <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#f59e0b" />
                      <stop offset="100%" style="stop-color:#ef4444" />
                    </linearGradient>
                  </defs>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center gap-1">
                  <span id="progress-percent" class="text-4xl font-bold gradient-text">0%</span>
                  <span class="text-sm text-slate-500">Complete</span>
                </div>
              </div>

              <div class="flex-1">
                <div class="space-y-2">
                  <div class="flex justify-between text-sm">
                    <span class="text-slate-400">Steps Completed</span>
                    <span id="steps-completed-label" class="font-semibold text-white">0 of 0</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-slate-400">Current Step</span>
                    <span class="font-semibold text-amber-400" id="current-step-label">Intake Process</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-slate-400">Protection Level</span>
                    <span class="font-semibold text-yellow-400">Gold</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Timeline Steps -->
            <div class="relative space-y-3" id="timeline-steps">
              <div class="timeline-connector"></div>

              <!-- Step 1 (default/current) -->
              <button class="w-full flex items-center gap-3 relative text-left hover:opacity-80 transition-opacity step-button" data-step="1" data-step-key="intakeComplete" data-href="/app/pages/flows/intake/intake.html" type="button">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center z-10 shadow-lg shadow-amber-500/30 pulse-amber flex-shrink-0">
                  <span class="text-white font-bold text-sm">1</span>
                </div>
                <div class="flex-1 bg-amber-500/20 rounded-xl px-4 py-2 border border-amber-500/30">
                  <span class="text-sm font-medium text-amber-400">Intake Process</span>
                </div>
              </button>

              <!-- Step 2 -->
              <button class="w-full flex items-center gap-3 relative text-left hover:opacity-80 transition-opacity step-button" data-step="2" data-step-key="offerAccepted" data-href="/app/offer.html" type="button" disabled>
                <div class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center z-10 flex-shrink-0">
                  <svg class="w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
                <div class="flex-1 bg-slate-700/30 rounded-xl px-4 py-2">
                  <span class="text-sm font-medium text-slate-500">Offer Reviewed</span>
                </div>
              </button>

              <!-- Step 3 -->
              <button class="w-full flex items-center gap-3 relative text-left hover:opacity-80 transition-opacity step-button" data-step="3" data-step-key="agreementAccepted" data-href="/app/agreement.html" type="button" disabled>
                <div class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center z-10 flex-shrink-0">
                  <svg class="w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
                <div class="flex-1 bg-slate-700/30 rounded-xl px-4 py-2">
                  <span class="text-sm font-medium text-slate-500">Agreement Signed</span>
                </div>
              </button>

              <!-- Step 4 -->
              <button class="w-full flex items-center gap-3 relative text-left hover:opacity-80 transition-opacity step-button" data-step="4" data-step-key="paymentCompleted" data-href="/app/payment.html" type="button" disabled>
                <div class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center z-10 flex-shrink-0">
                  <svg class="w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
                <div class="flex-1 bg-slate-700/30 rounded-xl px-4 py-2">
                  <span class="text-sm font-medium text-slate-500">Payment Processed</span>
                </div>
              </button>

              <!-- Step 5 -->
              <button class="w-full flex items-center gap-3 relative text-left hover:opacity-80 transition-opacity step-button" data-step="5" data-step-key="welcomeConfirmed" data-href="/app/pages/flows/post-payment/welcome.html" type="button" disabled>
                <div class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center z-10 flex-shrink-0">
                  <svg class="w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
                <div class="flex-1 bg-slate-700/30 rounded-xl px-4 py-2">
                  <span class="text-sm font-medium text-slate-500">Welcome Package Sent</span>
                </div>
              </button>

              <!-- Step 6 -->
              <button class="w-full flex items-center gap-3 relative text-left hover:opacity-80 transition-opacity step-button" data-step="6" data-step-key="filingStatusSubmitted" data-href="/app/pages/flows/post-payment/filing-status.html" type="button" disabled>
                <div class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center z-10 flex-shrink-0">
                  <svg class="w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
                <div class="flex-1 bg-slate-700/30 rounded-xl px-4 py-2">
                  <span class="text-sm font-medium text-slate-500">Filing Status Review</span>
                </div>
              </button>

              <!-- Step 7 -->
              <button class="w-full flex items-center gap-3 relative text-left hover:opacity-80 transition-opacity step-button" data-step="7" data-step-key="addressUpdateSubmitted" data-href="/app/pages/flows/post-payment/address-update.html" type="button" disabled>
                <div class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center z-10 flex-shrink-0">
                  <svg class="w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
                <div class="flex-1 bg-slate-700/30 rounded-xl px-4 py-2">
                  <span class="text-sm font-medium text-slate-500">Address Updated</span>
                </div>
              </button>

              <!-- Step 8 -->
              <button class="w-full flex items-center gap-3 relative text-left hover:opacity-80 transition-opacity step-button" data-step="8" data-step-key="esign2848Submitted" data-href="/app/pages/flows/post-payment/esign-2848.html" type="button" disabled>
                <div class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center z-10 flex-shrink-0">
                  <svg class="w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
                <div class="flex-1 bg-slate-700/30 rounded-xl px-4 py-2">
                  <span class="text-sm font-medium text-slate-500">Form 2848 Signed</span>
                </div>
              </button>

              <!-- Step 9 -->
              <button class="w-full flex items-center gap-3 relative text-left hover:opacity-80 transition-opacity step-button" data-step="9" data-step-key="complianceSubmitted" data-href="/app/pages/flows/post-payment/compliance.html" type="button" disabled>
                <div class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center z-10 flex-shrink-0">
                  <svg class="w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
                <div class="flex-1 bg-slate-700/30 rounded-xl px-4 py-2">
                  <span class="text-sm font-medium text-slate-500">Compliance Records Submitted</span>
                </div>
              </button>

              <!-- Step 10 -->
              <button class="w-full flex items-center gap-3 relative text-left hover:opacity-80 transition-opacity step-button" data-step="10" data-step-key="reportReady" data-href="/app/pages/flows/post-payment/compliance-report.html" type="button" disabled>
                <div class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center z-10 flex-shrink-0">
                  <svg class="w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
                <div class="flex-1 bg-slate-700/30 rounded-xl px-4 py-2">
                  <span class="text-sm font-medium text-slate-500">Compliance Report Ready</span>
                </div>
              </button>
            </div>
          </div>

          <!-- Monitoring Snapshot Card -->
          <div class="glass-card rounded-3xl p-6">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-lg font-bold text-white">Monitoring Snapshot</h2>
              <span class="flex items-center gap-1 text-xs text-emerald-400">
                <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse" id="snapshot-live-dot"></span>
                <span id="snapshot-live-label">Live Monitoring</span>
              </span>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-3 gap-4 mb-6">
              <div class="text-center p-4 bg-white/5 rounded-2xl">
                <div class="flex items-center justify-center gap-2 mb-1">
                  <span class="w-2 h-2 bg-emerald-400 rounded-full"></span>
                  <span class="text-xs text-slate-400">Agreement Status</span>
                </div>
                <p class="text-xl font-bold text-emerald-400" id="metric-agreement-status">Signed</p>
                <p class="text-xs text-slate-500" id="metric-agreement-sub">Ready for Payment</p>
              </div>

              <div class="text-center p-4 bg-white/5 rounded-2xl">
                <div class="flex items-center justify-center gap-2 mb-1">
                  <span class="w-2 h-2 bg-blue-400 rounded-full"></span>
                  <span class="text-xs text-slate-400">Account Status</span>
                </div>
                <p class="text-xl font-bold text-blue-300" id="metric-account-status">Active</p>
                <p class="text-xs text-slate-500" id="metric-account-sub">Awaiting Next Step</p>
              </div>

              <div class="text-center p-4 bg-white/5 rounded-2xl">
                <div class="flex items-center justify-center gap-2 mb-1">
                  <span class="w-2 h-2 bg-emerald-400 rounded-full"></span>
                  <span class="text-xs text-slate-400">Monitoring</span>
                </div>
                <p class="text-xl font-bold text-emerald-300" id="metric-monitoring-status">Active</p>
                <p class="text-xs text-slate-500" id="metric-monitoring-sub">Full Coverage</p>
              </div>
            </div>

            <!-- Status Summary -->
            <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-2xl p-4 mb-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center">
                  <svg class="w-6 h-6 text-emerald-400" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" />
                  </svg>
                </div>
                <div>
                  <p class="font-semibold text-emerald-400" id="snapshot-headline">Agreement Signed - Ready for Payment</p>
                  <p class="text-sm text-slate-400" id="snapshot-subhead">Complete payment to proceed to the next step</p>
                </div>
              </div>
            </div>

            <!-- CTA Button -->
            <button class="w-full glow-button bg-gradient-to-r from-amber-500 via-orange-500 to-red-500 text-white font-bold py-4 px-6 rounded-2xl text-base transition-all hover:shadow-xl hover:shadow-amber-500/30 mb-6" type="button">
              <span class="flex items-center justify-center gap-2">
                <!-- Map icon (clean outline) -->
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.553 2.776A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                </svg>
                View Project Progress &amp; Map
              </span>
            </button>

            <!-- Recent Activity -->
            <div class="space-y-3">
              <h3 class="text-sm font-semibold text-slate-400">Recent Activity</h3>
              <div id="recent-activity-list" class="space-y-3"></div>
            </div>
          </div>
        </section>

        <!-- Footer -->
        <footer class="text-center py-6">
          <p class="text-sm text-slate-500">© 2025 Tax Monitor Pro. All rights reserved.</p>
          <p class="text-xs text-slate-600 mt-1">
            Encrypted in transit using industry-standard 
            <a href="https://www.cloudflare.com/learning/ssl/what-is-tls/" target="_blank" rel="noopener noreferrer" class="underline hover:text-slate-400">
              TLS
            </a>
          </p>
        </footer>
      </section>
    </div>
  </div>

  <script>
    // Default configuration (Element SDK)
    const defaultConfig = {
      user_name: 'Sarah',
      trust_line: 'Your IRS monitoring command center — built for clarity and control',
      last_check_date: 'Jan 15',
      background_color: '#0f172a',
      accent_color: '#f59e0b',
      text_color: '#ffffff',
      secondary_color: '#10b981',
      muted_color: '#64748b',
      font_family: 'Plus Jakarta Sans'
    };

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          const userNameEl = document.getElementById('user-name');
          if (userNameEl) userNameEl.textContent = config.user_name || defaultConfig.user_name;

          const trustLineEl = document.getElementById('trust-line');
          if (trustLineEl) {
            const starSvg = trustLineEl.querySelector('svg');
            trustLineEl.innerHTML = '';
            if (starSvg) trustLineEl.appendChild(starSvg);
            trustLineEl.appendChild(document.createTextNode(' ' + (config.trust_line || defaultConfig.trust_line)));
          }

          document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
          const fontFamily = config.font_family || defaultConfig.font_family;
          document.body.style.fontFamily = `${fontFamily}, sans-serif`;
        },
        mapToCapabilities: (config) => ({
          recolorables: [
            { get: () => config.background_color || defaultConfig.background_color, set: (value) => window.elementSdk.setConfig({ background_color: value }) },
            { get: () => config.accent_color || defaultConfig.accent_color, set: (value) => window.elementSdk.setConfig({ accent_color: value }) },
            { get: () => config.text_color || defaultConfig.text_color, set: (value) => window.elementSdk.setConfig({ text_color: value }) },
            { get: () => config.secondary_color || defaultConfig.secondary_color, set: (value) => window.elementSdk.setConfig({ secondary_color: value }) },
            { get: () => config.muted_color || defaultConfig.muted_color, set: (value) => window.elementSdk.setConfig({ muted_color: value }) }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (value) => window.elementSdk.setConfig({ font_family: value })
          },
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['user_name', config.user_name || defaultConfig.user_name],
          ['trust_line', config.trust_line || defaultConfig.trust_line],
          ['last_check_date', config.last_check_date || defaultConfig.last_check_date]
        ])
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Monitoring Snapshot (state-driven)
      (function setMonitoringSnapshot() {
        const stepBooleans = (window.TM_ORDER && window.TM_ORDER.stepBooleans) ? window.TM_ORDER.stepBooleans : {};

        const steps = [
          { key: 'intakeComplete', label: 'Intake Process', step: 1 },
          { key: 'offerAccepted', label: 'Offer Reviewed', step: 2 },
          { key: 'agreementAccepted', label: 'Agreement Signed', step: 3 },
          { key: 'paymentCompleted', label: 'Payment Processed', step: 4 },
          { key: 'welcomeConfirmed', label: 'Welcome Package Sent', step: 5 },
          { key: 'filingStatusSubmitted', label: 'Filing Status Review', step: 6 },
          { key: 'addressUpdateSubmitted', label: 'Address Updated', step: 7 },
          { key: 'esign2848Submitted', label: 'Form 2848 Signed', step: 8 },
          { key: 'complianceSubmitted', label: 'Compliance Records Submitted', step: 9 },
          { key: 'reportReady', label: 'Compliance Report Ready', step: 10 }
        ];

        const totalSteps = 8;
        // Client progress is the main 8-step journey (not the internal reportReady flag).
        const clientStepKeys = [
          'addressUpdateSubmitted',
          'agreementAccepted',
          'esign2848Submitted',
          'filingStatusSubmitted',
          'intakeComplete',
          'offerAccepted',
          'paymentCompleted',
          'welcomeConfirmed'
        ];
        const completedSteps = clientStepKeys.filter((k) => !!stepBooleans[k]).length;

        const percent = totalSteps === 0 ? 0 : Math.round((completedSteps / totalSteps) * 100);

        const percentEl = document.getElementById('progress-percent');
        const stepsLabelEl = document.getElementById('steps-completed-label');
        if (percentEl) percentEl.textContent = `${percent}%`;
        if (stepsLabelEl) stepsLabelEl.textContent = `${completedSteps} of ${totalSteps}`;

        let firstIncompleteIdx = 0;
        for (let i = 0; i < steps.length; i++) {
          if (!stepBooleans[steps[i].key]) { firstIncompleteIdx = i; break; }
          firstIncompleteIdx = i + 1;
        }
        const currentStep = (function pickCurrentStep() {
          // Default behavior: Step 1, unless earlier steps are complete.
          const order = [
            { key: 'intakeComplete', label: 'Intake Process', step: 1 },
            { key: 'offerAccepted', label: 'Offer Reviewed', step: 2 },
            { key: 'agreementAccepted', label: 'Agreement Signed', step: 3 },
            { key: 'paymentCompleted', label: 'Payment Processed', step: 4 },
            { key: 'welcomeConfirmed', label: 'Welcome Package Sent', step: 5 },
            { key: 'filingStatusSubmitted', label: 'Filing Status Review', step: 6 },
            { key: 'addressUpdateSubmitted', label: 'Address Updated', step: 7 },
            { key: 'esign2848Submitted', label: 'Form 2848 Signed', step: 8 }
          ];

          for (let i = 0; i < order.length; i++) {
            if (!stepBooleans[order[i].key]) return order[i];
          }

          return order[order.length - 1] || { key: 'intakeComplete', label: 'Intake Process', step: 1 };
        })();

        // Agreement Status tile
        const agreementAccepted = !!stepBooleans.agreementAccepted;
        const offerAccepted = !!stepBooleans.offerAccepted;
        const paymentCompleted = !!stepBooleans.paymentCompleted;

        const agreementStatusEl = document.getElementById('metric-agreement-status');
        const agreementSubEl = document.getElementById('metric-agreement-sub');

        if (agreementStatusEl && agreementSubEl) {
          if (agreementAccepted) {
            agreementStatusEl.textContent = 'Signed';
            agreementSubEl.textContent = paymentCompleted ? 'Payment Complete' : 'Ready for Payment';
          } else if (offerAccepted) {
            agreementStatusEl.textContent = 'Pending';
            agreementSubEl.textContent = 'Review & Sign Agreement';
          } else {
            agreementStatusEl.textContent = 'Not Started';
            agreementSubEl.textContent = 'Complete Intake First';
          }
        }

        // Account Status tile
        const accountStatusEl = document.getElementById('metric-account-status');
        const accountSubEl = document.getElementById('metric-account-sub');
        const accountLabel = String(window.TM_APP_STATE?.accountLabel || '').trim();

        if (accountStatusEl && accountSubEl) {
          const baseStatus = accountLabel || (paymentCompleted ? 'Active' : 'Setup');
          accountStatusEl.textContent = baseStatus;
          accountSubEl.textContent = `Next step: ${currentStep.label}`;
        }

        // Monitoring tile + badge
        const monitoringStatusEl = document.getElementById('metric-monitoring-status');
        const monitoringSubEl = document.getElementById('metric-monitoring-sub');
        const liveLabelEl = document.getElementById('snapshot-live-label');
        const liveDotEl = document.getElementById('snapshot-live-dot');

        const monitoringActive = typeof window.TM_APP_STATE?.monitoringActive === 'boolean'
          ? window.TM_APP_STATE.monitoringActive
          : !!stepBooleans.reportReady;

        if (monitoringStatusEl && monitoringSubEl) {
          if (monitoringActive) {
            monitoringStatusEl.textContent = 'Active';
            monitoringSubEl.textContent = 'Full Coverage';
          } else if (paymentCompleted) {
            monitoringStatusEl.textContent = 'Initializing';
            monitoringSubEl.textContent = 'Setup In Progress';
          } else {
            monitoringStatusEl.textContent = 'Inactive';
            monitoringSubEl.textContent = 'Not Yet Started';
          }
        }

        if (liveLabelEl && liveDotEl) {
          if (monitoringActive) {
            liveLabelEl.textContent = 'Live Monitoring';
            liveDotEl.className = 'w-2 h-2 bg-emerald-400 rounded-full animate-pulse';
          } else {
            liveLabelEl.textContent = 'Setup Mode';
            liveDotEl.className = 'w-2 h-2 bg-slate-500 rounded-full';
          }
        }

        // Snapshot headline + subhead
        const headlineEl = document.getElementById('snapshot-headline');
        const subheadEl = document.getElementById('snapshot-subhead');
        if (headlineEl && subheadEl) {
          headlineEl.textContent = `${currentStep.label}`;
          subheadEl.textContent = paymentCompleted ? 'Monitoring will reflect new IRS activity here as it happens.' : 'Complete the next step to activate monitoring.';

        // Timeline enable/disable + current highlight + click routing
        const currentStepLabelEl = document.getElementById('current-step-label');
        if (currentStepLabelEl) currentStepLabelEl.textContent = currentStep.label;

        const qs = window.location.search || '';
        const buttons = Array.from(document.querySelectorAll('.step-button'));

        buttons.forEach((btn) => {
          const key = btn.getAttribute('data-step-key') || '';
          const href = btn.getAttribute('data-href') || '';
          const isDone = !!stepBooleans[key];

          // Enable step if it's done OR it's the current step.
          const isCurrent = key === currentStep.key;
          const shouldEnable = isDone || isCurrent;

          btn.disabled = !shouldEnable;
          btn.classList.toggle('opacity-50', !shouldEnable);
          btn.classList.toggle('cursor-not-allowed', !shouldEnable);

          // Visual state
          const ring = btn.querySelector('div.w-10.h-10');
          const pill = btn.querySelector('div.flex-1');
          const label = btn.querySelector('span.text-sm');

          if (isDone) {
            if (ring) {
              ring.className = 'w-10 h-10 rounded-full bg-emerald-500 flex items-center justify-center z-10 shadow-lg shadow-emerald-500/30 flex-shrink-0';
              ring.innerHTML = '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" /></svg>';
            }
            if (pill) pill.className = 'flex-1 bg-emerald-500/10 rounded-xl px-4 py-2';
            if (label) label.className = 'text-sm font-medium text-emerald-400';
          } else if (isCurrent) {
            if (ring) {
              ring.className = 'w-10 h-10 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center z-10 shadow-lg shadow-amber-500/30 pulse-amber flex-shrink-0';
            }
            if (pill) pill.className = 'flex-1 bg-amber-500/20 rounded-xl px-4 py-2 border border-amber-500/30';
            if (label) label.className = 'text-sm font-medium text-amber-400';
          }

          // Routing (preserve querystring)
          btn.addEventListener('click', () => {
            if (btn.disabled) return;
            if (!href) return;
            const target = href.indexOf('?') !== -1 ? href : (href + qs);
            window.location.href = target;
          });
        });
        }
      })();
      // Tax Years Covered (dynamic)
      (function setTaxYearsCovered() {
        const el = document.getElementById('tax-years-covered');
        if (!el) return;

        const startYear = Number(window.TM_APP_STATE?.taxYearsStartYear || 2016);
        const now = new Date();
        const year = now.getFullYear();

        function dateUTC(y, m, d) {
          return new Date(Date.UTC(y, m, d));
        }

        function addDaysUTC(dt, days) {
          const out = new Date(dt.getTime());
          out.setUTCDate(out.getUTCDate() + days);
          return out;
        }

        function addMonthsUTC(dt, months) {
          const out = new Date(dt.getTime());
          const day = out.getUTCDate();
          out.setUTCDate(1);
          out.setUTCMonth(out.getUTCMonth() + months);
          const lastDay = new Date(Date.UTC(out.getUTCFullYear(), out.getUTCMonth() + 1, 0)).getUTCDate();
          out.setUTCDate(Math.min(day, lastDay));
          return out;
        }

        // Observed DC Emancipation Day (can affect tax day).
        function observedEmancipationDayUTC(y) {
          const d = dateUTC(y, 3, 16); // April 16
          const dow = d.getUTCDay();
          if (dow === 6) return dateUTC(y, 3, 15); // Sat -> Fri 15
          if (dow === 0) return dateUTC(y, 3, 17); // Sun -> Mon 17
          return d; // otherwise Apr 16
        }

        // Compute IRS filing due date (approx): Apr 15 adjusted for weekend/Emancipation Day.
        function taxDayUTC(y) {
          let d = dateUTC(y, 3, 15); // April 15
          const emanc = observedEmancipationDayUTC(y);

          if (d.getTime() === emanc.getTime()) d = addDaysUTC(d, 1);
          while (d.getUTCDay() === 6 || d.getUTCDay() === 0) d = addDaysUTC(d, 1);
          if (d.getTime() === emanc.getTime()) d = addDaysUTC(d, 1);
          while (d.getUTCDay() === 6 || d.getUTCDay() === 0) d = addDaysUTC(d, 1);

          return d;
        }

        // Transcript availability rule of thumb: ~3 months after tax day.
        const availableDate = addMonthsUTC(taxDayUTC(year), 3);
        const latestTranscriptYear = now.getTime() >= availableDate.getTime() ? year : year - 1;

        el.textContent = `${startYear} - ${latestTranscriptYear}`;
      })();

      // Recent Activity (state-driven, client-visible only)
      (function renderRecentActivity() {
        const container = document.getElementById('recent-activity-list');
        if (!container) return;

        const raw = Array.isArray(window.TM_APP_STATE?.recentActivity)
          ? window.TM_APP_STATE.recentActivity
          : [];

        // Backend logs EVERYTHING, UI only shows client-visible events.
        // Default rules:
        // - Hide visits (kind/type === 'visit')
        // - Hide anything explicitly marked visibleToClient:false
        const items = raw
          .filter((x) => x && typeof x === 'object')
          .filter((x) => (x.visibleToClient !== false))
          .filter((x) => String(x.kind || x.type || '').toLowerCase() !== 'visit')
          .slice(0, 6);

        if (!items.length) {
          container.innerHTML = '<p class="text-xs text-slate-500">No visible activity yet.</p>';
          return;
        }

        function escapeHtml(s) {
          return String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }

        function iconFor(x) {
          const t = String(x.kind || x.type || '').toLowerCase();
          const k = String(x.code || '').toLowerCase();

          if (t.includes('payment') || k.includes('stripe')) {
            return {
              bg: 'bg-emerald-500/20',
              svg: '<svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a5 5 0 00-10 0v2m-2 0h14a2 2 0 012 2v7a2 2 0 01-2 2H5a2 2 0 01-2-2v-7a2 2 0 012-2z"/></svg>'
            };
          }

          if (t.includes('webhook') || k.includes('webhook')) {
            return {
              bg: 'bg-blue-500/20',
              svg: '<svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>'
            };
          }

          if (t.includes('form') || k.includes('form')) {
            return {
              bg: 'bg-amber-500/20',
              svg: '<svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>'
            };
          }

          return {
            bg: 'bg-emerald-500/20',
            svg: '<svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" /></svg>'
          };
        }

        function timeLabel(x) {
          const ts = x.occurredAt || x.at || x.timestamp;
          if (!ts) return '';
          const d = new Date(ts);
          if (Number.isNaN(d.getTime())) return '';
          return d.toLocaleString(undefined, { day: 'numeric', hour: 'numeric', minute: '2-digit', month: 'short', year: 'numeric' });
        }

        container.innerHTML = items.map((x, idx) => {
          const title = String(x.title || x.label || x.message || `Activity ${idx + 1}`);
          const when = timeLabel(x);
          const meta = when ? when : 'Just now';
          const icon = iconFor(x);

          return `
            <button class="w-full flex items-center gap-3 p-3 bg-white/5 rounded-xl hover:bg-white/10 transition-colors cursor-pointer activity-button" type="button">
              <div class="w-8 h-8 rounded-lg ${icon.bg} flex items-center justify-center flex-shrink-0">${icon.svg}</div>
              <div class="flex-1 text-left">
                <p class="text-sm font-medium text-white">${escapeHtml(title)}</p>
                <p class="text-xs text-slate-500">${escapeHtml(meta)}</p>
              </div>
            </button>
          `;
        }).join('');
      })();

      const progressCircle = document.querySelector('.progress-ring-circle');
      if (!progressCircle) return;

      const circumference = 2 * Math.PI * 70;
      const totalSteps = (window.TM_ORDER && window.TM_ORDER.stepBooleans) ? Object.keys(window.TM_ORDER.stepBooleans).length : 0;
      const completedSteps = (window.TM_ORDER && window.TM_ORDER.stepBooleans) ? Object.values(window.TM_ORDER.stepBooleans).filter(Boolean).length : 0;
      const progress = totalSteps === 0 ? 0 : (completedSteps / totalSteps) * 100;
      const offset = circumference - (progress / 100) * circumference;

      setTimeout(() => {
        progressCircle.style.strokeDashoffset = offset;
      }, 500);
    });
  </script>
</body>
</html>