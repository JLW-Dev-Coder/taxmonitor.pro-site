<!-- /app/index.html -->
<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tax Monitor Pro - Dashboard</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <link rel="icon" href="https://taxmonitor.pro/favicon.ico" sizes="any">
  <link rel="icon" href="https://taxmonitor.pro/assets/favicon.ico" sizes="any">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['DM Sans', 'system-ui', 'sans-serif'] },
          colors: {
            slate: {
              850: '#1a1f2e',
              900: '#0f1219',
              950: '#080a0f',
            },
            amber: {
              400: '#fbbf24',
              500: '#f59e0b',
              600: '#d97706',
            }
          }
        }
      }
    };
  </script>
  <style>
      html, body { height: 100%; }
      html { font-size: 100%; }

    .tm-dashboard-scale { font-size: 125%; }

    *, *::before, *::after { box-sizing: border-box; }
    body { box-sizing: border-box; }
    * { font-family: 'DM Sans', system-ui, sans-serif; }

    .gradient-text {
      background: linear-gradient(135deg, #F59E0B, #D97706);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #F59E0B, #D97706);
    }
    .card-glow { box-shadow: none; }

    /* Dashboard surfaces (match /app/index.html look) */
    .glass-card {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .gradient-border { background: linear-gradient(135deg, #F59E0B, #D97706); }
    .gradient-btn { background: linear-gradient(135deg, #F59E0B, #D97706); }
    .gradient-btn:hover { filter: brightness(1.05); }


    /* Sidebar nav states */
    .nav-item { transition: all 0.2s ease; }
    .nav-item:hover { background: rgba(148, 163, 184, 0.08); }

    .nav-item.active {
      background: rgba(148, 163, 184, 0.12);
      border-left: 2px solid rgba(148, 163, 184, 0.45);
      color: #fff;
    }

    /* Onboarding step links */
    .tm-step-link { text-decoration: none; }
    .tm-step-link:hover { text-decoration: underline; text-underline-offset: 4px; }

    /* Progress ring */
    .progress-ring-circle {
      transition: stroke-dashoffset 1s ease-in-out;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }

    /* Timeline connector */
    .timeline-connector {
      position: absolute;
      left: 20px;
      top: 40px;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom, #f59e0b, #10b981, #64748b);
    }

    /* Pulse for current step */
    .pulse-amber { animation: pulseAmber 2s ease-in-out infinite; }
    @keyframes pulseAmber {
      0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.35); }
      50% { box-shadow: 0 0 0 12px rgba(245, 158, 11, 0); }
    }

    /* Pulse for monitoring pending (red) */
    .pulse-red { animation: pulseRed 1.8s ease-in-out infinite; }
    @keyframes pulseRed {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); }
      70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
      50% { box-shadow: 0 0 0 12px rgba(245, 158, 11, 0); }
    }



    /* Noise texture overlay */
    .noise-bg::before{
      content:'';
      position:fixed; inset:0;
      opacity:.03;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      pointer-events:none;
      z-index:1;
    }
33%{transform:translate(30px,-30px) scale(1.05)} 66%{transform:translate(-20px,20px) scale(.95)} }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-slate-950 text-slate-100 noise-bg overflow-hidden">
  <div class="relative z-10 flex h-full">
   <!-- APP SIDEBAR PARTIAL --> <!-- APP_SIDEBAR --> <!-- Main Content Area -->
   <div class="flex-1 flex flex-col min-w-0">
    <!-- APP TOPBAR PARTIAL --> <!-- APP_TOPBAR --> <!-- Main Content -->
    <main class="flex-1 overflow-auto">
     <div class="max-w-6xl mx-auto px-6 py-8">
      <!-- Trust / Headline -->
      <div class="mb-8">
       <div class="flex flex-col items-center text-center">
        
        <h1 class="text-3xl md:text-4xl font-semibold tracking-tight mb-2"><span id="greeting-prefix">Good evening, </span><span id="greeting-name" class="gradient-text">Jane</span></h1>
        <p id="subheadline" class="text-slate-400 text-base md:text-lg max-w-2xl">This is your command center — where monitoring stays visible.</p>
        <p id="helper-text" class="text-slate-500 text-sm mt-2 max-w-2xl">Track onboarding, view activity, and access your portal files anytime.</p>
       </div>
      </div><!-- Grid: Progress + Snapshot -->
      <div class="grid lg:grid-cols-2 gap-6 mb-6">
       <section class="glass-card rounded-2xl p-6 md:p-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-bold text-white">Onboarding Progress</h2>
          <span class="text-xs bg-amber-500/15 text-amber-300 px-3 py-1 rounded-full font-medium">~5 min left</span>
        </div>

        <div class="flex flex-col sm:flex-row sm:items-center gap-6 mb-6">
          <div class="relative flex-shrink-0 mx-auto sm:mx-0" style="width: 160px; height: 160px;">
            <svg class="absolute inset-0 w-full h-full transform -rotate-90" viewBox="0 0 160 160" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
              <circle cx="80" cy="80" r="70" fill="none" stroke="rgba(255,255,255,0.10)" stroke-width="10" />
              <circle id="progress-ring" cx="80" cy="80" r="70" fill="none" stroke="url(#progressGradient)" stroke-width="10" stroke-linecap="round" stroke-dasharray="439.82" stroke-dashoffset="439.82" class="progress-ring-circle" />
              <defs>
                <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#f59e0b" />
                  <stop offset="100%" style="stop-color:#ef4444" />
                </linearGradient>
              </defs>
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center gap-1">
              <span id="progress-percent" class="text-4xl font-bold gradient-text">0%</span>
              <span class="text-sm text-slate-500">Complete</span>
            </div>
          </div>

          <div class="flex-1">
            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-slate-400">Steps Completed</span>
                <span id="steps-completed-label" class="font-semibold text-white">0 of 8</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-slate-400">Current Step</span>
                <span class="font-semibold text-amber-300" id="current-step-label">Offer Reviewed</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-slate-400">Protection Level</span>
                <span class="font-semibold text-slate-400">Not Selected</span>
              </div>
            </div>
          </div>
        </div>

        <div class="relative space-y-4" id="timeline-steps">
          <div class="timeline-connector" aria-hidden="true"></div>

          <!-- Step 1 -->
          <button class="w-full flex items-start gap-3 relative text-left transition-opacity step-button" data-step="1" data-step-key="intakeComplete" data-href="/pages/flows/intake/intake.html" type="button">
            <div class="w-10 h-10 rounded-full bg-emerald-500 flex items-center justify-center z-10 shadow-lg shadow-emerald-500/25 flex-shrink-0">
              <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" /></svg>
            </div>
            <div class="flex-1 bg-emerald-500/10 rounded-xl px-4 py-3">
              <div class="flex justify-between items-start">
                <div>
                  <div class="text-sm font-medium text-emerald-300">Intake Process</div>
                  <div class="text-xs text-slate-400 mt-1">Initial information submitted and monitoring record created.</div>
                </div>
                <span class="text-xs text-emerald-400 font-medium">✓ Done</span>
              </div>
            </div>
          </button>

          <!-- Step 2 -->
          <button class="w-full flex items-start gap-3 relative text-left transition-opacity step-button" data-step="2" data-step-key="offerAccepted" data-href="/pages/flows/intake/offer.html" type="button">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center z-10 shadow-lg shadow-amber-500/25 pulse-amber flex-shrink-0">
              <span class="text-white font-bold text-sm">2</span>
            </div>
            <div class="flex-1 bg-amber-500/15 rounded-xl px-4 py-3 border border-amber-500/25">
              <div class="flex justify-between items-start">
                <div>
                  <div class="text-sm font-medium text-amber-300">Offer Reviewed</div>
                  <div class="text-xs text-slate-400 mt-1">Service scope and pricing confirmed.</div>
                </div>
                <span class="text-xs text-amber-400 font-medium">Current</span>
              </div>
            </div>
          </button>

          <!-- Step 3 -->
          <button class="w-full flex items-start gap-3 relative text-left opacity-60 step-button" data-step="3" data-step-key="agreementAccepted" data-href="/pages/flows/intake/agreement.html" type="button" disabled>
            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center z-10 flex-shrink-0">
              <span class="text-slate-300 font-semibold text-sm">3</span>
            </div>
            <div class="flex-1 bg-slate-800/30 rounded-xl px-4 py-3">
              <div class="text-sm font-medium text-slate-300">Agreement Signed</div>
              <div class="text-xs text-slate-500 mt-1">Terms accepted and engagement activated.</div>
            </div>
          </button>

          <!-- Step 4 -->
          <button class="w-full flex items-start gap-3 relative text-left opacity-60 step-button" data-step="4" data-step-key="paymentCompleted" data-href="/pages/flows/intake/payment.html" type="button" disabled>
            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center z-10 flex-shrink-0">
              <span class="text-slate-300 font-semibold text-sm">4</span>
            </div>
            <div class="flex-1 bg-slate-800/30 rounded-xl px-4 py-3">
              <div class="text-sm font-medium text-slate-300">Payment Processed</div>
              <div class="text-xs text-slate-500 mt-1">Monitoring cycle officially begins.</div>
            </div>
          </button>

          <!-- Step 5 -->
          <button class="w-full flex items-start gap-3 relative text-left opacity-60 step-button" data-step="5" data-step-key="welcomeConfirmed" data-href="/pages/flows/post-payment/welcome.html" type="button" disabled>
            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center z-10 flex-shrink-0">
              <span class="text-slate-300 font-semibold text-sm">5</span>
            </div>
            <div class="flex-1 bg-slate-800/30 rounded-xl px-4 py-3">
              <div class="text-sm font-medium text-slate-300">Welcome Package Sent</div>
              <div class="text-xs text-slate-500 mt-1">Onboarding details and next steps delivered.</div>
            </div>
          </button>

          <!-- Step 6 -->
          <button class="w-full flex items-start gap-3 relative text-left opacity-60 step-button" data-step="6" data-step-key="filingStatusSubmitted" data-href="/pages/flows/post-payment/filing-status.html" type="button" disabled>
            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center z-10 flex-shrink-0">
              <span class="text-slate-300 font-semibold text-sm">6</span>
            </div>
            <div class="flex-1 bg-slate-800/30 rounded-xl px-4 py-3">
              <div class="text-sm font-medium text-slate-300">Filing Status Review</div>
              <div class="text-xs text-slate-500 mt-1">Tax filing position confirmed for monitoring accuracy.</div>
            </div>
          </button>

          <!-- Step 7 -->
          <button class="w-full flex items-start gap-3 relative text-left opacity-60 step-button" data-step="7" data-step-key="addressUpdateSubmitted" data-href="/pages/flows/post-payment/address-update.html" type="button" disabled>
            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center z-10 flex-shrink-0">
              <span class="text-slate-300 font-semibold text-sm">7</span>
            </div>
            <div class="flex-1 bg-slate-800/30 rounded-xl px-4 py-3">
              <div class="text-sm font-medium text-slate-300">Address Updated</div>
              <div class="text-xs text-slate-500 mt-1">IRS correspondence address verified.</div>
            </div>
          </button>

          <!-- Step 8 -->
          <button class="w-full flex items-start gap-3 relative text-left opacity-60 step-button" data-step="8" data-step-key="esign2848Submitted" data-href="/pages/flows/post-payment/esign-2848.html" type="button" disabled>
            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center z-10 flex-shrink-0">
              <span class="text-slate-300 font-semibold text-sm">8</span>
            </div>
            <div class="flex-1 bg-slate-800/30 rounded-xl px-4 py-3">
              <div class="text-sm font-medium text-slate-300">Form 2848 Signed</div>
              <div class="text-xs text-slate-500 mt-1">Authorization secured for transcript access.</div>
            </div>
          </button>
        </div>
       </section>
       <section class="glass-card rounded-2xl p-6">
        <div class="flex items-center justify-between mb-5">
         <h2 id="snapshot-title" class="text-lg font-semibold text-slate-100">Monitoring Snapshot</h2>
         <span class="flex items-center gap-2 text-xs text-slate-400">
          <span class="w-2 h-2 bg-red-500 rounded-full shadow-lg shadow-red-500/50 pulse-red" id="snapshot-live-dot"></span>
          <span id="snapshot-live-label">Monitoring Pending</span>
         </span>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-5">
         <div class="text-center p-4 bg-slate-950/30 rounded-2xl border border-white/5">
          <div class="text-xs text-slate-400">Agreement Status</div>
          <p class="text-xl font-semibold text-amber-300 mt-2" id="metric-agreement-status">Unsigned</p>
          <p class="text-xs text-slate-500 mt-1" id="metric-agreement-sub">Ready for Payment</p>
         </div>

         <div class="text-center p-4 bg-slate-950/30 rounded-2xl border border-white/5">
          <div class="text-xs text-slate-400">Account Status</div>
          <p class="text-xl font-semibold text-sky-300 mt-2" id="metric-account-status">Intake</p>
          <p class="text-xs text-slate-500 mt-1" id="metric-account-sub">Awaiting Next Step</p>
         </div>

         <div class="text-center p-4 bg-slate-950/30 rounded-2xl border border-white/5">
          <div class="text-xs text-slate-400">Monitoring</div>
          <p class="text-xl font-semibold text-emerald-200 mt-2" id="metric-monitoring-status">Inactive</p>
          <p class="text-xs text-slate-500 mt-1" id="metric-monitoring-sub">Not Yet Started</p>
         </div>
        </div>

        <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-2xl p-4 mb-5">
         <div class="flex items-center gap-3">
          <div class="gradient-border p-0.5 rounded-xl">
           <div class="bg-slate-900/70 p-2 rounded-xl">
            <svg class="w-6 h-6 text-emerald-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4" />
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
           </div>
          </div>
          <div>
           <p class="font-semibold text-emerald-200" id="snapshot-headline">Offer Reviewed</p>
           <p class="text-sm text-slate-400" id="snapshot-subhead">Continue to the next step to keep onboarding moving.</p>
          </div>
         </div>
        </div>

        <a
          id="snapshot-cta"
          href="/pages/project.html"
          class="gradient-btn w-full py-3.5 px-5 rounded-xl font-semibold text-slate-900 text-sm transition-all transform hover:scale-[1.01] active:scale-[0.99] flex items-center justify-center gap-2 mb-5"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.553 2.776A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
          </svg>
          View project map &amp; status
        </a>

        <div class="space-y-3">
         <h3 class="text-sm font-semibold text-slate-300">Recent Activity</h3>
         <div id="recent-activity-list" class="space-y-3">
          <p class="text-xs text-slate-500">No client-visible activity yet.</p>
         </div>
        </div>
       </section>
      </div>
      <p id="disclaimer" class="text-center text-slate-600 text-xs pb-6">Monitoring does not create IRS representation. Representation, filing, and resolution are separate engagements.</p>
     </div>
    </main>
   </div>
  </div>
  <script>
    const defaultConfig = {
      account_label: 'Account: Monitoring',
      background_color: '#020617',
      disclaimer_text: 'Monitoring does not create IRS representation. Representation, filing, and resolution are separate engagements.',
      greeting_prefix: 'Good evening, ',
      greeting_subheadline: 'This is your command center — where monitoring stays visible.',
      helper_text: 'Track onboarding, view activity, and access your portal files anytime.',
      text_color: '#f1f5f9',
      topbar_mode: 'Monitoring Portal',
      user_name: 'Jane Doe',
    };

    function safeFirstName(fullName) {
      const s = String(fullName || '').trim();
      if (!s) return 'there';
      return s.split(/\s+/)[0] || 'there';
    }

    function initialsFromName(fullName) {
      const s = String(fullName || '').trim();
      if (!s) return 'TM';
      const parts = s.split(/\s+/).filter(Boolean);
      const first = parts[0] ? parts[0][0] : '';
      const last = parts.length > 1 ? parts[parts.length - 1][0] : '';
      const out = (first + last).toUpperCase();
      return out || 'TM';
    }

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = String(value ?? '');
    }

    function applyNavActive() {
      const path = window.location.pathname || '';
      const links = document.querySelectorAll('a.nav-item');
      links.forEach((a) => {
        const href = (a.getAttribute('href') || '');
        if (!href || href.startsWith('javascript:')) return;
        const normalizedHref = href.split('?')[0].split('#')[0];
        const isActive =
          normalizedHref === path ||
          (normalizedHref !== '/' && normalizedHref.length > 1 && path.startsWith(normalizedHref));
        a.classList.toggle('active', isActive);
      });
    }

    function applyFlowPlaceholders(state) {
      const flowLabel = document.getElementById('sidebar-flow-label');
      const flowSubtitle = document.getElementById('sidebar-flow-subtitle');

      if (flowLabel) flowLabel.textContent = state.sidebar_flow_label || 'Start Here';
      if (flowSubtitle) flowSubtitle.textContent = state.sidebar_flow_subtitle || '';
    }

    async function onConfigChange(config) {
      const merged = Object.assign({}, defaultConfig, config || {});
      const fullName = merged.user_name || defaultConfig.user_name;
      const firstName = safeFirstName(fullName);
      const initials = initialsFromName(fullName);

      window.TM_APP_STATE = window.TM_APP_STATE || {
        account_label: merged.account_label,
        phase: 'portal',
        step: 'dashboard',
        topbar_mode: merged.topbar_mode,
        user_name: fullName,
      };

      window.TM_FLOW = window.TM_FLOW || {
        phase: window.TM_APP_STATE.phase,
        step: window.TM_APP_STATE.step,
      };

      setText('greeting-prefix', merged.greeting_prefix);
      setText('greeting-name', firstName);
      setText('subheadline', merged.greeting_subheadline);
      setText('helper-text', merged.helper_text);
      setText('disclaimer', merged.disclaimer_text);

      setText('sidebar-user-name', fullName);
      setText('topbar-user-name', fullName);
      setText('sidebar-account-label', merged.account_label);
      setText('topbar-mode', merged.topbar_mode);

      document.querySelectorAll('.tm-user-initials').forEach((el) => { el.textContent = initials; });

      applyFlowPlaceholders({
        sidebar_flow_label: 'Start Here',
        sidebar_flow_subtitle: 'Intake',
      });

      applyNavActive();
    }

    function mapToCapabilities(config) {
      const merged = Object.assign({}, defaultConfig, config || {});
      return {
        borderables: [],
        fontEditable: {
          get: () => merged.font_family || 'DM Sans',
          set: (value) => window.elementSdk.setConfig({ font_family: value })
        },
        fontSizeable: {
          get: () => merged.font_size || 16,
          set: (value) => window.elementSdk.setConfig({ font_size: value })
        },
        recolorables: [
          { get: () => merged.background_color || defaultConfig.background_color, set: (value) => window.elementSdk.setConfig({ background_color: value }) },
          { get: () => merged.text_color || defaultConfig.text_color, set: (value) => window.elementSdk.setConfig({ text_color: value }) }
        ]
      };
    }

    function mapToEditPanelValues(config) {
      const merged = Object.assign({}, defaultConfig, config || {});
      return new Map([
        ['account_label', merged.account_label],
        ['disclaimer_text', merged.disclaimer_text],
        ['greeting_prefix', merged.greeting_prefix],
        ['greeting_subheadline', merged.greeting_subheadline],
        ['helper_text', merged.helper_text],
        ['topbar_mode', merged.topbar_mode],
        
        ['user_name', merged.user_name]
      ]);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    } else {
      onConfigChange(defaultConfig);
    }

    window.addEventListener('popstate', applyNavActive);

    function setDashboardProgress() {
      const stepBooleans = (window.TM_ORDER && window.TM_ORDER.stepBooleans) ? window.TM_ORDER.stepBooleans : {};
      const journey = [
        { href: '/pages/flows/intake/intake.html', key: 'intakeComplete', label: 'Intake Process', step: 1 },
        { href: '/pages/flows/intake/offer.html', key: 'offerAccepted', label: 'Offer Reviewed', step: 2 },
        { href: '/pages/flows/intake/agreement.html', key: 'agreementAccepted', label: 'Agreement Signed', step: 3 },
        { href: '/pages/flows/intake/payment.html', key: 'paymentCompleted', label: 'Payment Processed', step: 4 },
        { href: '/pages/flows/post-payment/welcome.html', key: 'welcomeConfirmed', label: 'Welcome Package Sent', step: 5 },
        { href: '/pages/flows/post-payment/filing-status.html', key: 'filingStatusSubmitted', label: 'Filing Status Review', step: 6 },
        { href: '/pages/flows/post-payment/address-update.html', key: 'addressUpdateSubmitted', label: 'Address Updated', step: 7 },
        { href: '/pages/flows/post-payment/esign-2848.html', key: 'esign2848Submitted', label: 'Form 2848 Signed', step: 8 },
      ];

      const totalSteps = journey.length;
      const completedSteps = journey.filter((s) => !!stepBooleans[s.key]).length;
      const percent = totalSteps === 0 ? 0 : Math.round((completedSteps / totalSteps) * 100);

      const percentEl = document.getElementById('progress-percent');
      const stepsLabelEl = document.getElementById('steps-completed-label');
      if (percentEl) percentEl.textContent = `${percent}%`;
      if (stepsLabelEl) stepsLabelEl.textContent = `${completedSteps} of ${totalSteps}`;

      const currentStep = (function pickCurrentStep() {
        for (let i = 0; i < journey.length; i++) {
          if (!stepBooleans[journey[i].key]) return journey[i];
        }
        return journey[journey.length - 1] || journey[0];
      })();

      const currentStepLabelEl = document.getElementById('current-step-label');
      if (currentStepLabelEl) currentStepLabelEl.textContent = currentStep.label;

      const ring = document.getElementById('progress-ring');
      if (ring) {
        const circumference = 2 * Math.PI * 70;
        const offset = circumference - (percent / 100) * circumference;
        setTimeout(() => { ring.style.strokeDashoffset = String(offset); }, 200);
      }

      const qs = window.location.search || '';
      const buttons = Array.from(document.querySelectorAll('.step-button'));

      buttons.forEach((btn) => {
        const key = btn.getAttribute('data-step-key') || '';
        const href = btn.getAttribute('data-href') || '';
        const isDone = !!stepBooleans[key];
        const isCurrent = key === currentStep.key;
        const shouldEnable = isDone || isCurrent;

        btn.disabled = !shouldEnable;
        btn.classList.toggle('opacity-50', !shouldEnable);
        btn.classList.toggle('cursor-not-allowed', !shouldEnable);

        const ringEl = btn.querySelector('div.w-10.h-10');
        const pill = btn.querySelector('div.flex-1');
        const label = btn.querySelector('span.text-sm');

        if (isDone) {
          if (ringEl) {
            ringEl.className = 'w-10 h-10 rounded-full bg-emerald-500 flex items-center justify-center z-10 shadow-lg shadow-emerald-500/25 flex-shrink-0';
            ringEl.innerHTML = '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" /></svg>';
          }
          if (pill) pill.className = 'flex-1 bg-emerald-500/10 rounded-xl px-4 py-2';
          if (label) label.className = 'text-sm font-medium text-emerald-300';
        } else if (isCurrent) {
          if (ringEl) ringEl.className = 'w-10 h-10 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center z-10 shadow-lg shadow-amber-500/25 pulse-amber flex-shrink-0';
          if (pill) pill.className = 'flex-1 bg-amber-500/15 rounded-xl px-4 py-2 border border-amber-500/25';
          if (label) label.className = 'text-sm font-medium text-amber-300';
        }

        btn.addEventListener('click', () => {
          if (btn.disabled) return;
          if (!href) return;
          const target = href.indexOf('?') !== -1 ? href : (href + qs);
          window.location.href = target;
        });
      });

      const headlineEl = document.getElementById('snapshot-headline');
      const subheadEl = document.getElementById('snapshot-subhead');
      if (headlineEl) headlineEl.textContent = currentStep.label;
      if (subheadEl) subheadEl.textContent = 'Continue to the next step to keep onboarding moving.';
    }

    document.addEventListener('DOMContentLoaded', setDashboardProgress);

  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d17afa9003527d2',t:'MTc3MTY5MjAzMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
