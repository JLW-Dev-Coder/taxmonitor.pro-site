<!--/app/index.html-->
<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tax Monitor Pro Dashboard</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet" />

  <link rel="apple-touch-icon" href="/assets/favicon.ico" />
  <link rel="icon" href="/assets/favicon.ico" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            dmsans: ['DM Sans', 'sans-serif']
          },
          colors: {
            amber: {
              50: '#fffbeb',
              100: '#fef3c7',
              200: '#fde68a',
              300: '#fcd34d',
              400: '#fbbf24',
              500: '#f59e0b',
              600: '#d97706',
              700: '#b45309',
              800: '#92400e',
              900: '#78350f'
            }
          }
        }
      }
    };
  </script>

  <style>
    * { box-sizing: border-box; font-family: 'DM Sans', sans-serif; }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    .icon-float { animation: float 3s ease-in-out infinite; }

    .gradient-text {
      background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .glass-card {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .gradient-border { background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444); }

    .gradient-btn {
      background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444);
    }
    .gradient-btn:hover {
      background: linear-gradient(135deg, #d97706, #ea580c, #dc2626);
    }

    /* Background blobs (match flow pages) */
    .blob-1 {
      position: absolute;
      width: 420px;
      height: 420px;
      background: radial-gradient(circle, rgba(245, 158, 11, 0.15) 0%, transparent 70%);
      border-radius: 50%;
      top: -110px;
      right: -120px;
      pointer-events: none;
    }
    .blob-2 {
      position: absolute;
      width: 320px;
      height: 320px;
      background: radial-gradient(circle, rgba(239, 68, 68, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      bottom: 140px;
      left: -70px;
      pointer-events: none;
    }

    /* Progress ring */
    .progress-ring-circle {
      transition: stroke-dashoffset 1s ease-in-out;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }

    /* Timeline connector */
    .timeline-connector {
      position: absolute;
      left: 20px;
      top: 40px;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom, #f59e0b, #10b981, #64748b);
    }

    /* Pulse for current step */
    .pulse-amber {
      animation: pulseAmber 2s ease-in-out infinite;
    }
    @keyframes pulseAmber {
      0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.35); }
      50% { box-shadow: 0 0 0 12px rgba(245, 158, 11, 0); }
    }

    * { outline-color: transparent !important; }
    *:focus { outline: none !important; }
    *:focus-visible { outline: none !important; }

    /* === FIX: prevent global app layout from pushing content downward === */
    body[data-page="dashboard"] #app-wrapper {
      display: flex !important;
      flex-direction: column !important;
      justify-content: flex-start !important;
      align-items: stretch !important;
      margin-top: 0 !important;
      padding-top: 0 !important;
    }

    body[data-page="dashboard"] #app-wrapper > .relative.z-10 {
      margin-top: 0 !important;
      padding-top: 2rem !important; /* keep intentional breathing room, not a full-screen void */
    }
  </style>
</head>

<body data-page="dashboard" class="h-full font-dmsans bg-slate-900 text-white overflow-auto">
  <!-- APP_SIDEBAR -->
  <!-- APP_TOPBAR -->

  <div id="app-wrapper" class="min-h-full w-full relative">
    <div class="blob-1" aria-hidden="true"></div>
    <div class="blob-2" aria-hidden="true"></div>

    <div class="relative z-10 max-w-6xl mx-auto px-4 py-8">
      <!-- Header (match flow pages) -->
      <header class="text-center mb-10">
        <div class="inline-flex items-center justify-center mb-6">
          <div class="icon-float" aria-hidden="true">
            <svg class="w-16 h-16" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="shieldGradDash" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#f59e0b" />
                  <stop offset="50%" style="stop-color:#ef4444" />
                  <stop offset="100%" style="stop-color:#fbbf24" />
                </linearGradient>
              </defs>
              <path d="M32 4L8 14v18c0 14 10 22 24 28 14-6 24-14 24-28V14L32 4z" stroke="url(#shieldGradDash)" stroke-width="2" fill="rgba(245,158,11,0.10)" />
              <path d="M24 32l6 6 12-14" stroke="url(#shieldGradDash)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="none" />
            </svg>
          </div>
        </div>

        <p class="text-amber-400 font-semibold tracking-wider uppercase text-sm mb-2">Tax Monitor Pro</p>
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold gradient-text mb-3">Dashboard</h1>

        <p id="trust-line" class="text-slate-400 text-base sm:text-lg">
          Your IRS monitoring command center, built for clarity and control
        </p>
      </header>

      <!-- Main content -->
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Onboarding Progress -->
        <div class="glass-card rounded-2xl p-6 md:p-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-bold text-white">Onboarding Progress</h2>
            <span class="text-xs bg-amber-500/15 text-amber-300 px-3 py-1 rounded-full font-medium">~5 min left</span>
          </div>

          <div class="flex flex-col sm:flex-row sm:items-center gap-6 mb-6">
            <div class="relative flex-shrink-0 mx-auto sm:mx-0" style="width: 160px; height: 160px;">
              <svg class="absolute inset-0 w-full h-full transform -rotate-90" viewBox="0 0 160 160" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
                <circle cx="80" cy="80" r="70" fill="none" stroke="rgba(255,255,255,0.10)" stroke-width="10" />
                <circle id="progress-ring" cx="80" cy="80" r="70" fill="none" stroke="url(#progressGradient)" stroke-width="10" stroke-linecap="round" stroke-dasharray="439.82" stroke-dashoffset="439.82" class="progress-ring-circle" />
                <defs>
                  <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#f59e0b" />
                    <stop offset="100%" style="stop-color:#ef4444" />
                  </linearGradient>
                </defs>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center gap-1">
                <span id="progress-percent" class="text-4xl font-bold gradient-text">0%</span>
                <span class="text-sm text-slate-500">Complete</span>
              </div>
            </div>

            <div class="flex-1">
              <div class="space-y-2">
                <div class="flex justify-between text-sm">
                  <span class="text-slate-400">Steps Completed</span>
                  <span id="steps-completed-label" class="font-semibold text-white">0 of 8</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-slate-400">Current Step</span>
                  <span class="font-semibold text-amber-300" id="current-step-label">Intake Process</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-slate-400">Protection Level</span>
                  <span class="font-semibold text-yellow-300">Gold</span>
                </div>
              </div>
            </div>
          </div>

          <div class="relative space-y-3" id="timeline-steps">
            <div class="timeline-connector" aria-hidden="true"></div>

            <button class="w-full flex items-center gap-3 relative text-left hover:opacity-90 transition-opacity step-button" data-step="1" data-step-key="intakeComplete" data-href="/app/pages/flows/intake/intake.html" type="button">
              <div class="w-10 h-10 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center z-10 shadow-lg shadow-amber-500/25 pulse-amber flex-shrink-0">
                <span class="text-white font-bold text-sm">1</span>
              </div>
              <div class="flex-1 bg-amber-500/15 rounded-xl px-4 py-2 border border-amber-500/25">
                <span class="text-sm font-medium text-amber-300">Intake Process</span>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 relative text-left hover:opacity-90 transition-opacity step-button" data-step="2" data-step-key="offerAccepted" data-href="/app/offer.html" type="button" disabled>
              <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center z-10 flex-shrink-0">
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
              </div>
              <div class="flex-1 bg-slate-800/30 rounded-xl px-4 py-2">
                <span class="text-sm font-medium text-slate-500">Offer Reviewed</span>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 relative text-left hover:opacity-90 transition-opacity step-button" data-step="3" data-step-key="agreementAccepted" data-href="/app/agreement.html" type="button" disabled>
              <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center z-10 flex-shrink-0">
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
              </div>
              <div class="flex-1 bg-slate-800/30 rounded-xl px-4 py-2">
                <span class="text-sm font-medium text-slate-500">Agreement Signed</span>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 relative text-left hover:opacity-90 transition-opacity step-button" data-step="4" data-step-key="paymentCompleted" data-href="/app/payment.html" type="button" disabled>
              <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center z-10 flex-shrink-0">
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
              </div>
              <div class="flex-1 bg-slate-800/30 rounded-xl px-4 py-2">
                <span class="text-sm font-medium text-slate-500">Payment Processed</span>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 relative text-left hover:opacity-90 transition-opacity step-button" data-step="5" data-step-key="welcomeConfirmed" data-href="/app/pages/flows/post-payment/welcome.html" type="button" disabled>
              <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center z-10 flex-shrink-0">
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
              </div>
              <div class="flex-1 bg-slate-800/30 rounded-xl px-4 py-2">
                <span class="text-sm font-medium text-slate-500">Welcome Package Sent</span>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 relative text-left hover:opacity-90 transition-opacity step-button" data-step="6" data-step-key="filingStatusSubmitted" data-href="/app/pages/flows/post-payment/filing-status.html" type="button" disabled>
              <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center z-10 flex-shrink-0">
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
              </div>
              <div class="flex-1 bg-slate-800/30 rounded-xl px-4 py-2">
                <span class="text-sm font-medium text-slate-500">Filing Status Review</span>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 relative text-left hover:opacity-90 transition-opacity step-button" data-step="7" data-step-key="addressUpdateSubmitted" data-href="/app/pages/flows/post-payment/address-update.html" type="button" disabled>
              <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center z-10 flex-shrink-0">
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
              </div>
              <div class="flex-1 bg-slate-800/30 rounded-xl px-4 py-2">
                <span class="text-sm font-medium text-slate-500">Address Updated</span>
              </div>
            </button>

            <button class="w-full flex items-center gap-3 relative text-left hover:opacity-90 transition-opacity step-button" data-step="8" data-step-key="esign2848Submitted" data-href="/app/pages/flows/post-payment/esign-2848.html" type="button" disabled>
              <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center z-10 flex-shrink-0">
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
              </div>
              <div class="flex-1 bg-slate-800/30 rounded-xl px-4 py-2">
                <span class="text-sm font-medium text-slate-500">Form 2848 Signed</span>
              </div>
            </button>
          </div>
        </div>

        <!-- Monitoring Snapshot -->
        <div class="glass-card rounded-2xl p-6 md:p-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-bold text-white">Monitoring Snapshot</h2>
            <span class="flex items-center gap-2 text-xs text-emerald-300">
              <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse" id="snapshot-live-dot"></span>
              <span id="snapshot-live-label">Live Monitoring</span>
            </span>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
            <div class="text-center p-4 bg-slate-900/40 rounded-2xl border border-white/5">
              <div class="text-xs text-slate-400">Agreement Status</div>
              <p class="text-xl font-bold text-emerald-300 mt-2" id="metric-agreement-status">Signed</p>
              <p class="text-xs text-slate-500 mt-1" id="metric-agreement-sub">Ready for Payment</p>
            </div>

            <div class="text-center p-4 bg-slate-900/40 rounded-2xl border border-white/5">
              <div class="text-xs text-slate-400">Account Status</div>
              <p class="text-xl font-bold text-blue-300 mt-2" id="metric-account-status">Active</p>
              <p class="text-xs text-slate-500 mt-1" id="metric-account-sub">Awaiting Next Step</p>
            </div>

            <div class="text-center p-4 bg-slate-900/40 rounded-2xl border border-white/5">
              <div class="text-xs text-slate-400">Monitoring</div>
              <p class="text-xl font-bold text-emerald-200 mt-2" id="metric-monitoring-status">Active</p>
              <p class="text-xs text-slate-500 mt-1" id="metric-monitoring-sub">Full Coverage</p>
            </div>
          </div>

          <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-2xl p-4 mb-6">
            <div class="flex items-center gap-3">
              <div class="gradient-border p-0.5 rounded-xl">
                <div class="bg-slate-800 p-2 rounded-xl">
                  <svg class="w-6 h-6 text-emerald-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
              </div>
              <div>
                <p class="font-semibold text-emerald-200" id="snapshot-headline">Agreement Signed - Ready for Payment</p>
                <p class="text-sm text-slate-400" id="snapshot-subhead">Complete payment to proceed to the next step</p>
              </div>
            </div>
          </div>

          <button class="gradient-btn w-full py-4 px-6 rounded-xl font-semibold text-white text-base transition-all transform hover:scale-[1.01] active:scale-[0.99] flex items-center justify-center gap-2 mb-6" type="button" id="progress-map-btn">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.553 2.776A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
            View Project Progress &amp; Map
          </button>

          <div class="space-y-3">
            <h3 class="text-sm font-semibold text-slate-300">Recent Activity</h3>
            <div id="recent-activity-list" class="space-y-3"></div>
          </div>
        </div>
      </section>

      <footer class="text-center text-slate-500 text-sm mt-10">
        <div class="flex items-center justify-center gap-4">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
            Secure
          </span>
          <span>•</span>
          <span>Confidential</span>
          <span>•</span>
          <span>Professional</span>
        </div>
        <div class="text-xs text-slate-600 mt-2">
          © <span id="footer-year">2025</span> Tax Monitor Pro. Encrypted in transit using industry-standard
          <a href="https://www.cloudflare.com/learning/ssl/what-is-tls/" target="_blank" rel="noopener noreferrer" class="underline hover:text-slate-400">TLS</a>
        </div>
      </footer>
    </div>
  </div>

  <script>
    // (unchanged JS)
    const defaultConfig = {
      user_name: 'Sarah',
      trust_line: 'Your IRS monitoring command center, built for clarity and control',
      last_check_date: 'Jan 15',
      background_color: '#0f172a',
      accent_color: '#f59e0b',
      text_color: '#ffffff',
      secondary_color: '#10b981',
      muted_color: '#64748b',
      font_family: 'DM Sans'
    };

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          const userNameEl = document.getElementById('user-name');
          if (userNameEl) userNameEl.textContent = config.user_name || defaultConfig.user_name;

          const trustLineEl = document.getElementById('trust-line');
          if (trustLineEl) trustLineEl.textContent = config.trust_line || defaultConfig.trust_line;

          document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
        },
        mapToCapabilities: (config) => ({
          recolorables: [
            { get: () => config.background_color || defaultConfig.background_color, set: (value) => window.elementSdk.setConfig({ background_color: value }) },
            { get: () => config.accent_color || defaultConfig.accent_color, set: (value) => window.elementSdk.setConfig({ accent_color: value }) },
            { get: () => config.text_color || defaultConfig.text_color, set: (value) => window.elementSdk.setConfig({ text_color: value }) },
            { get: () => config.secondary_color || defaultConfig.secondary_color, set: (value) => window.elementSdk.setConfig({ secondary_color: value }) },
            { get: () => config.muted_color || defaultConfig.muted_color, set: (value) => window.elementSdk.setConfig({ muted_color: value }) }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (value) => window.elementSdk.setConfig({ font_family: value })
          },
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['user_name', config.user_name || defaultConfig.user_name],
          ['trust_line', config.trust_line || defaultConfig.trust_line],
          ['last_check_date', config.last_check_date || defaultConfig.last_check_date]
        ])
      });
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    document.addEventListener('DOMContentLoaded', () => {
      (function setFooterYear() {
        const el = document.getElementById('footer-year');
        if (el) el.textContent = String(new Date().getFullYear());
      })();

      (function setMonitoringSnapshot() {
        const stepBooleans = (window.TM_ORDER && window.TM_ORDER.stepBooleans) ? window.TM_ORDER.stepBooleans : {};

        const journey = [
          { key: 'intakeComplete', label: 'Intake Process', step: 1 },
          { key: 'offerAccepted', label: 'Offer Reviewed', step: 2 },
          { key: 'agreementAccepted', label: 'Agreement Signed', step: 3 },
          { key: 'paymentCompleted', label: 'Payment Processed', step: 4 },
          { key: 'welcomeConfirmed', label: 'Welcome Package Sent', step: 5 },
          { key: 'filingStatusSubmitted', label: 'Filing Status Review', step: 6 },
          { key: 'addressUpdateSubmitted', label: 'Address Updated', step: 7 },
          { key: 'esign2848Submitted', label: 'Form 2848 Signed', step: 8 }
        ];

        const totalSteps = journey.length;
        const completedSteps = journey.filter((s) => !!stepBooleans[s.key]).length;
        const percent = totalSteps === 0 ? 0 : Math.round((completedSteps / totalSteps) * 100);

        const percentEl = document.getElementById('progress-percent');
        const stepsLabelEl = document.getElementById('steps-completed-label');
        if (percentEl) percentEl.textContent = `${percent}%`;
        if (stepsLabelEl) stepsLabelEl.textContent = `${completedSteps} of ${totalSteps}`;

        const currentStep = (function pickCurrentStep() {
          for (let i = 0; i < journey.length; i++) {
            if (!stepBooleans[journey[i].key]) return journey[i];
          }
          return journey[journey.length - 1] || { key: 'intakeComplete', label: 'Intake Process', step: 1 };
        })();

        const currentStepLabelEl = document.getElementById('current-step-label');
        if (currentStepLabelEl) currentStepLabelEl.textContent = currentStep.label;

        const ring = document.getElementById('progress-ring');
        if (ring) {
          const circumference = 2 * Math.PI * 70;
          const offset = circumference - (percent / 100) * circumference;
          setTimeout(() => { ring.style.strokeDashoffset = String(offset); }, 200);
        }

        const agreementAccepted = !!stepBooleans.agreementAccepted;
        const offerAccepted = !!stepBooleans.offerAccepted;
        const paymentCompleted = !!stepBooleans.paymentCompleted;

        const agreementStatusEl = document.getElementById('metric-agreement-status');
        const agreementSubEl = document.getElementById('metric-agreement-sub');
        if (agreementStatusEl && agreementSubEl) {
          if (agreementAccepted) {
            agreementStatusEl.textContent = 'Signed';
            agreementSubEl.textContent = paymentCompleted ? 'Payment Complete' : 'Ready for Payment';
          } else if (offerAccepted) {
            agreementStatusEl.textContent = 'Pending';
            agreementSubEl.textContent = 'Review & Sign Agreement';
          } else {
            agreementStatusEl.textContent = 'Not Started';
            agreementSubEl.textContent = 'Complete Intake First';
          }
        }

        const accountStatusEl = document.getElementById('metric-account-status');
        const accountSubEl = document.getElementById('metric-account-sub');
        const accountLabel = String(window.TM_APP_STATE?.accountLabel || '').trim();
        if (accountStatusEl && accountSubEl) {
          const baseStatus = accountLabel || (paymentCompleted ? 'Active' : 'Setup');
          accountStatusEl.textContent = baseStatus;
          accountSubEl.textContent = `Next step: ${currentStep.label}`;
        }

        const monitoringStatusEl = document.getElementById('metric-monitoring-status');
        const monitoringSubEl = document.getElementById('metric-monitoring-sub');
        const liveLabelEl = document.getElementById('snapshot-live-label');
        const liveDotEl = document.getElementById('snapshot-live-dot');

        const monitoringActive = typeof window.TM_APP_STATE?.monitoringActive === 'boolean'
          ? window.TM_APP_STATE.monitoringActive
          : !!stepBooleans.reportReady;

        if (monitoringStatusEl && monitoringSubEl) {
          if (monitoringActive) {
            monitoringStatusEl.textContent = 'Active';
            monitoringSubEl.textContent = 'Full Coverage';
          } else if (paymentCompleted) {
            monitoringStatusEl.textContent = 'Initializing';
            monitoringSubEl.textContent = 'Setup In Progress';
          } else {
            monitoringStatusEl.textContent = 'Inactive';
            monitoringSubEl.textContent = 'Not Yet Started';
          }
        }

        if (liveLabelEl && liveDotEl) {
          if (monitoringActive) {
            liveLabelEl.textContent = 'Live Monitoring';
            liveDotEl.className = 'w-2 h-2 bg-emerald-400 rounded-full animate-pulse';
          } else {
            const startYear = Number(window.TM_APP_STATE?.taxYearsStartYear || 2016);
            const now = new Date();
            const year = now.getFullYear();

            function dateUTC(y, m, d) { return new Date(Date.UTC(y, m, d)); }
            function addDaysUTC(dt, days) {
              const out = new Date(dt.getTime());
              out.setUTCDate(out.getUTCDate() + days);
              return out;
            }
            function addMonthsUTC(dt, months) {
              const out = new Date(dt.getTime());
              const day = out.getUTCDate();
              out.setUTCDate(1);
              out.setUTCMonth(out.getUTCMonth() + months);
              const lastDay = new Date(Date.UTC(out.getUTCFullYear(), out.getUTCMonth() + 1, 0)).getUTCDate();
              out.setUTCDate(Math.min(day, lastDay));
              return out;
            }
            function observedEmancipationDayUTC(y) {
              const d = dateUTC(y, 3, 16);
              const dow = d.getUTCDay();
              if (dow === 6) return dateUTC(y, 3, 15);
              if (dow === 0) return dateUTC(y, 3, 17);
              return d;
            }
            function taxDayUTC(y) {
              let d = dateUTC(y, 3, 15);
              const emanc = observedEmancipationDayUTC(y);
              if (d.getTime() === emanc.getTime()) d = addDaysUTC(d, 1);
              while (d.getUTCDay() === 6 || d.getUTCDay() === 0) d = addDaysUTC(d, 1);
              if (d.getTime() === emanc.getTime()) d = addDaysUTC(d, 1);
              while (d.getUTCDay() === 6 || d.getUTCDay() === 0) d = addDaysUTC(d, 1);
              return d;
            }

            const availableDate = addMonthsUTC(taxDayUTC(year), 3);
            const latestTranscriptYear = now.getTime() >= availableDate.getTime() ? year : year - 1;

            liveLabelEl.textContent = `Tax Years Covered ${startYear} - ${latestTranscriptYear}`;
            liveDotEl.className = 'w-2 h-2 bg-slate-500 rounded-full';
          }
        }

        const headlineEl = document.getElementById('snapshot-headline');
        const subheadEl = document.getElementById('snapshot-subhead');
        if (headlineEl && subheadEl) {
          headlineEl.textContent = `${currentStep.label}`;
          subheadEl.textContent = paymentCompleted
            ? 'Monitoring will reflect new IRS activity here as it happens.'
            : 'Complete the next step to activate monitoring.';
        }

        const qs = window.location.search || '';
        const buttons = Array.from(document.querySelectorAll('.step-button'));

        buttons.forEach((btn) => {
          const key = btn.getAttribute('data-step-key') || '';
          const href = btn.getAttribute('data-href') || '';
          const isDone = !!stepBooleans[key];
          const isCurrent = key === currentStep.key;
          const shouldEnable = isDone || isCurrent;

          btn.disabled = !shouldEnable;
          btn.classList.toggle('opacity-50', !shouldEnable);
          btn.classList.toggle('cursor-not-allowed', !shouldEnable);

          const ringEl = btn.querySelector('div.w-10.h-10');
          const pill = btn.querySelector('div.flex-1');
          const label = btn.querySelector('span.text-sm');

          if (isDone) {
            if (ringEl) {
              ringEl.className = 'w-10 h-10 rounded-full bg-emerald-500 flex items-center justify-center z-10 shadow-lg shadow-emerald-500/25 flex-shrink-0';
              ringEl.innerHTML = '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" /></svg>';
            }
            if (pill) pill.className = 'flex-1 bg-emerald-500/10 rounded-xl px-4 py-2';
            if (label) label.className = 'text-sm font-medium text-emerald-300';
          } else if (isCurrent) {
            if (ringEl) ringEl.className = 'w-10 h-10 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center z-10 shadow-lg shadow-amber-500/25 pulse-amber flex-shrink-0';
            if (pill) pill.className = 'flex-1 bg-amber-500/15 rounded-xl px-4 py-2 border border-amber-500/25';
            if (label) label.className = 'text-sm font-medium text-amber-300';
          }

          btn.addEventListener('click', () => {
            if (btn.disabled) return;
            if (!href) return;
            const target = href.indexOf('?') !== -1 ? href : (href + qs);
            window.location.href = target;
          });
        });

        const progressBtn = document.getElementById('progress-map-btn');
        if (progressBtn) {
          progressBtn.addEventListener('click', () => {
            const base = '/app/pages/projects.html';
            const target = qs ? base + qs : base;
            window.location.href = target;
          });
        }
      })();

      (function setTaxYearsCovered() {
        const el = document.getElementById('tax-years-covered');
        if (!el) return;

        const startYear = Number(window.TM_APP_STATE?.taxYearsStartYear || 2016);
        const now = new Date();
        const year = now.getFullYear();

        function dateUTC(y, m, d) { return new Date(Date.UTC(y, m, d)); }
        function addDaysUTC(dt, days) {
          const out = new Date(dt.getTime());
          out.setUTCDate(out.getUTCDate() + days);
          return out;
        }
        function addMonthsUTC(dt, months) {
          const out = new Date(dt.getTime());
          const day = out.getUTCDate();
          out.setUTCDate(1);
          out.setUTCMonth(out.getUTCMonth() + months);
          const lastDay = new Date(Date.UTC(out.getUTCFullYear(), out.getUTCMonth() + 1, 0)).getUTCDate();
          out.setUTCDate(Math.min(day, lastDay));
          return out;
        }
        function observedEmancipationDayUTC(y) {
          const d = dateUTC(y, 3, 16);
          const dow = d.getUTCDay();
          if (dow === 6) return dateUTC(y, 3, 15);
          if (dow === 0) return dateUTC(y, 3, 17);
          return d;
        }
        function taxDayUTC(y) {
          let d = dateUTC(y, 3, 15);
          const emanc = observedEmancipationDayUTC(y);

          if (d.getTime() === emanc.getTime()) d = addDaysUTC(d, 1);
          while (d.getUTCDay() === 6 || d.getUTCDay() === 0) d = addDaysUTC(d, 1);
          if (d.getTime() === emanc.getTime()) d = addDaysUTC(d, 1);
          while (d.getUTCDay() === 6 || d.getUTCDay() === 0) d = addDaysUTC(d, 1);

          return d;
        }

        const availableDate = addMonthsUTC(taxDayUTC(year), 3);
        const latestTranscriptYear = now.getTime() >= availableDate.getTime() ? year : year - 1;

        el.textContent = `${startYear} - ${latestTranscriptYear}`;
      })();

      (function renderRecentActivity() {
        const container = document.getElementById('recent-activity-list');
        if (!container) return;

        const raw = Array.isArray(window.TM_APP_STATE?.recentActivity)
          ? window.TM_APP_STATE.recentActivity
          : [];

        const items = raw
          .filter((x) => x && typeof x === 'object')
          .filter((x) => (x.visibleToClient !== false))
          .filter((x) => String(x.kind || x.type || '').toLowerCase() !== 'visit')
          .slice(0, 6);

        if (!items.length) {
          container.innerHTML = '<p class="text-xs text-slate-500">No client-visible activity yet.</p>';
          return;
        }

        function iconFor(x) {
          const t = String(x.kind || x.type || '').toLowerCase();
          const k = String(x.code || '').toLowerCase();

          if (t.includes('payment') || k.includes('stripe')) {
            return {
              bg: 'bg-emerald-500/20',
              fg: 'text-emerald-300',
              svg: '<svg class="w-4 h-4 text-emerald-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a5 5 0 00-10 0v2m-2 0h14a2 2 0 012 2v7a2 2 0 01-2 2H5a2 2 0 01-2-2v-7a2 2 0 012-2z"/></svg>'
            };
          }

          if (t.includes('webhook') || k.includes('webhook')) {
            return {
              bg: 'bg-blue-500/20',
              fg: 'text-blue-300',
              svg: '<svg class="w-4 h-4 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>'
            };
          }

          if (t.includes('form') || k.includes('form')) {
            return {
              bg: 'bg-amber-500/20',
              fg: 'text-amber-300',
              svg: '<svg class="w-4 h-4 text-amber-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>'
            };
          }

          return {
            bg: 'bg-slate-700/40',
            fg: 'text-slate-300',
            svg: '<svg class="w-4 h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 18a6 6 0 110-12 6 6 0 010 12z"/></svg>'
          };
        }

        function timeLabel(x) {
          const ts = x.occurredAt || x.at || x.timestamp;
          if (!ts) return '';
          const d = new Date(ts);
          if (Number.isNaN(d.getTime())) return '';
          return d.toLocaleString(undefined, { day: 'numeric', hour: 'numeric', minute: '2-digit', month: 'short', year: 'numeric' });
        }

        container.innerHTML = items.map((x, idx) => {
          const title = String(x.title || x.label || x.message || `Activity ${idx + 1}`);
          const when = timeLabel(x);
          const meta = when ? when : 'Just now';
          const icon = iconFor(x);

          return `
            <div class="flex items-center gap-3 p-3 bg-slate-900/40 rounded-xl border border-white/5">
              <div class="w-8 h-8 rounded-lg ${icon.bg} flex items-center justify-center flex-shrink-0">${icon.svg}</div>
              <div class="flex-1">
                <p class="text-sm font-medium text-white">${escapeHtml(title)}</p>
                <p class="text-xs text-slate-500">${escapeHtml(meta)}</p>
              </div>
            </div>
          `;
        }).join('');
      })();
    });
  </script>
</body>
</html>