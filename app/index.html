<!-- /app/index.html -->
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tax Monitor Pro - Dashboard</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['DM Sans', 'system-ui', 'sans-serif'] },
          colors: {
            slate: {
              850: '#1a1f2e',
              900: '#0f1219',
              950: '#080a0f',
            },
            amber: {
              400: '#fbbf24',
              500: '#f59e0b',
              600: '#d97706',
            }
          }
        }
      }
    };
  </script>

  <style>
    html, body { height: 100%; }
    *, *::before, *::after { box-sizing: border-box; }
    body { box-sizing: border-box; }
    * { font-family: 'DM Sans', system-ui, sans-serif; }

    .gradient-text {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
    }
    .card-glow {
      box-shadow: 0 0 40px rgba(251, 191, 36, 0.06), 0 0 90px rgba(251, 191, 36, 0.02);
    }

    /* Sidebar nav states */
    .nav-item { transition: all 0.2s ease; }
    .nav-item:hover { background: rgba(251, 191, 36, 0.08); }
    .nav-item.active {
      background: rgba(251, 191, 36, 0.12);
      border-left: 2px solid #f59e0b;
      color: #fff;
    }

    /* Noise texture overlay */
    .noise-bg::before{
      content:'';
      position:fixed; inset:0;
      opacity:.03;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      pointer-events:none;
      z-index:1;
    }

    /* Aurora blobs */
    .aurora-blob{ position:absolute; border-radius:50%; filter:blur(100px); opacity:.14; animation:float 20s ease-in-out infinite; }
    .aurora-1{ width:650px; height:420px; background:linear-gradient(135deg,#F59E0B,#D97706); top:8%; right:-12%; }
    .aurora-2{ width:520px; height:360px; background:linear-gradient(135deg,#2DD4BF,#14B8A6); top:42%; left:-16%; opacity:.08; animation-delay:-7s; }
    .aurora-3{ width:480px; height:320px; background:linear-gradient(135deg,#F59E0B,#EA580C); bottom:4%; right:18%; animation-delay:-14s; }
    @keyframes float{ 0%,100%{transform:translate(0,0) scale(1)} 33%{transform:translate(30px,-30px) scale(1.05)} 66%{transform:translate(-20px,20px) scale(.95)} }
  </style>
</head>

<body class="h-full bg-[#020617] text-slate-200 noise-bg overflow-hidden">
  <!-- Aurora -->
  <div class="aurora-blob aurora-1"></div>
  <div class="aurora-blob aurora-2"></div>
  <div class="aurora-blob aurora-3"></div>

  <div class="relative z-10 flex h-full">

    <!-- APP SIDEBAR PARTIAL -->
    <!-- APP_SIDEBAR -->

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col min-w-0">

      <!-- APP TOPBAR PARTIAL -->
      <!-- APP_TOPBAR -->

      <!-- Main Content -->
      <main class="flex-1 overflow-auto">
        <div class="max-w-6xl mx-auto px-6 py-8">

          <!-- Trust / Headline -->
          <div class="mb-8">
            <div class="flex flex-col items-center text-center">
              <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800/50 border border-slate-700/50 mb-6">
                <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span id="trust-line" class="text-sm text-slate-300">
                  Proactive monitoring by licensed tax professionals — intake does not establish IRS representation.
                </span>
              </div>

              <h1 class="text-3xl md:text-4xl font-semibold tracking-tight mb-2">
                <span id="greeting-prefix">Good evening, </span><span id="greeting-name" class="gradient-text">Jane</span>
              </h1>

              <p id="subheadline" class="text-slate-400 text-base md:text-lg max-w-2xl">
                This is your command center — where monitoring stays visible.
              </p>

              <p id="helper-text" class="text-slate-500 text-sm mt-2 max-w-2xl">
                Track onboarding, view activity, and access your portal files anytime.
              </p>
            </div>
          </div>

          <!-- Quick test links (for easy manual page testing) -->
          <section class="bg-slate-900/60 rounded-2xl border border-slate-800/50 p-6 card-glow mb-6">
            <h2 class="text-lg font-semibold text-slate-100">Your Monitoring Steps</h2>
            <p class="text-sm text-slate-400 mt-1">
              Access each step of your monitoring and compliance process below.
            </p>

            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-5">
              <a class="nav-item rounded-xl px-4 py-3 border border-slate-700/70 bg-slate-950/20 text-sm text-slate-100 hover:bg-slate-950/35 transition"
                 href="/app/pages/flows/post-payment/address-update.html">Address Update</a>

              <a class="nav-item rounded-xl px-4 py-3 border border-slate-700/70 bg-slate-950/20 text-sm text-slate-100 hover:bg-slate-950/35 transition"
                 href="/app/pages/flows/intake/agreement.html">Agreement</a>

              <a class="nav-item rounded-xl px-4 py-3 border border-slate-700/70 bg-slate-950/20 text-sm text-slate-100 hover:bg-slate-950/35 transition"
                 href="/app/pages/flows/post-payment/compliance-report.html">Compliance Report</a>

              <a class="nav-item rounded-xl px-4 py-3 border border-slate-700/70 bg-slate-950/20 text-sm text-slate-100 hover:bg-slate-950/35 transition"
                 href="/app/pages/flows/post-payment/esign-2848.html">eSign 2848</a>

              <a class="nav-item rounded-xl px-4 py-3 border border-slate-700/70 bg-slate-950/20 text-sm text-slate-100 hover:bg-slate-950/35 transition"
                 href="/app/pages/flows/post-payment/filing-status.html">Filing Status</a>

              <a class="nav-item rounded-xl px-4 py-3 border border-slate-700/70 bg-slate-950/20 text-sm text-slate-100 hover:bg-slate-950/35 transition"
                 href="/app/pages/flows/intake/intake.html">Intake</a>

              <a class="nav-item rounded-xl px-4 py-3 border border-slate-700/70 bg-slate-950/20 text-sm text-slate-100 hover:bg-slate-950/35 transition"
                 href="/app/pages/flows/intake/offer.html">Offer</a>

              <a class="nav-item rounded-xl px-4 py-3 border border-slate-700/70 bg-slate-950/20 text-sm text-slate-100 hover:bg-slate-950/35 transition"
                 href="/app/pages/flows/intake/payment.html">Payment</a>

              <a class="nav-item rounded-xl px-4 py-3 border border-slate-700/70 bg-slate-950/20 text-sm text-slate-100 hover:bg-slate-950/35 transition"
                 href="/app/pages/flows/post-payment/welcome.html">Welcome</a>
            </div>
          </section>

          <!-- Grid: Progress + Snapshot -->
          <div class="grid lg:grid-cols-3 gap-6 mb-6">
            <section class="lg:col-span-2 bg-slate-900/60 rounded-2xl border border-slate-800/50 p-6 card-glow">
              <div class="flex items-center justify-between gap-4 mb-5">
                <div>
                  <h2 id="progress-title" class="text-lg font-semibold text-slate-100">Onboarding Progress</h2>
                  <p id="progress-subtitle" class="text-sm text-slate-400">Clear steps. Fewer surprises.</p>
                </div>
                <span id="progress-badge" class="px-3 py-1 rounded-full bg-amber-500/10 text-amber-300 text-sm border border-amber-500/20">
                  In progress
                </span>
              </div>

              <div class="mb-5">
                <div class="flex items-center justify-between text-xs text-slate-500 mb-2">
                  <span id="progress-left">Step 2 of 9</span>
                  <span id="progress-right">Estimated: 5 business days</span>
                </div>
                <div class="h-2 rounded-full bg-slate-800 overflow-hidden">
                  <div id="progress-bar" class="h-full w-[22%] gradient-bg rounded-full"></div>
                </div>
              </div>

              <ol class="space-y-3">
                <li class="flex items-start gap-3">
                  <div class="mt-1 w-6 h-6 rounded-full bg-emerald-500/15 border border-emerald-500/30 flex items-center justify-center">
                    <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                  </div>
                  <div class="flex-1">
                    <div class="text-sm font-medium text-slate-200">Intake submitted</div>
                    <div class="text-xs text-slate-500">We received your details and created your monitoring record.</div>
                  </div>
                  <span class="text-xs text-slate-500">Done</span>
                </li>

                <li class="flex items-start gap-3">
                  <div class="mt-1 w-6 h-6 rounded-full bg-amber-500/15 border border-amber-500/30 flex items-center justify-center">
                    <span class="text-xs font-semibold text-amber-300">2</span>
                  </div>
                  <div class="flex-1">
                    <div class="text-sm font-medium text-slate-200">Offer accepted</div>
                    <div class="text-xs text-slate-500">Confirm service scope and your monitoring plan.</div>
                  </div>
                  <a id="cta-offer" href="/app/pages/flows/intake/offer.html" class="text-xs text-amber-400 hover:text-amber-300">Open</a>
                </li>

                <li class="flex items-start gap-3 opacity-90">
                  <div class="mt-1 w-6 h-6 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center">
                    <span class="text-xs font-semibold text-slate-400">3</span>
                  </div>
                  <div class="flex-1">
                    <div class="text-sm font-medium text-slate-300">Agreement accepted</div>
                    <div class="text-xs text-slate-500">Service terms and expectations.</div>
                  </div>
                  <a id="cta-agreement" href="/app/pages/flows/intake/agreement.html" class="text-xs text-slate-400 hover:text-white">Open</a>
                </li>

                <li class="flex items-start gap-3 opacity-90">
                  <div class="mt-1 w-6 h-6 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center">
                    <span class="text-xs font-semibold text-slate-400">4</span>
                  </div>
                  <div class="flex-1">
                    <div class="text-sm font-medium text-slate-300">Payment completed</div>
                    <div class="text-xs text-slate-500">Activates the monitoring cycle.</div>
                  </div>
                  <a id="cta-payment" href="/app/pages/flows/intake/payment.html" class="text-xs text-slate-400 hover:text-white">Open</a>
                </li>
              </ol>
            </section>

            <section class="bg-slate-900/60 rounded-2xl border border-slate-800/50 p-6 card-glow">
              <div class="flex items-start justify-between gap-3 mb-5">
                <div>
                  <h2 id="snapshot-title" class="text-lg font-semibold text-slate-100">Monitoring Snapshot</h2>
                  <p id="snapshot-subtitle" class="text-sm text-slate-400">Last check + quick signals.</p>
                </div>
                <div class="w-10 h-10 rounded-xl bg-amber-500/10 border border-amber-500/20 flex items-center justify-center">
                  <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
              </div>

              <div class="space-y-4">
                <div class="p-4 rounded-xl bg-slate-800/40 border border-slate-700/50">
                  <div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Last transcript check</div>
                  <div id="metric-last-check" class="text-lg font-semibold text-slate-200">Not started</div>
                  <div id="metric-last-check-sub" class="text-xs text-slate-500 mt-1">Starts after payment + authorization steps.</div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div class="p-4 rounded-xl bg-slate-800/40 border border-slate-700/50">
                    <div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Open issues</div>
                    <div id="metric-issues" class="text-2xl font-semibold">0</div>
                    <div class="text-xs text-slate-500 mt-1">Flagged items</div>
                  </div>

                  <div class="p-4 rounded-xl bg-slate-800/40 border border-slate-700/50">
                    <div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Notices</div>
                    <div id="metric-notices" class="text-2xl font-semibold">0</div>
                    <div class="text-xs text-slate-500 mt-1">In archive</div>
                  </div>
                </div>

                <div class="pt-1">
                  <a id="snapshot-cta" href="/app/files.html" class="inline-flex w-full items-center justify-center gap-2 px-4 py-3 rounded-xl gradient-bg text-slate-900 font-semibold text-sm hover:opacity-90 transition-opacity">
                    Open files &amp; reports
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </a>
                </div>
              </div>
            </section>
          </div>

          <p id="disclaimer" class="text-center text-slate-600 text-xs pb-6">
            Monitoring does not create IRS representation. Representation, filing, and resolution are separate engagements.
          </p>
        </div>
      </main>
    </div>
  </div>

  <script>
    const defaultConfig = {
      account_label: 'Account: Monitoring',
      background_color: '#020617',
      disclaimer_text: 'Monitoring does not create IRS representation. Representation, filing, and resolution are separate engagements.',
      greeting_prefix: 'Good evening, ',
      greeting_subheadline: 'This is your command center — where monitoring stays visible.',
      helper_text: 'Track onboarding, view activity, and access your portal files anytime.',
      text_color: '#e2e8f0',
      topbar_mode: 'Monitoring Portal',
      trust_line: 'Proactive monitoring by licensed tax professionals — intake does not establish IRS representation.',
      user_name: 'Jane Doe',
    };

    function safeFirstName(fullName) {
      const s = String(fullName || '').trim();
      if (!s) return 'there';
      return s.split(/\s+/)[0] || 'there';
    }

    function initialsFromName(fullName) {
      const s = String(fullName || '').trim();
      if (!s) return 'TM';
      const parts = s.split(/\s+/).filter(Boolean);
      const first = parts[0] ? parts[0][0] : '';
      const last = parts.length > 1 ? parts[parts.length - 1][0] : '';
      const out = (first + last).toUpperCase();
      return out || 'TM';
    }

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = String(value ?? '');
    }

    function applyNavActive() {
      const path = window.location.pathname || '';
      const links = document.querySelectorAll('a.nav-item');
      links.forEach((a) => {
        const href = (a.getAttribute('href') || '');
        if (!href || href.startsWith('javascript:')) return;
        const normalizedHref = href.split('?')[0].split('#')[0];
        const isActive =
          normalizedHref === path ||
          (normalizedHref !== '/' && normalizedHref.length > 1 && path.startsWith(normalizedHref));
        a.classList.toggle('active', isActive);
      });
    }

    function applyFlowPlaceholders(state) {
      // Sidebar partial can optionally include:
      // - #sidebar-flow-label (e.g., "Intake" or "My Case Status")
      // - #sidebar-flow-subtitle (e.g., "Offer" or "Post-payment")
      // This function updates them if present, otherwise does nothing.
      const flowLabel = document.getElementById('sidebar-flow-label');
      const flowSubtitle = document.getElementById('sidebar-flow-subtitle');

      if (flowLabel) flowLabel.textContent = state.sidebar_flow_label || 'Start Here';
      if (flowSubtitle) flowSubtitle.textContent = state.sidebar_flow_subtitle || '';
    }

    async function onConfigChange(config) {
      const merged = Object.assign({}, defaultConfig, config || {});
      const fullName = merged.user_name || defaultConfig.user_name;
      const firstName = safeFirstName(fullName);
      const initials = initialsFromName(fullName);

      // Unified "app state" placeholder (server/worker can inject real values later)
      window.TM_APP_STATE = window.TM_APP_STATE || {
        account_label: merged.account_label,
        phase: 'portal',
        step: 'dashboard',
        topbar_mode: merged.topbar_mode,
        user_name: fullName,
      };

      window.TM_FLOW = window.TM_FLOW || {
        phase: window.TM_APP_STATE.phase,
        step: window.TM_APP_STATE.step,
      };

      setText('greeting-prefix', merged.greeting_prefix);
      setText('greeting-name', firstName);
      setText('trust-line', merged.trust_line);
      setText('subheadline', merged.greeting_subheadline);
      setText('helper-text', merged.helper_text);
      setText('disclaimer', merged.disclaimer_text);

      setText('sidebar-user-name', fullName);
      setText('topbar-user-name', fullName);
      setText('sidebar-account-label', merged.account_label);
      setText('topbar-mode', merged.topbar_mode);

      document.querySelectorAll('.tm-user-initials').forEach((el) => { el.textContent = initials; });

      // Placeholder sidebar flow grouping
      applyFlowPlaceholders({
        sidebar_flow_label: 'Start Here',
        sidebar_flow_subtitle: 'Intake',
      });

      applyNavActive();
    }

    function mapToCapabilities(config) {
      const merged = Object.assign({}, defaultConfig, config || {});
      return {
        borderables: [],
        fontEditable: {
          get: () => merged.font_family || 'DM Sans',
          set: (value) => window.elementSdk.setConfig({ font_family: value })
        },
        fontSizeable: {
          get: () => merged.font_size || 16,
          set: (value) => window.elementSdk.setConfig({ font_size: value })
        },
        recolorables: [
          { get: () => merged.background_color || defaultConfig.background_color, set: (value) => window.elementSdk.setConfig({ background_color: value }) },
          { get: () => merged.text_color || defaultConfig.text_color, set: (value) => window.elementSdk.setConfig({ text_color: value }) }
        ]
      };
    }

    function mapToEditPanelValues(config) {
      const merged = Object.assign({}, defaultConfig, config || {});
      return new Map([
        ['account_label', merged.account_label],
        ['disclaimer_text', merged.disclaimer_text],
        ['greeting_prefix', merged.greeting_prefix],
        ['greeting_subheadline', merged.greeting_subheadline],
        ['helper_text', merged.helper_text],
        ['topbar_mode', merged.topbar_mode],
        ['trust_line', merged.trust_line],
        ['user_name', merged.user_name]
      ]);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    } else {
      onConfigChange(defaultConfig);
    }

    window.addEventListener('popstate', applyNavActive);
  </script>
</body>
</html>
