<!-- /app/pages/staff/compliance-records.html -->
<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tax Compliance Dashboard</title>

    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <script src="/_sdk/element_sdk.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&amp;family=Inter:wght@400;500;600;700&amp;display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              mono: ["JetBrains Mono", "monospace"],
              sans: ["Inter", "system-ui", "sans-serif"],
            },
            colors: {
              slate: {
                850: "#1a1f2e",
                950: "#0d1117",
              },
            },
          },
        },
      };
    </script>

    <style>
      html,
      body {
        height: 100%;
      }

      .app-container {
        flex: 1;
        overflow: auto;
        min-height: 0;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #1e293b;
      }
      ::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }

      /* Accordion animation */
      .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .accordion-content.open {
        max-height: 2000px;
      }

      /* Print styles */
      @media print {
        body {
          background: white !important;
        }
        .no-print {
          display: none !important;
        }
        .print-white {
          background: white !important;
          color: #1e293b !important;
        }
      }

      /* Tab active indicator */
      .tab-active {
        border-bottom: 2px solid #3b82f6;
        color: #f8fafc;
      }

      /* Input focus */
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      }
    </style>

    <style>
      body {
        box-sizing: border-box;
      }
    </style>

    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  </head>

  <body class="bg-slate-950 text-slate-200 font-sans">
    <!-- App chrome (injected by build.mjs) -->
    <!-- APP_TOPBAR -->

    <div class="min-h-screen flex">
      <!-- IMPORTANT: wrapper is a div because sidebar partial already includes an <aside> -->
      <div class="w-72 shrink-0 border-r border-slate-800 bg-slate-950">
        <!-- APP_SIDEBAR -->
      </div>

      <div class="flex-1 min-w-0">
        <div class="app-container flex flex-col">
          <!-- Sticky Header -->
          <header class="sticky top-0 z-50 bg-slate-900 border-b border-slate-700/50 px-6 py-3 no-print">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-6">
                <!-- Logo -->
                <div class="flex items-center gap-2">
                  <svg class="w-8 h-8 text-blue-500" viewBox="0 0 32 32" fill="none">
                    <rect x="2" y="4" width="28" height="24" rx="2" stroke="currentColor" stroke-width="2"></rect>
                    <path d="M8 12h16M8 16h12M8 20h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                    <circle cx="24" cy="20" r="4" fill="currentColor"></circle>
                  </svg>
                  <span class="font-semibold text-slate-100">TaxCompliance</span>
                </div>

                <!-- Client Info -->
                <div class="flex items-center gap-4 pl-6 border-l border-slate-700">
                  <div>
                    <p class="text-xs text-slate-500 uppercase tracking-wide">Client</p>
                    <p id="header-client-name" class="font-medium text-slate-100">Margaret Chen</p>
                  </div>
                  <div>
                    <p class="text-xs text-slate-500 uppercase tracking-wide">ID</p>
                    <p id="header-client-id" class="font-mono text-sm text-slate-300">TC-2024-00847</p>
                  </div>
                  <div class="hidden lg:block">
                    <p class="text-xs text-slate-500 uppercase tracking-wide">Order</p>
                    <p id="header-order-id" class="font-mono text-sm text-slate-300">—</p>
                  </div>
                </div>
              </div>

              <div class="flex items-center gap-4">
                <!-- Status Badge -->
                <div class="flex items-center gap-3">
                  <span
                    id="status-badge"
                    class="px-3 py-1 text-xs font-medium rounded-full bg-amber-500/20 text-amber-400 border border-amber-500/30"
                    >DRAFT</span
                  >
                  <span class="text-xs text-slate-500">
                    Last saved: <span id="last-saved" class="text-slate-400">2 min ago</span>
                  </span>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center gap-2 pl-4 border-l border-slate-700">
                  <button
                    id="save-draft-btn"
                    class="px-4 py-2 text-sm font-medium text-slate-300 bg-slate-800 border border-slate-600 rounded-md hover:bg-slate-700 transition-colors"
                    type="button"
                  >
                    Save Draft
                  </button>
                  <button
                    id="finalize-btn"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors"
                    type="button"
                  >
                    Finalize Record
                  </button>
                </div>
              </div>
            </div>
          </header>

          <!-- Tab Navigation -->
          <nav class="bg-slate-900 border-b border-slate-700/50 px-6 no-print">
            <div class="flex items-center gap-1 -mb-px overflow-x-auto">
              <button
                class="tab-btn tab-active px-4 py-3 text-sm font-medium text-slate-400 hover:text-slate-200 border-b-2 border-transparent whitespace-nowrap transition-colors"
                data-tab="overview"
                type="button"
              >
                Overview
              </button>
              <button
                class="tab-btn px-4 py-3 text-sm font-medium text-slate-400 hover:text-slate-200 border-b-2 border-transparent whitespace-nowrap transition-colors"
                data-tab="agent"
                type="button"
              >
                Agent
              </button>
              <button
                class="tab-btn px-4 py-3 text-sm font-medium text-slate-400 hover:text-slate-200 border-b-2 border-transparent whitespace-nowrap transition-colors"
                data-tab="authority"
                type="button"
              >
                Authority
              </button>
              <button
                class="tab-btn px-4 py-3 text-sm font-medium text-slate-400 hover:text-slate-200 border-b-2 border-transparent whitespace-nowrap transition-colors"
                data-tab="compliance"
                type="button"
              >
                Compliance
              </button>
              <button
                class="tab-btn px-4 py-3 text-sm font-medium text-slate-400 hover:text-slate-200 border-b-2 border-transparent whitespace-nowrap transition-colors"
                data-tab="notices"
                type="button"
              >
                Notices
              </button>
              <button
                class="tab-btn px-4 py-3 text-sm font-medium text-slate-400 hover:text-slate-200 border-b-2 border-transparent whitespace-nowrap transition-colors"
                data-tab="installment"
                type="button"
              >
                Installment Agreement
              </button>
              <button
                class="tab-btn px-4 py-3 text-sm font-medium text-slate-400 hover:text-slate-200 border-b-2 border-transparent whitespace-nowrap transition-colors"
                data-tab="revenue"
                type="button"
              >
                Revenue Officer
              </button>
              <button
                class="tab-btn px-4 py-3 text-sm font-medium text-slate-400 hover:text-slate-200 border-b-2 border-transparent whitespace-nowrap transition-colors"
                data-tab="transcripts"
                type="button"
              >
                Transcripts
              </button>
              <button
                class="tab-btn px-4 py-3 text-sm font-medium text-slate-400 hover:text-slate-200 border-b-2 border-transparent whitespace-nowrap transition-colors"
                data-tab="summary"
                type="button"
              >
                Summary
              </button>
            </div>
          </nav>

          <!-- Main Content -->
          <main class="flex-1 p-6">
            <!-- Hidden identifiers for canonical write -->
            <input id="input-account-id" type="hidden" value="" />
            <input id="input-order-id" type="hidden" value="" />

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 h-full">
              <!-- Left Column - Form Inputs -->
              <div class="lg:col-span-3 space-y-4">
                <!-- Overview Tab -->
                <div id="tab-overview" class="tab-content space-y-4">
                  <!-- Client Information Accordion -->
                  <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                    <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="client-info" type="button">
                      <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                          />
                        </svg>
                        <span class="font-medium text-slate-100">Client Information</span>
                      </div>
                      <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>
                    <div class="accordion-content open" id="accordion-client-info">
                      <div class="px-4 pb-4 border-t border-slate-700/50 pt-4">
                        <div class="grid grid-cols-2 gap-4">
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Full Legal Name</label>
                            <input
                              type="text"
                              id="input-client-name"
                              value="Margaret Chen"
                              class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm placeholder-slate-500"
                            />
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">SSN (Last 4)</label>
                            <input
                              type="text"
                              value="••••-4827"
                              class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm font-mono"
                            />
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Filing Status</label>
                            <select class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm">
                              <option>Head of Household</option>
                              <option>Married Filing Jointly</option>
                              <option>Married Filing Separately</option>
                              <option selected>Single</option>
                            </select>
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">State of Residence</label>
                            <select class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm">
                              <option selected>Select state...</option>
                              <option>California</option>
                              <option>New York</option>
                              <option>Texas</option>
                            </select>
                          </div>
                        </div>
                        <p class="mt-3 text-xs text-slate-500">Verify client identity before discussing account details with IRS representative.</p>
                      </div>
                    </div>
                  </div>

                  <!-- Account Status Accordion -->
                  <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                    <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="account-status" type="button">
                      <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                          />
                        </svg>
                        <span class="font-medium text-slate-100">Account Status</span>
                      </div>
                      <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>

                    <div class="accordion-content open" id="accordion-account-status">
                      <div class="px-4 pb-4 border-t border-slate-700/50 pt-4">

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                          <!-- Total Balance -->
                          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50">
                            <label class="text-xs text-slate-500 uppercase tracking-wide block">Total Balance</label>
                            <input
                              data-field="Total_IRS_Balance"
                              inputmode="decimal"
                              placeholder="$0.00"
                              value="$24,847.32"
                              class="mt-1 w-full bg-transparent border-0 px-0 py-0 font-mono text-lg font-medium leading-7 text-red-400"
                            />
                          </div>

                          <!-- Penalties -->
                          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50">
                            <label class="text-xs text-slate-500 uppercase tracking-wide block">Penalties</label>
                            <input
                              data-field="IRS_Penalties"
                              inputmode="decimal"
                              placeholder="$0.00"
                              value="$3,218.00"
                              class="mt-1 w-full bg-transparent border-0 px-0 py-0 font-mono text-lg font-medium leading-7 text-amber-400"
                            />
                          </div>

                          <!-- Interest -->
                          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50">
                            <label class="text-xs text-slate-500 uppercase tracking-wide block">Interest</label>
                            <input
                              data-field="IRS_Interest"
                              inputmode="decimal"
                              placeholder="$0.00"
                              value="$1,842.17"
                              class="mt-1 w-full bg-transparent border-0 px-0 py-0 font-mono text-lg font-medium leading-7 text-amber-400"
                            />
                          </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Account Status</label>
                            <select
                              data-field="IRS_Account_Status"
                              class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                            >
                              <option value="">Select...</option>
                              <option value="0">Compliant</option>
                              <option value="1">Limited Compliance</option>
                              <option value="2">Non-Compliant</option>
                              <option value="3">Unknown</option>
                            </select>
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Estimated Balance Due Range</label>
                            <select
                              data-field="Estimated_Balance_Due_Range"
                              class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                            >
                              <option value="">Select...</option>
                              <option>$10,000–$25,000</option>
                              <option>$25,001–$50,000</option>
                              <option>Over $50,000</option>
                              <option>Under $10,000</option>
                              <option>Unknown</option>
                            </select>
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Missing Years</label>
                            <select
                              data-field="IRS_Missing_Years"
                              class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                            >
                              <option value="">Select...</option>
                              <option>All years filed</option>
                              <option>Missing prior to 10-year window</option>
                              <option>Missing within 10-year window</option>
                              <option>Unable to confirm</option>
                            </select>
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Unfiled Returns Indicator</label>
                            <select
                              data-field="Unfiled_Returns_Indicator"
                              class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                            >
                              <option value="">Select...</option>
                              <option>No</option>
                              <option>Unsure</option>
                              <option>Yes</option>
                            </select>
                          </div>
                          <div class="col-span-2">
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Lien Exposure Level</label>
                            <select
                              data-field="IRS_Lien_Exposure_Level"
                              class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                            >
                              <option value="">Select...</option>
                              <option>High — lien filed or filing imminent</option>
                              <option>Low — compliant or protected status</option>
                              <option>Moderate — balance or status requires monitoring</option>
                              <option>Unknown — insufficient IRS confirmation</option>
                            </select>
                          </div>
                        </div>

                        <div class="mb-3">
                          <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Status Categories</label>
                          <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-2 p-2 bg-slate-800/50 rounded border border-slate-700/50">
                              <input type="checkbox" data-multi="IRS_Status_Categories" value="0" class="w-4 h-4 rounded border-slate-600 text-blue-500" />
                              <span class="text-sm text-slate-300">Audit</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 bg-slate-800/50 rounded border border-slate-700/50">
                              <input type="checkbox" data-multi="IRS_Status_Categories" value="1" class="w-4 h-4 rounded border-slate-600 text-blue-500" />
                              <span class="text-sm text-slate-300">Collection</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 bg-slate-800/50 rounded border border-slate-700/50">
                              <input type="checkbox" data-multi="IRS_Status_Categories" value="2" class="w-4 h-4 rounded border-slate-600 text-blue-500" />
                              <span class="text-sm text-slate-300">Installment Agreement — Active</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 bg-slate-800/50 rounded border border-slate-700/50">
                              <input type="checkbox" data-multi="IRS_Status_Categories" value="3" class="w-4 h-4 rounded border-slate-600 text-blue-500" />
                              <span class="text-sm text-slate-300">Notice</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 bg-slate-800/50 rounded border border-slate-700/50">
                              <input type="checkbox" data-multi="IRS_Status_Categories" value="4" class="w-4 h-4 rounded border-slate-600 text-blue-500" />
                              <span class="text-sm text-slate-300">OIC</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 bg-slate-800/50 rounded border border-slate-700/50">
                              <input type="checkbox" data-multi="IRS_Status_Categories" value="5" class="w-4 h-4 rounded border-slate-600 text-blue-500" />
                              <span class="text-sm text-slate-300">Pending collection</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 bg-slate-800/50 rounded border border-slate-700/50">
                              <input type="checkbox" data-multi="IRS_Status_Categories" value="6" class="w-4 h-4 rounded border-slate-600 text-blue-500" />
                              <span class="text-sm text-slate-300">RO assigned</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 bg-slate-800/50 rounded border border-slate-700/50">
                              <input type="checkbox" data-multi="IRS_Status_Categories" value="7" class="w-4 h-4 rounded border-slate-600 text-blue-500" />
                              <span class="text-sm text-slate-300">None identified</span>
                            </label>
                          </div>
                        </div>

                        <div class="flex flex-wrap gap-2">
                          <span class="inline-flex items-center px-2.5 py-1 rounded text-xs font-medium bg-red-500/20 text-red-400 border border-red-500/30">
                            <span class="w-1.5 h-1.5 rounded-full bg-red-400 mr-1.5"></span>
                            Balance Due
                          </span>
                          <span class="inline-flex items-center px-2.5 py-1 rounded text-xs font-medium bg-amber-500/20 text-amber-400 border border-amber-500/30">
                            <span class="w-1.5 h-1.5 rounded-full bg-amber-400 mr-1.5"></span>
                            Missing Returns (2)
                          </span>
                          <span class="inline-flex items-center px-2.5 py-1 rounded text-xs font-medium bg-orange-500/20 text-orange-400 border border-orange-500/30">
                            <span class="w-1.5 h-1.5 rounded-full bg-orange-400 mr-1.5"></span>
                            Lien Risk: Medium
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Call Notes Accordion -->
                  <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                    <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="call-notes" type="button">
                      <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                          />
                        </svg>
                        <span class="font-medium text-slate-100">Call Notes</span>
                        <span class="px-2 py-0.5 text-xs bg-blue-500/20 text-blue-400 rounded">Live</span>
                      </div>
                      <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>
                    <div class="accordion-content open" id="accordion-call-notes">
                      <div class="px-4 pb-4 border-t border-slate-700/50 pt-4">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Agent Department</label>
                            <select data-field="IRS_Agent_Department" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm">
                              <option value="">Select...</option>
                              <option value="0">IRS Administration Department (1040/PPS)</option>
                              <option value="1">IRS Appeals Department</option>
                              <option value="2">IRS Collection Department</option>
                              <option value="3">IRS Examination Department</option>
                            </select>
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Agent Department Phone</label>
                            <select data-field="IRS_Agent_Department_Phone" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm">
                              <option value="">Select...</option>
                              <option>IRS Automated Collections System — Business — (800) 231-3903</option>
                              <option>IRS Correspondence Examination — Individual — (800) 597-4347</option>
                              <option>IRS e-Help Desk (e-Services) — (800) 673-4348</option>
                              <option>IRS General Line — (844) 959-1040</option>
                              <option>IRS Identity Verification — (800) 975-5084</option>
                              <option>IRS International Line — (877) 298-6617</option>
                              <option>IRS OIC Brookhaven (Holtsville) — (800) 803-4980</option>
                              <option>IRS Practitioner Priority Service — Business — (800) 347-7801</option>
                              <option>IRS Practitioner Priority Service — Individual — (800) 477-4580</option>
                              <option>IRS Tax Exempt — (877) 755-7781</option>
                              <option>IRS Underreporter — Individual — (800) 868-8209</option>
                            </select>
                          </div>
                          <div class="col-span-2">
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Call Confirmation Date</label>
                            <input type="date" data-field="IRS_Call_Confirmation_Date" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm" />
                          </div>
                        </div>

                        <div class="space-y-3">
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Representative</label>
                            <input type="text" placeholder="Name and badge number" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm placeholder-slate-500" />
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Call Reference Number</label>
                            <input type="text" placeholder="Reference # from IRS" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm font-mono placeholder-slate-500" />
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Discussion Notes</label>
                            <textarea rows="4" placeholder="Document key points discussed..." class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm placeholder-slate-500 resize-none"></textarea>
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Action Items</label>
                            <textarea rows="2" placeholder="Required follow-up actions..." class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm placeholder-slate-500 resize-none"></textarea>
                          </div>
                        </div>
                        <p class="mt-3 text-xs text-slate-500">All call notes are timestamped and saved automatically.</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Agent Tab -->
                <div id="tab-agent" class="tab-content hidden space-y-4">
                  <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                    <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="poa-info" type="button">
                      <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                          />
                        </svg>
                        <span class="font-medium text-slate-100">Power of Attorney (Form 2848)</span>
                      </div>
                      <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>
                    <div class="accordion-content open" id="accordion-poa-info">
                      <div class="px-4 pb-4 border-t border-slate-700/50 pt-4">
                        <div class="grid grid-cols-2 gap-4">
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Enrolled Agent Name</label>
                            <input type="text" id="input-agent-name" value="James Morrison, EA" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm" />
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">CAF Number</label>
                            <input type="text" value="1234-56789-R" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm font-mono" />
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">PTIN</label>
                            <input type="text" value="P00123456" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm font-mono" />
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">POA Effective Date</label>
                            <input type="date" value="2024-01-15" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm" />
                          </div>
                          <div class="col-span-2">
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Tax Matters Authorized</label>
                            <input
                              type="text"
                              value="Income Tax (1040) - Years 2020, 2021, 2022, 2023, 2024"
                              class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                            />
                          </div>
                        </div>

                        <div class="mt-4 flex items-center gap-2">
                          <span class="inline-flex items-center px-2.5 py-1 rounded text-xs font-medium bg-green-500/20 text-green-400 border border-green-500/30">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                              <path
                                fill-rule="evenodd"
                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                clip-rule="evenodd"
                              />
                            </svg>
                            Active on CAF
                          </span>
                          <span class="text-xs text-slate-500">Verified 01/15/2024</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Authority Tab -->
                <div id="tab-authority" class="tab-content hidden space-y-4">
                  <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                    <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="auth-scope" type="button">
                      <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                          />
                        </svg>
                        <span class="font-medium text-slate-100">Authorization Scope</span>
                      </div>
                      <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>
                    <div class="accordion-content open" id="accordion-auth-scope">
                      <div class="px-4 pb-4 border-t border-slate-700/50 pt-4">
                        <div class="space-y-3">
                          <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-700/50">
                            <div>
                              <p class="text-sm font-medium text-slate-100">Receive Tax Information</p>
                              <p class="text-xs text-slate-500">Access account transcripts and notices</p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium bg-green-500/20 text-green-400 rounded">Authorized</span>
                          </div>

                          <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-700/50">
                            <div>
                              <p class="text-sm font-medium text-slate-100">Represent Taxpayer</p>
                              <p class="text-xs text-slate-500">Speak and negotiate on client's behalf</p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium bg-green-500/20 text-green-400 rounded">Authorized</span>
                          </div>

                          <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-700/50">
                            <div>
                              <p class="text-sm font-medium text-slate-100">Sign Return</p>
                              <p class="text-xs text-slate-500">Execute tax returns on behalf of taxpayer</p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium bg-slate-600/50 text-slate-400 rounded">Not Authorized</span>
                          </div>

                          <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-700/50">
                            <div>
                              <p class="text-sm font-medium text-slate-100">Receive Refund Checks</p>
                              <p class="text-xs text-slate-500">Accept refunds on taxpayer's behalf</p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium bg-slate-600/50 text-slate-400 rounded">Not Authorized</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Compliance Tab -->
                <div id="tab-compliance" class="tab-content hidden space-y-4">
                  <div class="flex items-center gap-1 p-1 bg-slate-800 rounded-lg w-fit">
                    <button class="year-tab px-4 py-2 text-sm font-medium rounded-md bg-blue-600 text-white" data-year="2024" type="button">2024</button>
                    <button class="year-tab px-4 py-2 text-sm font-medium rounded-md text-slate-400 hover:text-slate-200" data-year="2023" type="button">2023</button>
                    <button class="year-tab px-4 py-2 text-sm font-medium rounded-md text-slate-400 hover:text-slate-200" data-year="2022" type="button">2022</button>
                    <button class="year-tab px-4 py-2 text-sm font-medium rounded-md text-slate-400 hover:text-slate-200" data-year="2021" type="button">2021</button>
                    <button class="year-tab px-4 py-2 text-sm font-medium rounded-md text-slate-400 hover:text-slate-200" data-year="2020" type="button">2020</button>
                  </div>

                  <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                    <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="compliance-core" type="button">
                      <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                          />
                        </svg>
                        <span class="font-medium text-slate-100">Compliance Record Inputs</span>
                      </div>
                      <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>
                    <div class="accordion-content open" id="accordion-compliance-core">
                      <div class="px-4 pb-4 border-t border-slate-700/50 pt-4">
                        <div class="grid grid-cols-2 gap-4">
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Compliance Activity Type</label>
                            <select data-field="Compliance_Activity_Type" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm">
                              <option value="">Select...</option>
                              <option>Filing compliance review</option>
                              <option>IRS account verification</option>
                              <option>IRS notice review</option>
                              <option>IRS transcript request</option>
                              <option>Status confirmation</option>
                            </select>
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Compliance Period Covered</label>
                            <select data-field="Compliance_Period_Covered" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm">
                              <option value="">Select...</option>
                              <option value="0">Current month</option>
                              <option value="1">Initial 10-year review</option>
                              <option value="2">Prior quarter</option>
                              <option value="3">Prior tax year</option>
                              <option value="4">Rolling review</option>
                              <option value="5">Specific IRS notice period</option>
                            </select>
                          </div>
                          <div class="col-span-2">
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Compliance Internal Notes</label>
                            <textarea
                              rows="4"
                              data-field="Compliance_Internal_Notes"
                              placeholder="Internal notes for this compliance record..."
                              class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm placeholder-slate-500 resize-none"
                            ></textarea>
                          </div>
                        </div>
                        <p class="mt-3 text-xs text-slate-500">
                          This section is what actually gets written to canonical state. The rest of the UI is just humans enjoying pixels.
                        </p>
                      </div>
                    </div>
                  </div>

              <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="return-status" type="button">
                  <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                      />
                    </svg>
                    <span class="font-medium text-slate-100">Return Status - <span id="compliance-year">2024</span></span>
                  </div>
                  <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="accordion-content open" id="accordion-return-status">
                  <div class="px-4 pb-4 border-t border-slate-700/50 pt-4">
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Filing Status</label>
                        <select class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm">
                          <option>Extension Filed</option>
                          <option selected>Filed - Accepted</option>
                          <option>Filed - Under Review</option>
                          <option>Not Filed</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Date Filed</label>
                        <input type="date" value="2024-04-15" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm" />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">AGI Reported</label>
                        <input type="text" value="$142,500" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm font-mono" />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Tax Liability</label>
                        <input type="text" value="$28,340" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm font-mono" />
                      </div>
                    </div>

                    <div class="mt-4 p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg">
                      <div class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-amber-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                          <path
                            fill-rule="evenodd"
                            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                            clip-rule="evenodd"
                          />
                        </svg>
                        <div>
                          <p class="text-sm font-medium text-amber-400">Under IRS Examination</p>
                          <p class="text-xs text-amber-400/70 mt-0.5">CP2000 issued - unreported income discrepancy</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="balance-detail" type="button">
                  <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                    <span class="font-medium text-slate-100">Balance Detail</span>
                  </div>
                  <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="accordion-content" id="accordion-balance-detail">
                  <div class="px-4 pb-4 border-t border-slate-700/50 pt-4">
                    <table class="w-full text-sm">
                      <thead>
                        <tr class="text-xs text-slate-500 uppercase tracking-wide">
                          <th class="text-left pb-2">Component</th>
                          <th class="text-right pb-2">Amount</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-slate-700/50">
                        <tr>
                          <td class="py-2 text-slate-300">Original Tax</td>
                          <td class="py-2 text-right font-mono text-slate-100">$19,787.15</td>
                        </tr>
                        <tr>
                          <td class="py-2 text-slate-300">Failure to Pay Penalty</td>
                          <td class="py-2 text-right font-mono text-amber-400">$2,418.00</td>
                        </tr>
                        <tr>
                          <td class="py-2 text-slate-300">Failure to File Penalty</td>
                          <td class="py-2 text-right font-mono text-amber-400">$800.00</td>
                        </tr>
                        <tr>
                          <td class="py-2 text-slate-300">Interest (computed daily)</td>
                          <td class="py-2 text-right font-mono text-amber-400">$1,842.17</td>
                        </tr>
                        <tr class="font-medium">
                          <td class="py-2 text-slate-100">Total Balance</td>
                          <td class="py-2 text-right font-mono text-red-400">$24,847.32</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Notices Tab -->
            <div id="tab-notices" class="tab-content hidden space-y-4">
              <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="notice-inputs" type="button">
                  <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                      />
                    </svg>
                    <span class="font-medium text-slate-100">Notice Inputs</span>
                  </div>
                  <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="accordion-content open" id="accordion-notice-inputs">
                  <div class="px-4 pb-4 border-t border-slate-700/50 pt-4">
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Notice Received</label>
                        <select
                          data-field="IRS_Notice_Received"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                        >
                          <option value="">Select...</option>
                          <option>No</option>
                          <option>Yes</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Notice Date</label>
                        <input
                          type="date"
                          data-field="IRS_Notice_Date"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                        />
                      </div>
                      <div class="col-span-2">
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Notice Type</label>
                        <select
                          data-field="IRS_Notice_Type"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                        >
                          <option value="">Select...</option>
                          <option>Computer Paragraph (CP) Notice</option>
                          <option>IRS Letter (Other)</option>
                          <option>Long Term (LT) Notice</option>
                          <option>Notice Type Unknown</option>
                        </select>
                      </div>
                    </div>
                    <p class="mt-3 text-xs text-slate-500">The “Notice History” tiles below are visual. These fields are the canonical write.</p>
                  </div>
                </div>
              </div>

              <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="notice-history" type="button">
                  <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                      />
                    </svg>
                    <span class="font-medium text-slate-100">Notice History</span>
                    <span class="px-2 py-0.5 text-xs bg-red-500/20 text-red-400 rounded font-medium">3 Active</span>
                  </div>
                  <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="accordion-content open" id="accordion-notice-history">
                  <div class="px-4 pb-4 border-t border-slate-700/50 pt-4 space-y-3">
                    <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                      <div class="flex items-start justify-between">
                        <div>
                          <div class="flex items-center gap-2">
                            <span class="font-mono text-sm font-medium text-slate-100">CP504</span>
                            <span class="px-1.5 py-0.5 text-xs bg-red-500/30 text-red-400 rounded">Urgent</span>
                          </div>
                          <p class="text-sm text-slate-400 mt-1">Notice of Intent to Levy</p>
                          <p class="text-xs text-slate-500 mt-0.5">Response deadline: Jan 28, 2025</p>
                        </div>
                        <span class="text-xs text-slate-500">Dec 14, 2024</span>
                      </div>
                    </div>

                    <div class="p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg">
                      <div class="flex items-start justify-between">
                        <div>
                          <div class="flex items-center gap-2">
                            <span class="font-mono text-sm font-medium text-slate-100">CP2000</span>
                            <span class="px-1.5 py-0.5 text-xs bg-amber-500/30 text-amber-400 rounded">Pending</span>
                          </div>
                          <p class="text-sm text-slate-400 mt-1">Underreported Income - TY2023</p>
                          <p class="text-xs text-slate-500 mt-0.5">Response deadline: Feb 15, 2025</p>
                        </div>
                        <span class="text-xs text-slate-500">Nov 20, 2024</span>
                      </div>
                    </div>

                    <div class="p-3 bg-slate-800/50 border border-slate-700/50 rounded-lg">
                      <div class="flex items-start justify-between">
                        <div>
                          <div class="flex items-center gap-2">
                            <span class="font-mono text-sm font-medium text-slate-100">CP14</span>
                            <span class="px-1.5 py-0.5 text-xs bg-green-500/30 text-green-400 rounded">Resolved</span>
                          </div>
                          <p class="text-sm text-slate-400 mt-1">Balance Due Notice - TY2022</p>
                          <p class="text-xs text-slate-500 mt-0.5">Paid in full: Oct 1, 2024</p>
                        </div>
                        <span class="text-xs text-slate-500">Aug 15, 2024</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Installment Agreement Tab -->
            <div id="tab-installment" class="tab-content hidden space-y-4">
              <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="ia-status" type="button">
                  <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"
                      />
                    </svg>
                    <span class="font-medium text-slate-100">Installment Agreement Status</span>
                  </div>
                  <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="accordion-content open" id="accordion-ia-status">
                  <div class="px-4 pb-4 border-t border-slate-700/50 pt-4">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IA Established</label>
                        <select
                          data-field="IA_Established"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                        >
                          <option value="">Select...</option>
                          <option>No</option>
                          <option>Unable to confirm</option>
                          <option>Yes</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Requested Payment</label>
                        <input
                          type="text"
                          data-field="IA_Payment_Amount"
                          placeholder="$0.00"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm font-mono placeholder-slate-500"
                        />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Payment Date</label>
                        <input
                          type="date"
                          data-field="IA_Payment_Date"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                        />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Last Payment Amount</label>
                        <input
                          type="text"
                          data-field="IA_Last_Payment_Amount"
                          placeholder="$0.00"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm font-mono placeholder-slate-500"
                        />
                      </div>
                      <div class="col-span-2">
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Last Payment Date</label>
                        <input
                          type="date"
                          data-field="IA_Last_Payment_Date"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                        />
                      </div>
                    </div>

                    <p class="mt-3 text-xs text-slate-500">Form 9465 or online payment agreement may be required.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Revenue Officer Tab -->
            <div id="tab-revenue" class="tab-content hidden space-y-4">
              <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="ro-info" type="button">
                  <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                    <span class="font-medium text-slate-100">Revenue Officer Assignment</span>
                  </div>
                  <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="accordion-content open" id="accordion-ro-info">
                  <div class="px-4 pb-4 border-t border-slate-700/50 pt-4">
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Revenue Officer Name</label>
                        <input
                          type="text"
                          data-field="IRS_Revenue_Officer_Name"
                          placeholder="Name"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm placeholder-slate-500"
                        />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Revenue Officer Phone</label>
                        <input
                          type="text"
                          data-field="IRS_Revenue_Officer_Phone"
                          placeholder="Phone"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm placeholder-slate-500"
                        />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Revenue Officer Fax</label>
                        <input
                          type="text"
                          data-field="IRS_Revenue_Officer_Fax"
                          placeholder="Fax"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm placeholder-slate-500"
                        />
                      </div>
                      <div></div>
                      <div class="col-span-2">
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">IRS Revenue Officer Notes</label>
                        <textarea
                          rows="3"
                          data-field="IRS_Revenue_Officer_Notes"
                          placeholder="Notes about RO assignment..."
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm placeholder-slate-500 resize-none"
                        ></textarea>
                      </div>
                    </div>

                    <p class="mt-3 text-xs text-slate-500">If no RO assigned, leave blank. Blank is a valid state. Humans love those.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Transcripts Tab -->
            <div id="tab-transcripts" class="tab-content hidden space-y-4">
              <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="transcript-requests" type="button">
                  <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                      />
                    </svg>
                    <span class="font-medium text-slate-100">Transcript Requests</span>
                  </div>
                  <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="accordion-content open" id="accordion-transcript-requests">
                  <div class="px-4 pb-4 border-t border-slate-700/50 pt-4">
                    <div class="flex items-center justify-between mb-4">
                      <label class="flex items-center gap-2">
                        <input
                          type="checkbox"
                          data-field="Transcript_Request_Made"
                          class="w-4 h-4 rounded border-slate-600 text-blue-500 focus:ring-blue-500 focus:ring-offset-slate-900"
                        />
                        <span class="text-sm text-slate-300">Transcript Request Made</span>
                      </label>
                      <span class="text-xs text-slate-500">Canonical checkbox</span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Transcript Delivery Method</label>
                        <select
                          data-field="Transcript_Delivery_Method"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                        >
                          <option value="">Select...</option>
                          <option>CAF mailbox</option>
                          <option>Fax</option>
                          <option>Online account</option>
                          <option>Pending POA processing</option>
                          <option>Secure mailbox (SOR)</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Transcript Scope Confirmed</label>
                        <select
                          data-field="Transcript_Scope_Confirmed"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                        >
                          <option value="">Select...</option>
                          <option value="0">Access denied</option>
                          <option value="1">Current year only</option>
                          <option value="2">Full 10-year access</option>
                          <option value="3">Partial access</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Transcripts Retrieved From SOR</label>
                        <select
                          data-field="Transcripts_Retrieved_From_SOR"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                        >
                          <option value="">Select...</option>
                          <option>No</option>
                          <option>Unknown</option>
                          <option>Yes</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Transcript Retrieval Date</label>
                        <input
                          type="date"
                          data-field="Transcript_Retrieval_Date"
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                        />
                      </div>
                      <div class="col-span-2">
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Transcript Retrieval Notes</label>
                        <textarea
                          rows="3"
                          data-field="Transcript_Retrieval_Notes"
                          placeholder="Retrieval notes..."
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm placeholder-slate-500 resize-none"
                        ></textarea>
                      </div>
                      <div class="col-span-2">
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Transcript Files Upload</label>
                        <input
                          id="input-transcript-files"
                          type="file"
                          multiple
                          class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm"
                        />
                        <p class="mt-2 text-xs text-slate-500">
                          This page submits metadata. Your Worker should handle the actual upload pipeline (R2 receipts + canonical update).
                        </p>
                      </div>
                    </div>

                    <!-- Keep your original "pretty checkboxes" (visual only) -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                      <label class="flex items-center gap-2 p-3 bg-slate-800/50 rounded-lg border border-slate-700/50 cursor-pointer hover:bg-slate-800">
                        <input type="checkbox" checked class="w-4 h-4 rounded border-slate-600 text-blue-500 focus:ring-blue-500 focus:ring-offset-slate-900" />
                        <div>
                          <p class="text-sm font-medium text-slate-100">Account Transcript</p>
                          <p class="text-xs text-slate-500">Payment history &amp; balances</p>
                        </div>
                      </label>
                      <label class="flex items-center gap-2 p-3 bg-slate-800/50 rounded-lg border border-slate-700/50 cursor-pointer hover:bg-slate-800">
                        <input type="checkbox" class="w-4 h-4 rounded border-slate-600 text-blue-500 focus:ring-blue-500 focus:ring-offset-slate-900" />
                        <div>
                          <p class="text-sm font-medium text-slate-100">Return Transcript</p>
                          <p class="text-xs text-slate-500">Line items from filed return</p>
                        </div>
                      </label>
                      <label class="flex items-center gap-2 p-3 bg-slate-800/50 rounded-lg border border-slate-700/50 cursor-pointer hover:bg-slate-800">
                        <input type="checkbox" checked class="w-4 h-4 rounded border-slate-600 text-blue-500 focus:ring-blue-500 focus:ring-offset-slate-900" />
                        <div>
                          <p class="text-sm font-medium text-slate-100">Record of Account</p>
                          <p class="text-xs text-slate-500">Combined return + account</p>
                        </div>
                      </label>
                      <label class="flex items-center gap-2 p-3 bg-slate-800/50 rounded-lg border border-slate-700/50 cursor-pointer hover:bg-slate-800">
                        <input type="checkbox" class="w-4 h-4 rounded border-slate-600 text-blue-500 focus:ring-blue-500 focus:ring-offset-slate-900" />
                        <div>
                          <p class="text-sm font-medium text-slate-100">Wage &amp; Income</p>
                          <p class="text-xs text-slate-500">W-2s, 1099s received</p>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Summary Tab -->
            <div id="tab-summary" class="tab-content hidden space-y-4">
              <div class="accordion bg-slate-900 rounded-lg border border-slate-700/50">
                <button class="accordion-header w-full flex items-center justify-between p-4 text-left" data-accordion="case-summary" type="button">
                  <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
                      />
                    </svg>
                    <span class="font-medium text-slate-100">Case Summary</span>
                  </div>
                  <svg class="accordion-icon w-5 h-5 text-slate-500 transition-transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="accordion-content open" id="accordion-case-summary">
                  <div class="px-4 pb-4 border-t border-slate-700/50 pt-4">
                    <div>
                      <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Executive Summary</label>
                      <textarea rows="6" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-md text-slate-100 text-sm placeholder-slate-500 resize-none">
Client has outstanding balance of $24,847.32 for TY2023 and TY2024. CP504 (Intent to Levy) issued 12/14/2024 with response deadline 01/28/2025. CP2000 pending for TY2023 unreported 1099-NEC income ($12,400). Client eligible for streamlined IA. Recommend: (1) Respond to CP2000 with documentation, (2) Request IA setup before levy action, (3) Request penalty abatement for reasonable cause.</textarea
                      >
                    </div>

                    <div class="mt-4">
                      <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1.5">Next Steps</label>
                      <div class="space-y-2">
                        <label class="flex items-center gap-2 p-2 bg-slate-800/50 rounded border border-slate-700/50">
                          <input type="checkbox" class="w-4 h-4 rounded border-slate-600 text-blue-500" />
                          <span class="text-sm text-slate-300">File Form 9465 for installment agreement</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 bg-slate-800/50 rounded border border-slate-700/50">
                          <input type="checkbox" class="w-4 h-4 rounded border-slate-600 text-blue-500" />
                          <span class="text-sm text-slate-300">Submit CP2000 response with 1099-NEC documentation</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 bg-slate-800/50 rounded border border-slate-700/50">
                          <input type="checkbox" class="w-4 h-4 rounded border-slate-600 text-blue-500" />
                          <span class="text-sm text-slate-300">Submit Form 843 for penalty abatement</span>
                        </label>
                      </div>
                    </div>

                    <div class="mt-4 p-3 bg-slate-800/50 rounded border border-slate-700/50">
                      <p class="text-xs text-slate-500">
                        The canonical write for this form is based on the contract keys (IRS_* / Transcript_* / Compliance_* / IA_*). This “summary” is for humans.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column - Live Report Preview -->
              <div class="lg:col-span-2">
                <div class="sticky top-24">
                  <div class="bg-slate-900 rounded-lg border border-slate-700/50 overflow-hidden">
                    <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700/50">
                      <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span class="text-sm font-medium text-slate-100">Report Preview</span>
                      </div>
                      <button id="print-btn" class="text-xs text-blue-400 hover:text-blue-300" type="button">Print Report</button>
                    </div>

                    <div id="report-preview" class="p-4 bg-white text-slate-900 max-h-[calc(100%-3rem)] overflow-y-auto">
                      <div class="text-center border-b border-slate-200 pb-3 mb-4">
                        <h1 class="text-lg font-bold text-slate-900">Tax Compliance Report</h1>
                        <p class="text-xs text-slate-500 mt-1">Generated: <span id="report-date">January 15, 2025</span></p>
                      </div>

                      <div class="mb-4">
                        <h2 class="text-xs font-bold text-slate-700 uppercase tracking-wide mb-2">Client Information</h2>
                        <table class="w-full text-xs">
                          <tbody>
                            <tr>
                              <td class="py-1 text-slate-500 w-1/3">Name</td>
                              <td id="report-client-name" class="py-1 font-medium">Margaret Chen</td>
                            </tr>
                            <tr>
                              <td class="py-1 text-slate-500">Client ID</td>
                              <td id="report-client-id" class="py-1 font-mono">TC-2024-00847</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>

                      <div class="mb-4">
                        <h2 class="text-xs font-bold text-slate-700 uppercase tracking-wide mb-2">Account Summary</h2>
                        <table class="w-full text-xs">
                          <tbody>
                            <tr class="border-b border-slate-100">
                              <td class="py-1.5 text-slate-500">Penalties</td>
                              <td id="report-penalties" class="py-1.5 text-right font-mono font-medium text-amber-600">—</td>
                            </tr>

                            <tr class="border-b border-slate-100">
                              <td class="py-1.5 text-slate-500">Interest</td>
                              <td id="report-interest" class="py-1.5 text-right font-mono font-medium text-amber-600">—</td>
                            </tr>

                            <tr class="border-b border-slate-100">
                              <td class="py-1.5 text-slate-500">Total Balance</td>
                              <td id="report-total-balance" class="py-1.5 text-right font-mono font-medium text-red-600">—</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>

                      <div class="pt-3 border-t border-slate-200 text-center">
                        <p class="text-xs text-slate-400">Prepared by: <span id="report-agent-name">James Morrison, EA</span></p>
                      </div>
                    </div>
                  </div>

                  <div class="mt-4 bg-slate-900 rounded-lg border border-slate-700/50 p-4 no-print">
                    <p class="text-xs text-slate-400">
                      Submission: Writes a receipt first (Worker), then canonical order/account update, then ClickUp projection. The only sane way to do it.
                    </p>
                    <p class="text-xs text-slate-500 mt-2">
                      Endpoint used:
                      <span class="font-mono text-slate-300" id="debug-endpoint">—</span>
                    </p>
                  </div>
                </div>
              </div>

            </div>
          </main>
        </div>
      </div>
    </div>

    <script>
      // Default configuration
      const defaultConfig = {
        agent_name: "James Morrison, EA",
        background_color: "#0d1117",
        client_id: "TC-2024-00847",
        client_name: "Margaret Chen",
        font_family: "Inter",
        font_size: 14,
        primary_action_color: "#3b82f6",
        secondary_action_color: "#64748b",
        surface_color: "#1e293b",
        text_color: "#e2e8f0",
      };

      let config = { ...defaultConfig };
      let lastSaveTime = Date.now();

      function safeTrim(v) {
        return typeof v === "string" ? v.trim() : v;
      }

      function uuidv4() {
        if (crypto && crypto.randomUUID) return crypto.randomUUID();
        const bytes = crypto.getRandomValues(new Uint8Array(16));
        bytes[6] = (bytes[6] & 0x0f) | 0x40;
        bytes[8] = (bytes[8] & 0x3f) | 0x80;
        const hex = [...bytes].map((b) => b.toString(16).padStart(2, "0")).join("");
        return `${hex.slice(0, 8)}-${hex.slice(8, 12)}-${hex.slice(12, 16)}-${hex.slice(16, 20)}-${hex.slice(20)}`;
      }

      function getQueryParam(name) {
        const u = new URL(window.location.href);
        return u.searchParams.get(name) || "";
      }

      function setIdentifiersFromUrl() {
        const accountId = getQueryParam("accountId") || getQueryParam("account_id");
        const orderId = getQueryParam("orderId") || getQueryParam("order_id");

        document.getElementById("input-account-id").value = accountId;
        document.getElementById("input-order-id").value = orderId;

        if (orderId) document.getElementById("header-order-id").textContent = orderId;

        if (!config.client_id && orderId) {
          config.client_id = orderId;
          applyConfig();
        }
      }

      function collectFields() {
        const fields = {};

        document.querySelectorAll("[data-field]").forEach((el) => {
          const key = el.getAttribute("data-field");
          if (!key) return;

          if (el.type === "checkbox") {
            fields[key] = !!el.checked;
            return;
          }

          if (el.tagName === "SELECT") {
            fields[key] = safeTrim(el.value);
            return;
          }

          fields[key] = safeTrim(el.value || "");
        });

        const multi = {};
        document.querySelectorAll("input[type='checkbox'][data-multi]").forEach((el) => {
          const key = el.getAttribute("data-multi");
          if (!key) return;
          if (!multi[key]) multi[key] = [];
          if (el.checked) multi[key].push(el.value);
        });
        Object.keys(multi).forEach((k) => (fields[k] = multi[k]));

        const fileEl = document.getElementById("input-transcript-files");
        if (fileEl && fileEl.files) {
          const meta = [];
          for (const f of fileEl.files) {
            meta.push({
              lastModified: f.lastModified || null,
              name: f.name || "",
              size: f.size || null,
              type: f.type || "",
            });
          }
          fields["Transcript_Files_Upload"] = meta;
        }

        return fields;
      }

      function buildPayload(mode) {
        const accountId = document.getElementById("input-account-id").value || "";
        const orderId = document.getElementById("input-order-id").value || "";
        const fields = collectFields();

        return {
          accountId,
          eventId: uuidv4(),
          formType: "staff_compliance_records",
          mode,
          orderId,
          submittedAt: new Date().toISOString(),
          ui: {
            page: window.location.pathname,
            userAgent: navigator.userAgent,
          },
          fields,
        };
      }

      function getEndpoints() {
        const primary = "https://api.taxmonitor.pro/forms/staff/compliance-records";
        const fallback = "https://api.taxmonitor.pro/forms/compliance-records";
        return { fallback, primary };
      }

      async function postJson(url, payload) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
        });

        const text = await res.text().catch(() => "");
        let json = null;
        try {
          json = text ? JSON.parse(text) : null;
        } catch {
          json = null;
        }

        return { json, ok: res.ok, status: res.status, text, url };
      }

      async function submitForm(mode) {
        const badge = document.getElementById("status-badge");
        const saveBtn = document.getElementById("save-draft-btn");
        const finalizeBtn = document.getElementById("finalize-btn");

        saveBtn.disabled = true;
        finalizeBtn.disabled = true;

        const payload = buildPayload(mode);
        const { primary, fallback } = getEndpoints();
        document.getElementById("debug-endpoint").textContent = primary;

        let result = await postJson(primary, payload);

        if (!result.ok) {
          document.getElementById("debug-endpoint").textContent = fallback;
          result = await postJson(fallback, payload);
        }

        if (!result.ok) {
          showToast(`Save failed (${result.status}). Check Worker logs.`);
          saveBtn.disabled = false;
          finalizeBtn.disabled = false;
          return;
        }

        lastSaveTime = Date.now();
        updateLastSaved();

        if (mode === "final") {
          badge.textContent = "FINAL";
          badge.classList.remove("bg-amber-500/20", "text-amber-400", "border-amber-500/30");
          badge.classList.add("bg-green-500/20", "text-green-400", "border-green-500/30");
          showToast("Record finalized");
        } else {
          badge.textContent = "DRAFT";
          badge.classList.remove("bg-green-500/20", "text-green-400", "border-green-500/30");
          badge.classList.add("bg-amber-500/20", "text-amber-400", "border-amber-500/30");
          showToast("Draft saved successfully");
        }

        saveBtn.disabled = false;
        finalizeBtn.disabled = false;
      }

      async function initializeApp() {
        if (window.elementSdk) {
          await window.elementSdk.init({
            defaultConfig,
            mapToCapabilities: (cfg) => ({
              borderables: [],
              fontEditable: {
                get: () => cfg.font_family || defaultConfig.font_family,
                set: (v) => {
                  cfg.font_family = v;
                  window.elementSdk.setConfig({ font_family: v });
                },
              },
              fontSizeable: {
                get: () => cfg.font_size || defaultConfig.font_size,
                set: (v) => {
                  cfg.font_size = v;
                  window.elementSdk.setConfig({ font_size: v });
                },
              },
              recolorables: [
                {
                  get: () => cfg.background_color || defaultConfig.background_color,
                  set: (v) => {
                    cfg.background_color = v;
                    window.elementSdk.setConfig({ background_color: v });
                  },
                },
                {
                  get: () => cfg.surface_color || defaultConfig.surface_color,
                  set: (v) => {
                    cfg.surface_color = v;
                    window.elementSdk.setConfig({ surface_color: v });
                  },
                },
                {
                  get: () => cfg.text_color || defaultConfig.text_color,
                  set: (v) => {
                    cfg.text_color = v;
                    window.elementSdk.setConfig({ text_color: v });
                  },
                },
                {
                  get: () => cfg.primary_action_color || defaultConfig.primary_action_color,
                  set: (v) => {
                    cfg.primary_action_color = v;
                    window.elementSdk.setConfig({ primary_action_color: v });
                  },
                },
                {
                  get: () => cfg.secondary_action_color || defaultConfig.secondary_action_color,
                  set: (v) => {
                    cfg.secondary_action_color = v;
                    window.elementSdk.setConfig({ secondary_action_color: v });
                  },
                },
              ],
            }),
            mapToEditPanelValues: (cfg) =>
              new Map([
                ["agent_name", cfg.agent_name || defaultConfig.agent_name],
                ["client_id", cfg.client_id || defaultConfig.client_id],
                ["client_name", cfg.client_name || defaultConfig.client_name],
              ]),
            onConfigChange: async (newConfig) => {
              config = { ...config, ...newConfig };
              applyConfig();
            },
          });
        }

        setIdentifiersFromUrl();
        setupEventListeners();
        applyConfig();
        updateLastSaved();
        setInterval(updateLastSaved, 30000);
      }

      function applyConfig() {
        const bgColor = config.background_color || defaultConfig.background_color;
        const surfaceColor = config.surface_color || defaultConfig.surface_color;
        const textColor = config.text_color || defaultConfig.text_color;
        const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;

        document.body.style.backgroundColor = bgColor;
        document.body.style.color = textColor;

        const fontFamily = config.font_family || defaultConfig.font_family;
        const baseSize = config.font_size || defaultConfig.font_size;
        document.body.style.fontFamily = `${fontFamily}, Inter, system-ui, sans-serif`;
        document.body.style.fontSize = `${baseSize}px`;

        const agentName = config.agent_name || defaultConfig.agent_name;
        const clientId = config.client_id || defaultConfig.client_id;
        const clientName = config.client_name || defaultConfig.client_name;

        document.getElementById("header-client-id").textContent = clientId;
        document.getElementById("header-client-name").textContent = clientName;

        document.getElementById("input-agent-name").value = agentName;
        document.getElementById("input-client-name").value = clientName;

        document.getElementById("report-agent-name").textContent = agentName;
        document.getElementById("report-client-id").textContent = clientId;
        document.getElementById("report-client-name").textContent = clientName;

        const finalizeBtn = document.getElementById("finalize-btn");
        finalizeBtn.style.backgroundColor = primaryColor;

        document.querySelectorAll(".accordion").forEach((el) => {
          el.style.backgroundColor = surfaceColor;
        });

        const total = document.querySelector('[data-field="Total_IRS_Balance"]');
        if (total) document.getElementById("report-total-balance").textContent = total.value || "—";

        const lien = document.querySelector('[data-field="IRS_Lien_Exposure_Level"]');
        if (lien) document.getElementById("report-lien").textContent = lien.value ? lien.value.split("—")[0].trim() : "—";
      }

      function setupEventListeners() {
        document.querySelectorAll(".accordion-header").forEach((header) => {
          header.addEventListener("click", () => {
            const accordionId = header.dataset.accordion;
            const content = document.getElementById(`accordion-${accordionId}`);
            const icon = header.querySelector(".accordion-icon");
            content.classList.toggle("open");
            icon.classList.toggle("rotate-180");
          });
        });

        document.getElementById("input-agent-name").addEventListener("input", (e) => {
          if (window.elementSdk) window.elementSdk.setConfig({ agent_name: e.target.value });
          else {
            config.agent_name = e.target.value;
            applyConfig();
          }
        });

        document.getElementById("input-client-name").addEventListener("input", (e) => {
          if (window.elementSdk) window.elementSdk.setConfig({ client_name: e.target.value });
          else {
            config.client_name = e.target.value;
            applyConfig();
          }
        });

        document.getElementById("save-draft-btn").addEventListener("click", async () => {
          await submitForm("draft");
        });

        document.getElementById("finalize-btn").addEventListener("click", async () => {
          await submitForm("final");
        });

        document.getElementById("print-btn").addEventListener("click", () => window.print());

        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.addEventListener("click", () => switchTab(btn.dataset.tab));
        });

        document.querySelectorAll(".year-tab").forEach((btn) => {
          btn.addEventListener("click", () => {
            document.querySelectorAll(".year-tab").forEach((t) => {
              t.classList.remove("bg-blue-600", "text-white");
              t.classList.add("text-slate-400");
            });
            btn.classList.add("bg-blue-600", "text-white");
            btn.classList.remove("text-slate-400");
            document.getElementById("compliance-year").textContent = btn.dataset.year;
          });
        });

        const total = document.querySelector('[data-field="Total_IRS_Balance"]');
        if (total) {
          total.addEventListener("input", () => {
            document.getElementById("report-total-balance").textContent = total.value || "—";
          });
        }

        const lien = document.querySelector('[data-field="IRS_Lien_Exposure_Level"]');
        if (lien) {
          lien.addEventListener("change", () => {
            document.getElementById("report-lien").textContent = lien.value ? lien.value.split("—")[0].trim() : "—";
          });
        }
      }

      function showToast(message) {
        const toast = document.createElement("div");
        toast.className =
          "fixed bottom-4 right-4 px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg shadow-lg text-sm text-slate-100 z-50 transform transition-all duration-300";
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => toast.remove(), 300);
        }, 2000);
      }

      function switchTab(tabId) {
        document.querySelectorAll(".tab-content").forEach((content) => content.classList.add("hidden"));
        document.querySelectorAll(".tab-btn").forEach((btn) => btn.classList.remove("tab-active"));
        document.getElementById(`tab-${tabId}`).classList.remove("hidden");
        document.querySelector(`[data-tab="${tabId}"]`).classList.add("tab-active");
      }

      function updateLastSaved() {
        const now = Date.now();
        const diff = Math.floor((now - lastSaveTime) / 1000);
        let text;

        if (diff < 60) text = "just now";
        else if (diff < 3600) text = `${Math.floor(diff / 60)} min ago`;
        else {
          const hours = Math.floor(diff / 3600);
          text = `${hours} hour${hours > 1 ? "s" : ""} ago`;
        }

        document.getElementById("last-saved").textContent = text;
      }

      // Update report date
      document.getElementById("report-date").textContent = new Date().toLocaleDateString("en-US", {
        day: "numeric",
        month: "long",
        year: "numeric",
      });

      // Currency formatting helpers
      function parseCurrency(value) {
        if (value === null || value === undefined) return 0;
        const cleaned = String(value).replace(/[^0-9.-]+/g, "");
        const n = parseFloat(cleaned);
        return Number.isFinite(n) ? n : 0;
      }

      function formatCurrency(value) {
        const number = typeof value === "number" ? value : parseCurrency(value);
        return number.toLocaleString("en-US", {
          currency: "USD",
          minimumFractionDigits: 2,
          style: "currency",
        });
      }

      function attachCurrencyFormatter(inputSelector, previewSelector) {
        const input = document.querySelector(inputSelector);
        const preview = previewSelector ? document.querySelector(previewSelector) : null;
        if (!input) return;

        const syncPreview = () => {
          if (preview) preview.textContent = input.value || "—";
        };

        input.value = formatCurrency(input.value);
        syncPreview();

        input.addEventListener("blur", () => {
          input.value = formatCurrency(input.value);
          syncPreview();
        });

        input.addEventListener("focus", () => {
          const raw = parseCurrency(input.value);
          input.value = raw ? String(raw) : "";
        });

        input.addEventListener("input", syncPreview);
      }

   document.addEventListener("DOMContentLoaded", () => {
    attachCurrencyFormatter('[data-field="IRS_Penalties"]', "#report-penalties");
    attachCurrencyFormatter('[data-field="IRS_Interest"]', "#report-interest");
    attachCurrencyFormatter('[data-field="Total_IRS_Balance"]', "#report-total-balance");
  });

      initializeApp();
    </script>
  </body>
</html>