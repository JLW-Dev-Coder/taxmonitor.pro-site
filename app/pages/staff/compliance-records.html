<!-- /app/pages/staff/compliance-records.html -->
<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tax Monitor Pro — Staff — Compliance Records</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="icon" href="https://taxmonitor.pro/favicon.ico" sizes="any">
  <link rel="icon" href="https://taxmonitor.pro/assets/favicon.ico" sizes="any">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['DM Sans', 'system-ui', 'sans-serif'] },
          colors: {
            slate: { 850:'#1a1f2e', 900:'#0f1219', 950:'#080a0f' },
            amber: { 400:'#fbbf24', 500:'#f59e0b', 600:'#d97706' }
          }
        }
      }
    };
  </script>

  <style>
    html, body { height: 100%; }
    *, *::before, *::after { box-sizing: border-box; }
    * { font-family: 'DM Sans', system-ui, sans-serif; }

    .gradient-text{
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .gradient-bg{
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
    }
    .card-glow{
      box-shadow: 0 0 40px rgba(251, 191, 36, 0.06), 0 0 90px rgba(251, 191, 36, 0.02);
    }
    .noise-bg::before{
      content:'';
      position:fixed; inset:0;
      opacity:.03;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      pointer-events:none;
      z-index:1;
    }
    .aurora-blob{ position:absolute; border-radius:50%; filter:blur(100px); opacity:.14; animation:float 20s ease-in-out infinite; }
    .aurora-1{ width:650px; height:420px; background:linear-gradient(135deg,#F59E0B,#D97706); top:8%; right:-12%; }
    .aurora-2{ width:520px; height:360px; background:linear-gradient(135deg,#2DD4BF,#14B8A6); top:42%; left:-16%; opacity:.08; animation-delay:-7s; }
    .aurora-3{ width:480px; height:320px; background:linear-gradient(135deg,#F59E0B,#EA580C); bottom:4%; right:18%; animation-delay:-14s; }
    @keyframes float{ 0%,100%{transform:translate(0,0) scale(1)} 33%{transform:translate(30px,-30px) scale(1.05)} 66%{transform:translate(-20px,20px) scale(.95)} }

    /* Print rules: no gimmicks, full report */
    @media print{
      .no-print{ display:none !important; }
      .print-expand{ display:block !important; }
      body{ background:#fff !important; color:#000 !important; }
      .card-glow{ box-shadow:none !important; }
      .print-surface{ border:1px solid #ddd !important; background:#fff !important; }
      a[href]:after{ content:""; }
    }
  </style>
</head>

<body class="h-full bg-[#020617] text-slate-200 noise-bg">
  <div class="aurora-blob aurora-1"></div>
  <div class="aurora-blob aurora-2"></div>
  <div class="aurora-blob aurora-3"></div>

  <div class="relative z-10 min-h-full">
    <header class="border-b border-slate-800/60 bg-slate-950/60 backdrop-blur">
      <div class="mx-auto max-w-7xl px-6 py-5 flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl gradient-bg text-slate-950 font-bold flex items-center justify-center">TM</div>
          <div class="leading-tight">
            <div class="font-semibold">Staff Console</div>
            <div class="text-sm text-slate-400">Compliance Records → contract v2 → report generator</div>
          </div>
        </div>
        <div class="no-print flex items-center gap-2">
          <button id="btnPrint" class="px-3 py-2 rounded-xl border border-slate-700/70 bg-slate-900/60 hover:bg-slate-900 transition text-sm">Print</button>
          <button id="btnDemo" class="px-3 py-2 rounded-xl border border-slate-700/70 bg-slate-900/60 hover:bg-slate-900 transition text-sm">Load demo</button>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-7xl px-6 py-8">
      <div class="grid lg:grid-cols-12 gap-6">
        <!-- Left: builder -->
        <section class="lg:col-span-5 bg-slate-900/60 rounded-2xl border border-slate-800/50 p-6 card-glow">
          <div class="flex items-start justify-between gap-3 mb-5">
            <div>
              <h1 class="text-xl font-semibold text-slate-100">Compliance builder</h1>
              <p class="text-sm text-slate-400 mt-1">Tabs + accordions for live-call capture. Outputs contract v2 record.</p>
            </div>
            <span id="statusPill" class="px-3 py-1 rounded-full bg-slate-800/70 border border-slate-700/60 text-xs text-slate-300">Idle</span>
          </div>

          <!-- Account loader -->
          <div class="space-y-3">
            <label class="text-xs text-slate-500 uppercase tracking-wider">Account JSON (paste existing accounts/{accountId}.json)</label>
            <textarea id="accountJson" rows="6"
              class="w-full rounded-xl bg-slate-950/40 border border-slate-700/60 px-4 py-3 text-sm text-slate-200 outline-none focus:ring-2 focus:ring-amber-500/30"
              placeholder='Paste accounts/{accountId}.json here (optional).'></textarea>

            <div class="grid sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-slate-500 uppercase tracking-wider">Account ID</label>
                <input id="accountId" class="mt-1 w-full rounded-xl bg-slate-950/40 border border-slate-700/60 px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-amber-500/30" placeholder="acct_..." />
              </div>
              <div>
                <label class="text-xs text-slate-500 uppercase tracking-wider">Event ID</label>
                <input id="eventId" class="mt-1 w-full rounded-xl bg-slate-950/40 border border-slate-700/60 px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-amber-500/30" placeholder="cmp_..." />
              </div>
            </div>
          </div>

          <!-- Tabs -->
          <div class="no-print mt-6">
            <div class="flex items-center justify-between gap-3">
              <div class="text-sm font-semibold text-slate-200">Call flow tabs</div>
              <div class="text-xs text-slate-500">Option B: tabs + accordions</div>
            </div>
            <div id="tabs" class="mt-3 flex flex-wrap gap-2"></div>
          </div>

          <!-- Tab content -->
          <div id="tabPanel" class="mt-4"></div>

          <!-- Actions -->
          <div class="no-print mt-6 grid sm:grid-cols-2 gap-3">
            <button id="btnGenerate" class="px-4 py-3 rounded-xl gradient-bg text-slate-950 font-semibold text-sm hover:opacity-90 transition">
              Generate + preview
            </button>
            <button id="btnCopy" class="px-4 py-3 rounded-xl border border-slate-700/70 bg-slate-950/20 text-sm hover:bg-slate-950/35 transition">
              Copy updated account JSON
            </button>
          </div>

          <div class="no-print mt-4">
            <label class="text-xs text-slate-500 uppercase tracking-wider">Updated accounts/{accountId}.json preview</label>
            <textarea id="outputJson" rows="9"
              class="mt-1 w-full rounded-xl bg-slate-950/40 border border-slate-700/60 px-4 py-3 text-xs text-slate-200 outline-none"></textarea>
          </div>

          <p class="mt-4 text-xs text-slate-500">
            This page generates the compliance object. Your Worker still: receipt → upsert R2 → ClickUp projection.
          </p>
        </section>

        <!-- Right: report -->
        <section class="lg:col-span-7 bg-slate-900/60 rounded-2xl border border-slate-800/50 p-6 card-glow print-surface">
          <div class="flex items-start justify-between gap-4 mb-5">
            <div>
              <h2 class="text-xl font-semibold text-slate-100">Report preview</h2>
              <p class="text-sm text-slate-400 mt-1">Interactive for taxpayers, print-ready for reality.</p>
            </div>
            <div class="no-print flex items-center gap-2">
              <button id="btnExpandAll" class="px-3 py-2 rounded-xl border border-slate-700/70 bg-slate-950/20 hover:bg-slate-950/35 transition text-sm">Expand</button>
              <button id="btnCollapseAll" class="px-3 py-2 rounded-xl border border-slate-700/70 bg-slate-950/20 hover:bg-slate-950/35 transition text-sm">Collapse</button>
            </div>
          </div>

          <!-- Header block -->
          <div class="rounded-2xl border border-slate-800/60 bg-slate-950/25 overflow-hidden">
            <div class="px-6 py-5 border-b border-slate-800/60 flex items-center justify-between gap-4">
              <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-xl gradient-bg text-slate-950 font-bold flex items-center justify-center">TM</div>
                <div>
                  <div class="font-semibold">Federal Tax Record Report</div>
                  <div id="reportSub" class="text-sm text-slate-400">Prepared for —</div>
                </div>
              </div>
              <span id="badgeStatus" class="px-3 py-1 rounded-full bg-slate-800/60 border border-slate-700/60 text-xs text-slate-200">Preview</span>
            </div>

            <!-- Big selling numbers -->
            <div class="p-6 grid sm:grid-cols-3 gap-4">
              <div class="rounded-2xl border border-slate-800/60 bg-slate-950/30 p-4">
                <div class="text-xs text-slate-500 uppercase tracking-wider">Estimated debt</div>
                <div id="metricDebt" class="mt-1 text-2xl font-semibold">—</div>
                <div class="text-xs text-slate-500 mt-2">Based on IRS records at review time.</div>
              </div>
              <div class="rounded-2xl border border-slate-800/60 bg-slate-950/30 p-4">
                <div class="text-xs text-slate-500 uppercase tracking-wider">Recommendation</div>
                <div id="metricRec" class="mt-1 text-2xl font-semibold">—</div>
                <div class="text-xs text-slate-500 mt-2">Judgment + documentation trail.</div>
              </div>
              <div class="rounded-2xl border border-slate-800/60 bg-slate-950/30 p-4">
                <div class="text-xs text-slate-500 uppercase tracking-wider">Lien exposure</div>
                <div id="metricLien" class="mt-1 text-2xl font-semibold">—</div>
                <div class="text-xs text-slate-500 mt-2">Signals urgency and escalation risk.</div>
              </div>
            </div>

            <!-- Year tabs -->
            <div class="px-6 pb-6">
              <div class="flex items-center justify-between gap-3 mb-3">
                <div class="text-sm font-semibold text-slate-200">Year view</div>
                <div class="text-xs text-slate-500">Tabs from balancesByYear</div>
              </div>
              <div id="yearTabs" class="flex flex-wrap gap-2"></div>

              <div id="yearPanel" class="mt-4 rounded-2xl border border-slate-800/60 bg-slate-950/25 p-5">
                <div class="text-sm text-slate-400">Select a year.</div>
              </div>
            </div>
          </div>

          <!-- Sections -->
          <div class="mt-6 space-y-3">
            <details class="section rounded-2xl border border-slate-800/60 bg-slate-950/20 p-5" open>
              <summary class="cursor-pointer list-none flex items-center justify-between gap-3">
                <span class="font-semibold">Account snapshot</span>
                <span class="text-xs text-slate-500">Core indicators</span>
              </summary>
              <div class="print-expand mt-4 grid sm:grid-cols-2 gap-3 text-sm">
                <div class="rounded-xl border border-slate-800/60 bg-slate-950/20 p-4">
                  <div class="text-xs text-slate-500 uppercase tracking-wider">Account status</div>
                  <div id="snapAccountStatus" class="mt-1 font-semibold">—</div>
                </div>
                <div class="rounded-xl border border-slate-800/60 bg-slate-950/20 p-4">
                  <div class="text-xs text-slate-500 uppercase tracking-wider">Total IRS balance</div>
                  <div id="snapTotalBalance" class="mt-1 font-semibold">—</div>
                </div>
                <div class="rounded-xl border border-slate-800/60 bg-slate-950/20 p-4">
                  <div class="text-xs text-slate-500 uppercase tracking-wider">Unfiled returns</div>
                  <div id="snapUnfiled" class="mt-1 font-semibold">—</div>
                </div>
                <div class="rounded-xl border border-slate-800/60 bg-slate-950/20 p-4">
                  <div class="text-xs text-slate-500 uppercase tracking-wider">Last return filed</div>
                  <div id="snapLastFiled" class="mt-1 font-semibold">—</div>
                </div>
              </div>
            </details>

            <details class="section rounded-2xl border border-slate-800/60 bg-slate-950/20 p-5">
              <summary class="cursor-pointer list-none flex items-center justify-between gap-3">
                <span class="font-semibold">What changed</span>
                <span class="text-xs text-slate-500">Latest vs previous</span>
              </summary>
              <div class="print-expand mt-4">
                <div id="diffPanel" class="rounded-xl border border-slate-800/60 bg-slate-950/20 p-4 text-sm text-slate-300">
                  Generate a record to see diffs.
                </div>
              </div>
            </details>

            <details class="section rounded-2xl border border-slate-800/60 bg-slate-950/20 p-5">
              <summary class="cursor-pointer list-none flex items-center justify-between gap-3">
                <span class="font-semibold">Internal notes</span>
                <span class="text-xs text-slate-500">Staff-only</span>
              </summary>
              <div class="print-expand mt-4">
                <div id="internalNotes" class="rounded-xl border border-slate-800/60 bg-slate-950/20 p-4 text-sm text-slate-300">—</div>
              </div>
            </details>

            <div class="text-xs text-slate-500 mt-2">
              Monitoring does not create IRS representation. Representation, filing, and resolution are separate engagements.
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // =========================
    // Contract + UI config
    // =========================
    const CONTRACT_DEMO_URL = "/app/contracts/tm_compliance_record.v2.example.json";

    const TABS = [
      { id: "overview", label: "Overview" },
      { id: "agent", label: "Agent" },
      { id: "authority", label: "Authority" },
      { id: "compliance", label: "Compliance" },
      { id: "notices", label: "Notices" },
      { id: "ia", label: "IA" },
      { id: "ro", label: "RO" },
      { id: "transcripts", label: "Transcripts" },
      { id: "summary", label: "Summary" },
    ];

    // Field keys from your contract sample (kept explicit, sorted)
    const FIELD_KEYS = [
      "Address_Line_1",
      "Address_Line_2",
      "City",
      "Company_Name",
      "Compliance_Activity_Type",
      "Compliance_Internal_Notes",
      "Compliance_Period_Covered",
      "Estimated_Balance_Due_Range",
      "IA_Details",
      "IA_Established",
      "IA_Last_Payment_Amount",
      "IA_Last_Payment_Date",
      "IA_Payment_Amount",
      "IA_Payment_Date",
      "IRS_Account_Status",
      "IRS_Agent_Department",
      "IRS_Agent_Department_Phone",
      "IRS_Agent_ID",
      "IRS_Agent_Name",
      "IRS_Agent_Verification",
      "IRS_Balance_By_Year_Status",
      "IRS_Call_Confirmation_Date",
      "IRS_Compliance_Section_Focus",
      "IRS_Lien_Exposure_Level",
      "IRS_Missing_Years",
      "IRS_Notice_Date",
      "IRS_Notice_Received",
      "IRS_Notice_Type",
      "IRS_Revenue_Officer_Fax",
      "IRS_Revenue_Officer_Name",
      "IRS_Revenue_Officer_Notes",
      "IRS_Revenue_Officer_Phone",
      "IRS_Status_Categories",
      "Identity_Verification_Hold",
      "Last_Return_Filed_Year",
      "Primary_Recommended_Service",
      "Resolution_Readiness_Status",
      "Spouse_Separate_2848_Required",
      "Spouse_Separate_2848_Required_Years",
      "Spouse_Separate_Wet_Sig_2848_Required",
      "State_Province",
      "Tax_Monitoring_Service_Progress_Percent",
      "Tax_Monitoring_Service_Progress_Status",
      "Taxpayer_Separate_Wet_Sig_2848_Required",
      "Total_IRS_Balance",
      "Transcript_Delivery_Method",
      "Transcript_Files_Upload",
      "Transcript_Request_Made",
      "Transcript_Retrieval_Date",
      "Transcript_Retrieval_Notes",
      "Transcript_Scope_Confirmed",
      "Transcripts_Retrieved_From_SOR",
      "Unfiled_Returns_Indicator",
      "Wet_Sig_2848_Accepted_Status",
      "Wet_Sig_2848_Notes",
      "Wet_Sig_2848_Rejected_Notes",
      "Wet_Sig_2848_Rejected_Type",
      "ZIP_Postal_Code",
    ].sort((a,b)=>a.localeCompare(b));

    // =========================
    // DOM helpers
    // =========================
    const $ = (id) => document.getElementById(id);

    function setPill(text, tone) {
      const el = $("statusPill");
      el.textContent = text;
      el.className = "px-3 py-1 rounded-full border text-xs";
      const map = {
        good: "bg-emerald-500/10 border-emerald-500/20 text-emerald-300",
        idle: "bg-slate-800/70 border-slate-700/60 text-slate-300",
        warn: "bg-amber-500/10 border-amber-500/20 text-amber-300",
      };
      el.classList.add(...(map[tone] || map.idle).split(" "));
    }

    function nowIso() {
      return new Date().toISOString();
    }

    function newEventId(prefix="cmp") {
      const r = Math.random().toString(16).slice(2, 10);
      const stamp = new Date().toISOString().replace(/[-:]/g, "").slice(0, 15) + "Z";
      return `${prefix}_${stamp}_${r}`;
    }

    function safeJsonParse(s) {
      try { return JSON.parse(String(s || "").trim()); } catch { return null; }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function fmtUsdCents(cents) {
      const n = Number(cents);
      if (!Number.isFinite(n)) return "—";
      return (n/100).toLocaleString(undefined, { style:"currency", currency:"USD", maximumFractionDigits:0 });
    }

    // =========================
    // Tabs + accordions renderer
    // =========================
    function inputBase() {
      return "mt-1 w-full rounded-xl bg-slate-950/40 border border-slate-700/60 px-4 py-3 text-sm text-slate-200 outline-none focus:ring-2 focus:ring-amber-500/30";
    }

    function renderTabs(activeId) {
      const host = $("tabs");
      host.innerHTML = "";
      for (const t of TABS) {
        const btn = document.createElement("button");
        const active = t.id === activeId;
        btn.className = [
          "px-3 py-2 rounded-xl border text-sm transition",
          active
            ? "border-amber-500/30 bg-amber-500/10 text-amber-200"
            : "border-slate-700/70 bg-slate-950/20 text-slate-200 hover:bg-slate-950/35"
        ].join(" ");
        btn.textContent = t.label;
        btn.addEventListener("click", () => {
          window.__TM_ACTIVE_TAB = t.id;
          renderTabs(t.id);
          renderTabPanel(t.id);
        });
        host.appendChild(btn);
      }
    }

    function fieldRow({ id, label, placeholder="", type="text", note="" }) {
      const isTextarea = type === "textarea";
      return `
        <div>
          <label class="text-xs text-slate-500 uppercase tracking-wider">${escapeHtml(label)}</label>
          ${
            isTextarea
              ? `<textarea id="${escapeHtml(id)}" rows="3" class="${inputBase()}" placeholder="${escapeHtml(placeholder)}"></textarea>`
              : `<input id="${escapeHtml(id)}" type="${escapeHtml(type)}" class="${inputBase()}" placeholder="${escapeHtml(placeholder)}" />`
          }
          ${note ? `<div class="text-xs text-slate-500 mt-2">${note}</div>` : ``}
        </div>
      `;
    }

    function accordion(title, subtitle, innerHtml, open=false) {
      return `
        <details class="section rounded-2xl border border-slate-800/60 bg-slate-950/20 p-5" ${open ? "open" : ""}>
          <summary class="cursor-pointer list-none flex items-center justify-between gap-3">
            <span class="font-semibold">${escapeHtml(title)}</span>
            <span class="text-xs text-slate-500">${escapeHtml(subtitle || "")}</span>
          </summary>
          <div class="mt-4 grid sm:grid-cols-2 gap-4">
            ${innerHtml}
          </div>
        </details>
      `;
    }

    function renderTabPanel(tabId) {
      const host = $("tabPanel");
      const t = String(tabId || "overview");

      // NOTE: Field ids are contract field keys where possible.
      // For nested objects, we use dedicated ids.
      const panels = {
        overview: () => {
          const a = accordion(
            "Client + engagement",
            "High-signal basics",
            [
              fieldRow({ id:"Company_Name", label:"Company_Name", placeholder:"John & Jane Doe LLC" }),
              fieldRow({ id:"Compliance_Period_Covered", label:"Compliance_Period_Covered", placeholder:"2016–2026" }),
              fieldRow({ id:"Estimated_Balance_Due_Range", label:"Estimated_Balance_Due_Range", placeholder:"$0" }),
              fieldRow({ id:"Primary_Recommended_Service", label:"Primary_Recommended_Service", placeholder:"Tax Monitoring Ongoing" }),
            ].join(""),
            true
          );

          const b = accordion(
            "Status indicators",
            "Snapshot fields",
            [
              fieldRow({ id:"IRS_Account_Status", label:"IRS_Account_Status", placeholder:"Active" }),
              fieldRow({ id:"Total_IRS_Balance", label:"Total_IRS_Balance", placeholder:"0" }),
              fieldRow({ id:"IRS_Lien_Exposure_Level", label:"IRS_Lien_Exposure_Level", placeholder:"Low / Medium / High" }),
              fieldRow({ id:"Unfiled_Returns_Indicator", label:"Unfiled_Returns_Indicator", placeholder:"No" }),
              fieldRow({ id:"Last_Return_Filed_Year", label:"Last_Return_Filed_Year", placeholder:"2025" }),
              fieldRow({ id:"IRS_Status_Categories", label:"IRS_Status_Categories", placeholder:'["None identified"]', note:"JSON array is allowed." }),
            ].join(""),
            false
          );

          return `${a}<div class="mt-3"></div>${b}`;
        },

        agent: () => {
          const a = accordion(
            "IRS agent",
            "Capture first",
            [
              fieldRow({ id:"IRS_Agent_Name", label:"IRS_Agent_Name", placeholder:"Agent Name" }),
              fieldRow({ id:"IRS_Agent_ID", label:"IRS_Agent_ID", placeholder:"A12345" }),
              fieldRow({ id:"IRS_Agent_Department", label:"IRS_Agent_Department", placeholder:"PPS" }),
              fieldRow({ id:"IRS_Agent_Department_Phone", label:"IRS_Agent_Department_Phone", placeholder:"800-xxx-xxxx" }),
              fieldRow({ id:"IRS_Agent_Verification", label:"IRS_Agent_Verification", placeholder:"true / false" }),
              fieldRow({ id:"IRS_Call_Confirmation_Date", label:"IRS_Call_Confirmation_Date", placeholder:"YYYY-MM-DD" }),
            ].join(""),
            true
          );
          return a;
        },

        authority: () => {
          const a = accordion(
            "Identity + gating",
            "Holds and authority state",
            [
              fieldRow({ id:"Identity_Verification_Hold", label:"Identity_Verification_Hold", placeholder:"", note:"Blank if none." }),
              fieldRow({ id:"Spouse_Separate_2848_Required", label:"Spouse_Separate_2848_Required", placeholder:"" }),
              fieldRow({ id:"Spouse_Separate_2848_Required_Years", label:"Spouse_Separate_2848_Required_Years", placeholder:"" }),
              fieldRow({ id:"Spouse_Separate_Wet_Sig_2848_Required", label:"Spouse_Separate_Wet_Sig_2848_Required", placeholder:"" }),
              fieldRow({ id:"Taxpayer_Separate_Wet_Sig_2848_Required", label:"Taxpayer_Separate_Wet_Sig_2848_Required", placeholder:"" }),
              fieldRow({ id:"Wet_Sig_2848_Accepted_Status", label:"Wet_Sig_2848_Accepted_Status", placeholder:"" }),
              fieldRow({ id:"Wet_Sig_2848_Rejected_Type", label:"Wet_Sig_2848_Rejected_Type", placeholder:"" }),
              fieldRow({ id:"Wet_Sig_2848_Rejected_Notes", label:"Wet_Sig_2848_Rejected_Notes", placeholder:"", type:"textarea" }),
              fieldRow({ id:"Wet_Sig_2848_Notes", label:"Wet_Sig_2848_Notes", placeholder:"", type:"textarea" }),
            ].join(""),
            true
          );
          return a;
        },

        compliance: () => {
          const a = accordion(
            "Compliance core",
            "Section focus + activity",
            [
              fieldRow({ id:"Compliance_Activity_Type", label:"Compliance_Activity_Type", placeholder:"Initial review" }),
              fieldRow({ id:"IRS_Compliance_Section_Focus", label:"IRS_Compliance_Section_Focus", placeholder:"Compliance core" }),
              fieldRow({ id:"IRS_Missing_Years", label:"IRS_Missing_Years", placeholder:"None" }),
              fieldRow({ id:"IRS_Balance_By_Year_Status", label:"IRS_Balance_By_Year_Status", type:"textarea", placeholder:'Paste JSON balancesByYear object OR shorthand like:\n2024: $0 | 2025: $0 | 2026: $12,500', note:"This is used to generate balancesByYear year tabs in preview. For contract v2, we also store balancesByYear as a structured object." }),
            ].join(""),
            true
          );

          const b = accordion(
            "Taxpayer address",
            "Used in report header",
            [
              fieldRow({ id:"Address_Line_1", label:"Address_Line_1", placeholder:"123 Main St" }),
              fieldRow({ id:"Address_Line_2", label:"Address_Line_2", placeholder:"" }),
              fieldRow({ id:"City", label:"City", placeholder:"San Diego" }),
              fieldRow({ id:"State_Province", label:"State_Province", placeholder:"CA" }),
              fieldRow({ id:"ZIP_Postal_Code", label:"ZIP_Postal_Code", placeholder:"92101" }),
            ].join(""),
            false
          );

          return `${a}<div class="mt-3"></div>${b}`;
        },

        notices: () => {
          const a = accordion(
            "Notices",
            "Most recent notice fields",
            [
              fieldRow({ id:"IRS_Notice_Received", label:"IRS_Notice_Received", placeholder:"No" }),
              fieldRow({ id:"IRS_Notice_Type", label:"IRS_Notice_Type", placeholder:"", }),
              fieldRow({ id:"IRS_Notice_Date", label:"IRS_Notice_Date", placeholder:"YYYY-MM-DD", }),
            ].join(""),
            true
          );
          return a;
        },

        ia: () => {
          const a = accordion(
            "Installment agreement",
            "Capture only if relevant",
            [
              fieldRow({ id:"IA_Established", label:"IA_Established", placeholder:"" }),
              fieldRow({ id:"IA_Details", label:"IA_Details", placeholder:"", type:"textarea" }),
              fieldRow({ id:"IA_Payment_Date", label:"IA_Payment_Date", placeholder:"YYYY-MM-DD" }),
              fieldRow({ id:"IA_Payment_Amount", label:"IA_Payment_Amount", placeholder:"12500" }),
              fieldRow({ id:"IA_Last_Payment_Date", label:"IA_Last_Payment_Date", placeholder:"YYYY-MM-DD" }),
              fieldRow({ id:"IA_Last_Payment_Amount", label:"IA_Last_Payment_Amount", placeholder:"12500" }),
            ].join(""),
            true
          );
          return a;
        },

        ro: () => {
          const a = accordion(
            "Revenue officer",
            "Only if assigned",
            [
              fieldRow({ id:"IRS_Revenue_Officer_Name", label:"IRS_Revenue_Officer_Name", placeholder:"" }),
              fieldRow({ id:"IRS_Revenue_Officer_Phone", label:"IRS_Revenue_Officer_Phone", placeholder:"" }),
              fieldRow({ id:"IRS_Revenue_Officer_Fax", label:"IRS_Revenue_Officer_Fax", placeholder:"" }),
              fieldRow({ id:"IRS_Revenue_Officer_Notes", label:"IRS_Revenue_Officer_Notes", placeholder:"", type:"textarea" }),
            ].join(""),
            true
          );
          return a;
        },

        transcripts: () => {
          const a = accordion(
            "Transcript handling",
            "Request + retrieval",
            [
              fieldRow({ id:"Transcript_Request_Made", label:"Transcript_Request_Made", placeholder:"true / false" }),
              fieldRow({ id:"Transcript_Scope_Confirmed", label:"Transcript_Scope_Confirmed", placeholder:"Full 10-year" }),
              fieldRow({ id:"Transcript_Delivery_Method", label:"Transcript_Delivery_Method", placeholder:"SOR mailbox" }),
              fieldRow({ id:"Transcripts_Retrieved_From_SOR", label:"Transcripts_Retrieved_From_SOR", placeholder:"" }),
              fieldRow({ id:"Transcript_Retrieval_Date", label:"Transcript_Retrieval_Date", placeholder:"YYYY-MM-DD" }),
              fieldRow({ id:"Transcript_Retrieval_Notes", label:"Transcript_Retrieval_Notes", placeholder:"", type:"textarea" }),
              fieldRow({ id:"Transcript_Files_Upload", label:"Transcript_Files_Upload", placeholder:"[]", note:"JSON array is allowed." }),
            ].join(""),
            true
          );
          return a;
        },

        summary: () => {
          const a = accordion(
            "Recommendation",
            "Service + readiness",
            [
              fieldRow({ id:"Primary_Recommended_Service", label:"Primary_Recommended_Service", placeholder:"Tax Monitoring Ongoing" }),
              fieldRow({ id:"Resolution_Readiness_Status", label:"Resolution_Readiness_Status", placeholder:"Not applicable" }),
              fieldRow({ id:"Tax_Monitoring_Service_Progress_Percent", label:"Tax_Monitoring_Service_Progress_Percent", placeholder:"100" }),
              fieldRow({ id:"Tax_Monitoring_Service_Progress_Status", label:"Tax_Monitoring_Service_Progress_Status", placeholder:"Monitoring records have been updated. Your report will be prepared.", type:"textarea" }),
            ].join(""),
            true
          );

          const b = accordion(
            "Internal notes",
            "Staff-only",
            [
              fieldRow({ id:"Compliance_Internal_Notes", label:"Compliance_Internal_Notes", placeholder:"High-signal notes only.", type:"textarea" }),
            ].join(""),
            true
          );

          return `${a}<div class="mt-3"></div>${b}`;
        },
      };

      host.innerHTML = (panels[t] ? panels[t]() : panels.overview());
    }

    // =========================
    // balancesByYear parsing
    // =========================
    function currencyToCents(value) {
      const s = String(value ?? "").replace(/[^0-9.-]/g, "");
      const n = Number(s);
      if (!Number.isFinite(n)) return null;
      return Math.round(n * 100);
    }

    // Supports:
    // 1) JSON object: {"2026":{"balanceCents":1250000,"collectionStatus":"None identified"...}}
    // 2) Shorthand: "2024: $0 | 2025: $0 | 2026: $12,500"
    function parseBalancesByYear(raw) {
      const s = String(raw || "").trim();
      if (!s) return {};

      const asJson = safeJsonParse(s);
      if (asJson && typeof asJson === "object" && !Array.isArray(asJson)) {
        return normalizeBalancesByYear(asJson);
      }

      const out = {};
      const parts = s.split("|").map(x => x.trim()).filter(Boolean);
      for (const part of parts) {
        const m = part.match(/(\d{4})\s*:\s*(.+)$/);
        if (!m) continue;
        const year = m[1];
        const cents = currencyToCents(m[2]);
        out[year] = {
          balanceCents: cents,
          collectionStatus: cents === 0 ? "None identified" : "Balance due",
          csedDate: null,
          filed: null,
          filingStatus: null,
          hasLien: null,
          isMissingOrUnfiled: null,
          notes: ""
        };
      }
      return normalizeBalancesByYear(out);
    }

    function normalizeBalancesByYear(obj) {
      const out = {};
      for (const [year, v] of Object.entries(obj || {})) {
        const y = String(year).trim();
        if (!/^\d{4}$/.test(y)) continue;
        const row = (v && typeof v === "object") ? v : {};
        out[y] = {
          balanceCents: (row.balanceCents === null || row.balanceCents === undefined) ? null : Number(row.balanceCents),
          collectionStatus: row.collectionStatus ?? null,
          csedDate: row.csedDate ?? null,
          filed: row.filed ?? null,
          filingStatus: row.filingStatus ?? null,
          hasLien: row.hasLien ?? null,
          isMissingOrUnfiled: row.isMissingOrUnfiled ?? null,
          notes: row.notes ?? ""
        };
      }
      return out;
    }

    function yearsFromBalances(balancesByYear) {
      return Object.keys(balancesByYear || {})
        .filter(y => /^\d{4}$/.test(String(y)))
        .sort((a, b) => Number(b) - Number(a));
    }

    function bestYear(years) {
      for (const y of years) if (Number(y) >= 2024) return y;
      return years[0] || null;
    }

    // =========================
    // Diff engine (fields + balances)
    // =========================
    function diffObjects(prev, next) {
      const keys = Array.from(new Set([ ...Object.keys(prev || {}), ...Object.keys(next || {}) ])).sort((a,b)=>a.localeCompare(b));
      const changes = [];
      for (const k of keys) {
        const a = prev?.[k];
        const b = next?.[k];
        const same = JSON.stringify(a ?? null) === JSON.stringify(b ?? null);
        if (same) continue;
        changes.push({ key: k, from: a ?? null, to: b ?? null });
      }
      return changes;
    }

    function renderDiff(changes) {
      if (!changes.length) return `<div class="text-sm text-slate-300">No differences detected. Either it truly didn’t change, or the IRS is being unusually cooperative.</div>`;
      const rows = changes.map(c => {
        const from = escapeHtml(String(c.from ?? "—"));
        const to = escapeHtml(String(c.to ?? "—"));
        return `
          <div class="rounded-xl border border-slate-800/60 bg-slate-950/20 p-3">
            <div class="text-xs text-slate-500 uppercase tracking-wider">${escapeHtml(c.key)}</div>
            <div class="mt-2 text-sm text-slate-300"><span class="text-slate-500">From:</span> ${from}</div>
            <div class="mt-1 text-sm text-slate-300"><span class="text-slate-500">To:</span> ${to}</div>
          </div>
        `;
      }).join("");
      return `<div class="grid sm:grid-cols-2 gap-3">${rows}</div>`;
    }

    // =========================
    // Report render (contract v2)
    // =========================
    function renderYearTabs(years, activeYear) {
      const host = $("yearTabs");
      host.innerHTML = "";
      for (const y of years) {
        const btn = document.createElement("button");
        const active = String(y) === String(activeYear);
        btn.className = [
          "px-3 py-2 rounded-xl border text-sm transition",
          active
            ? "border-amber-500/30 bg-amber-500/10 text-amber-200"
            : "border-slate-700/70 bg-slate-950/20 text-slate-200 hover:bg-slate-950/35"
        ].join(" ");
        btn.textContent = y;
        btn.addEventListener("click", () => {
          window.__TM_ACTIVE_YEAR = y;
          renderYearPanel(window.__TM_BALANCES_BY_YEAR || {}, y);
          renderYearTabs(years, y);
        });
        host.appendChild(btn);
      }
    }

    function renderYearPanel(balancesByYear, activeYear) {
      const panel = $("yearPanel");
      const y = String(activeYear || "");
      const row = balancesByYear?.[y];
      if (!row) {
        panel.innerHTML = `<div class="text-sm text-slate-400">No data for ${escapeHtml(y)}.</div>`;
        return;
      }

      const balance = row.balanceCents === null ? "—" : fmtUsdCents(row.balanceCents);
      const status = row.collectionStatus ?? "—";
      const filed = (row.filed === null || row.filed === undefined) ? "—" : (row.filed ? "Yes" : "No");
      const lien = (row.hasLien === null || row.hasLien === undefined) ? "—" : (row.hasLien ? "Yes" : "No");

      panel.innerHTML = `
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xs text-slate-500 uppercase tracking-wider">Year</div>
            <div class="mt-1 text-xl font-semibold">${escapeHtml(y)}</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-500 uppercase tracking-wider">Balance</div>
            <div class="mt-1 text-xl font-semibold">${escapeHtml(balance)}</div>
          </div>
        </div>
        <div class="mt-4 grid sm:grid-cols-3 gap-3">
          <div class="rounded-xl border border-slate-800/60 bg-slate-950/20 p-4">
            <div class="text-xs text-slate-500 uppercase tracking-wider">Collection status</div>
            <div class="mt-1 text-sm text-slate-200">${escapeHtml(status)}</div>
          </div>
          <div class="rounded-xl border border-slate-800/60 bg-slate-950/20 p-4">
            <div class="text-xs text-slate-500 uppercase tracking-wider">Filed</div>
            <div class="mt-1 text-sm text-slate-200">${escapeHtml(filed)}</div>
          </div>
          <div class="rounded-xl border border-slate-800/60 bg-slate-950/20 p-4">
            <div class="text-xs text-slate-500 uppercase tracking-wider">Lien</div>
            <div class="mt-1 text-sm text-slate-200">${escapeHtml(lien)}</div>
          </div>
        </div>
        ${row.notes ? `<div class="mt-3 text-sm text-slate-400">${escapeHtml(row.notes)}</div>` : ``}
      `;
    }

    function renderReport(record, previous) {
      const fields = record?.fields || {};
      const balancesByYear = record?.balancesByYear || {};

      $("reportSub").textContent = fields.Company_Name ? `Prepared for ${fields.Company_Name}` : "Prepared for —";
      $("metricDebt").textContent = fields.Estimated_Balance_Due_Range || "—";
      $("metricRec").textContent = fields.Primary_Recommended_Service || "—";
      $("metricLien").textContent = fields.IRS_Lien_Exposure_Level || "—";

      $("snapAccountStatus").textContent = fields.IRS_Account_Status || "—";
      $("snapLastFiled").textContent = fields.Last_Return_Filed_Year || "—";
      $("snapTotalBalance").textContent = fields.Total_IRS_Balance ?? "—";
      $("snapUnfiled").textContent = fields.Unfiled_Returns_Indicator || "—";

      $("internalNotes").textContent = fields.Compliance_Internal_Notes || "—";

      const years = yearsFromBalances(balancesByYear);
      window.__TM_BALANCES_BY_YEAR = balancesByYear;

      const active = window.__TM_ACTIVE_YEAR && years.includes(String(window.__TM_ACTIVE_YEAR))
        ? String(window.__TM_ACTIVE_YEAR)
        : bestYear(years);

      window.__TM_ACTIVE_YEAR = active;

      renderYearTabs(years, active);
      if (active) renderYearPanel(balancesByYear, active);

      const badge = $("badgeStatus");
      const lien = String(fields.IRS_Lien_Exposure_Level || "").toLowerCase();
      badge.className = "px-3 py-1 rounded-full text-xs border";
      if (lien.includes("high")) badge.classList.add("bg-red-500/10","border-red-500/20","text-red-300");
      else if (lien.includes("med")) badge.classList.add("bg-amber-500/10","border-amber-500/20","text-amber-300");
      else badge.classList.add("bg-emerald-500/10","border-emerald-500/20","text-emerald-300");
      badge.textContent = "Prepared";

      if (!previous) {
        $("diffPanel").innerHTML = `<div class="text-sm text-slate-300">No previous compliance record found. Create a second record and you’ll get a proper diff.</div>`;
        return;
      }

      const changesA = diffObjects(previous.fields || {}, fields);
      const changesB = diffObjects(previous.balancesByYear || {}, balancesByYear);
      const combined = [
        ...changesA.map(x => ({...x, key: `fields.${x.key}`})),
        ...changesB.map(x => ({...x, key: `balancesByYear.${x.key}`}))
      ].sort((a,b)=>a.key.localeCompare(b.key));

      $("diffPanel").innerHTML = renderDiff(combined);
    }

    // =========================
    // Contract v2 account updater
    // =========================
    function ensureAccountShape(account, accountId) {
      const out = account && typeof account === "object" ? account : {};
      if (!out.accountId) out.accountId = accountId || out.accountId || "";

      if (!out.compliance) out.compliance = {};
      if (!Array.isArray(out.compliance.records)) out.compliance.records = [];

      return out;
    }

    function parseMaybeJsonValue(key, raw) {
      const s = String(raw ?? "").trim();
      if (!s) return null;

      // Allow JSON arrays/objects for certain fields
      if (key === "IRS_Status_Categories" || key === "Transcript_Files_Upload") {
        const v = safeJsonParse(s);
        if (v !== null) return v;
      }

      if (key === "IRS_Agent_Verification" || key === "Transcript_Request_Made") {
        if (s.toLowerCase() === "true") return true;
        if (s.toLowerCase() === "false") return false;
      }

      if (key === "Tax_Monitoring_Service_Progress_Percent") {
        const n = Number(s);
        return Number.isFinite(n) ? n : null;
      }

      // Keep strings by default
      return s;
    }

    function buildFieldsFromForm() {
      const fields = {};
      for (const key of FIELD_KEYS) {
        const el = $(key);
        if (!el) { fields[key] = null; continue; }
        fields[key] = parseMaybeJsonValue(key, el.value);
      }
      return fields;
    }

    function buildRecordFromForm(eventId, fields) {
      const balancesByYear = parseBalancesByYear(fields.IRS_Balance_By_Year_Status || "");
      const record = {
        schema: { name: "tm_compliance_record", version: 2 },
        createdAt: nowIso(),
        eventId,

        balancesByYear,

        call: {
          activityType: fields.Compliance_Activity_Type || null,
          periodCovered: fields.Compliance_Period_Covered || null,
          sectionFocus: fields.IRS_Compliance_Section_Focus || null,
          callConfirmedDate: fields.IRS_Call_Confirmation_Date || null,
          agent: {
            name: fields.IRS_Agent_Name || null,
            id: fields.IRS_Agent_ID || null,
            department: fields.IRS_Agent_Department || null,
            departmentPhone: fields.IRS_Agent_Department_Phone || null,
            verified: fields.IRS_Agent_Verification ?? null,
          }
        },

        taxpayer: {
          companyName: fields.Company_Name || null,
          lastReturnFiledYear: fields.Last_Return_Filed_Year || null,
          address: {
            line1: fields.Address_Line_1 || null,
            line2: fields.Address_Line_2 || null,
            city: fields.City || null,
            stateProvince: fields.State_Province || null,
            zipPostalCode: fields.ZIP_Postal_Code || null,
          }
        },

        irs: {
          accountStatus: fields.IRS_Account_Status || null,
          estimatedBalanceDueRange: fields.Estimated_Balance_Due_Range || null,
          totalBalanceCents: null,
          statusCategories: Array.isArray(fields.IRS_Status_Categories) ? fields.IRS_Status_Categories : (fields.IRS_Status_Categories ? [fields.IRS_Status_Categories] : []),
          missingYearsSummary: fields.IRS_Missing_Years || null,
          unfiledReturnsIndicator: fields.Unfiled_Returns_Indicator || null,
          lienExposureLevel: fields.IRS_Lien_Exposure_Level || null,
          notices: {
            mostRecent: {
              received: fields.IRS_Notice_Received || null,
              type: fields.IRS_Notice_Type ?? null,
              date: fields.IRS_Notice_Date ?? null,
            }
          },
          balanceByYearLegacyText: fields.IRS_Balance_By_Year_Status || ""
        },

        transcripts: {
          requestMade: fields.Transcript_Request_Made ?? null,
          scopeConfirmed: fields.Transcript_Scope_Confirmed || null,
          deliveryMethod: fields.Transcript_Delivery_Method || null,
          files: Array.isArray(fields.Transcript_Files_Upload) ? fields.Transcript_Files_Upload : [],
          retrieval: {
            retrievedFromSOR: fields.Transcripts_Retrieved_From_SOR || "",
            retrievalDate: fields.Transcript_Retrieval_Date ?? null,
            notes: fields.Transcript_Retrieval_Notes || ""
          }
        },

        workflows: {
          identityVerificationHold: fields.Identity_Verification_Hold || "",
          installmentAgreement: {
            established: fields.IA_Established || "",
            details: fields.IA_Details || "",
            paymentDate: fields.IA_Payment_Date ?? null,
            paymentAmountCents: fields.IA_Payment_Amount ? Number(fields.IA_Payment_Amount) : null,
            lastPaymentDate: fields.IA_Last_Payment_Date ?? null,
            lastPaymentAmountCents: fields.IA_Last_Payment_Amount ? Number(fields.IA_Last_Payment_Amount) : null,
          },
          revenueOfficer: {
            name: fields.IRS_Revenue_Officer_Name || "",
            phone: fields.IRS_Revenue_Officer_Phone || "",
            fax: fields.IRS_Revenue_Officer_Fax || "",
            notes: fields.IRS_Revenue_Officer_Notes || "",
          }
        },

        wetSig2848: {
          spouseSeparateRequired: fields.Spouse_Separate_2848_Required || "",
          spouseSeparateRequiredYears: fields.Spouse_Separate_2848_Required_Years || "",
          taxpayerWetSigRequired: fields.Taxpayer_Separate_Wet_Sig_2848_Required || "",
          spouseWetSigRequired: fields.Spouse_Separate_Wet_Sig_2848_Required || "",
          acceptedStatus: fields.Wet_Sig_2848_Accepted_Status || "",
          rejectedType: fields.Wet_Sig_2848_Rejected_Type || "",
          rejectedNotes: fields.Wet_Sig_2848_Rejected_Notes || "",
          notes: fields.Wet_Sig_2848_Notes || "",
        },

        recommendation: {
          primaryService: fields.Primary_Recommended_Service || null,
          resolutionReadinessStatus: fields.Resolution_Readiness_Status || null,
          why: ""
        },

        internal: {
          notes: fields.Compliance_Internal_Notes || "",
          progressPercent: fields.Tax_Monitoring_Service_Progress_Percent ?? null,
          progressStatus: fields.Tax_Monitoring_Service_Progress_Status || ""
        },

        fields
      };

      return record;
    }

    function appendComplianceRecord(account, record) {
      const records = Array.isArray(account.compliance.records) ? account.compliance.records : [];
      const prev = records.length ? records[records.length - 1] : null;

      records.push(record);
      account.compliance.records = records;
      account.compliance.latestEventId = record.eventId;

      return { previous: prev, record };
    }

    // =========================
    // Init / actions
    // =========================
    function expandCollapse(open) {
      document.querySelectorAll("details.section").forEach(d => d.open = !!open);
    }

    function loadFromInjectedOrTextarea() {
      const injected = window.TM_ACCOUNT && typeof window.TM_ACCOUNT === "object" ? window.TM_ACCOUNT : null;
      if (injected) return injected;

      const parsed = safeJsonParse($("accountJson").value);
      if (parsed && typeof parsed === "object") return parsed;

      return null;
    }

    function setFormFromRecord(record) {
      const f = record?.fields || {};
      for (const key of FIELD_KEYS) {
        const el = $(key);
        if (!el) continue;
        const v = f[key];
        el.value = (v === null || v === undefined) ? "" : (typeof v === "string" ? v : JSON.stringify(v));
      }
    }

    async function setDemo() {
      try {
        const res = await fetch(CONTRACT_DEMO_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`demo fetch ${res.status}`);
        const demoAccount = await res.json();

        const accountId = demoAccount.accountId || "acct_demo";
        const eventId = demoAccount.compliance?.latestEventId || newEventId("cmp");

        $("accountId").value = accountId;
        $("eventId").value = eventId;

        // Use latest record in demo if present
        const recs = demoAccount.compliance?.records || [];
        const latest = recs.length ? recs[recs.length - 1] : null;

        // Seed the left textarea with an account-shaped object (so user can generate diff on next run)
        $("accountJson").value = JSON.stringify(demoAccount, null, 2);

        // Ensure tabs UI exists before setting fields
        const activeTab = window.__TM_ACTIVE_TAB || "overview";
        renderTabs(activeTab);
        renderTabPanel(activeTab);

        if (latest) setFormFromRecord(latest);

        setPill("Demo loaded", "good");
      } catch (e) {
        setPill("Demo load failed", "warn");
      }
    }

    function generate() {
      const accountId = String($("accountId").value || "").trim();
      const eventId = String($("eventId").value || "").trim() || newEventId("cmp");
      $("eventId").value = eventId;

      if (!accountId) {
        setPill("Missing accountId", "warn");
        return;
      }

      const existing = loadFromInjectedOrTextarea();
      const account = ensureAccountShape(existing, accountId);

      const fields = buildFieldsFromForm();
      // Hard enforce accountId in top-level
      account.accountId = accountId;

      const record = buildRecordFromForm(eventId, fields);
      const { previous } = appendComplianceRecord(account, record);

      // Output
      $("outputJson").value = JSON.stringify(account, null, 2);
      renderReport(record, previous);

      setPill("Generated", "good");
    }

    async function copyOutput() {
      const text = $("outputJson").value || "";
      if (!text.trim()) {
        setPill("Nothing to copy", "warn");
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        setPill("Copied", "good");
      } catch {
        setPill("Copy blocked", "warn");
      }
    }

    // =========================
    // Boot
    // =========================
    $("btnDemo").addEventListener("click", setDemo);
    $("btnGenerate").addEventListener("click", generate);
    $("btnCopy").addEventListener("click", copyOutput);
    $("btnPrint").addEventListener("click", () => window.print());
    $("btnExpandAll").addEventListener("click", () => expandCollapse(true));
    $("btnCollapseAll").addEventListener("click", () => expandCollapse(false));

    // Seed eventId + default tab
    $("eventId").value = newEventId("cmp");
    window.__TM_ACTIVE_TAB = "overview";
    renderTabs(window.__TM_ACTIVE_TAB);
    renderTabPanel(window.__TM_ACTIVE_TAB);
    setPill("Idle", "idle");
  </script>
</body>
</html>