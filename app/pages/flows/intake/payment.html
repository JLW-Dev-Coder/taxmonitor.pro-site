<!-- /app/pages/flows/intake/payment.html -->
<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tax Monitor Pro — Payment</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Match offer.html exactly -->
  <link rel="apple-touch-icon" href="/assets/favicon.ico" />
  <link rel="icon" href="/assets/favicon.ico" />

  <style>
    :root { color-scheme: dark; }
    body { font-family: 'DM Sans', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    .noise-bg {
      background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="120" height="120"%3E%3Cfilter id="n"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="120" height="120" filter="url(%23n)" opacity="0.18"/%3E%3C/svg%3E');
    }

    .aurora {
      position: absolute;
      inset: -40% -30% auto -30%;
      height: 80vh;
      pointer-events: none;
      filter: blur(40px);
      opacity: 0.55;
      background:
        radial-gradient(closest-side, rgba(245,158,11,0.35), transparent 65%),
        radial-gradient(closest-side, rgba(56,189,248,0.18), transparent 60%),
        radial-gradient(closest-side, rgba(168,85,247,0.14), transparent 62%);
      transform: translate3d(0,0,0);
    }

    .glass-card {
      background: rgba(2,6,23,0.55);
      border: 1px solid rgba(148,163,184,0.16);
      box-shadow: 0 20px 50px rgba(0,0,0,0.45);
      backdrop-filter: blur(10px);
    }

    .glass-card-light {
      background: rgba(2,6,23,0.35);
      border: 1px solid rgba(148,163,184,0.12);
      backdrop-filter: blur(10px);
      border-radius: 16px;
    }

    .gradient-border { position: relative; }

    .gradient-border:before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: 24px;
      padding: 1px;
      background: linear-gradient(135deg, rgba(245,158,11,0.55), rgba(14,165,233,0.20), rgba(168,85,247,0.20));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }

    .fade-in-up { animation: fadeInUp 520ms ease-out both; }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .progress-glow {
      background: linear-gradient(90deg, rgba(245,158,11,0.95), rgba(217,119,6,0.95));
      box-shadow: 0 0 20px rgba(245,158,11,0.35);
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(245,158,11,0.22); }
      50% { box-shadow: 0 0 40px rgba(245,158,11,0.42); }
    }

    .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }

    .tm-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 24px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 15px;
      border: 1px solid rgba(148,163,184,0.16);
      background: rgba(2,6,23,0.35);
      color: rgba(226,232,240,0.92);
      transition: transform 140ms ease, opacity 140ms ease;
      user-select: none;
      width: 100%;
    }

    .tm-btn:hover { opacity: 0.96; transform: translateY(-1px); }

    .tm-btn-primary {
      background: linear-gradient(135deg, rgba(245,158,11,0.95), rgba(217,119,6,0.95));
      border-color: rgba(245,158,11,0.35);
      color: rgba(2,6,23,0.98);
      box-shadow: 0 18px 35px rgba(245,158,11,0.18);
    }

    .tm-error {
      display: none;
      border: 1px solid rgba(248,113,113,0.25);
      background: rgba(248,113,113,0.10);
      color: rgba(254,202,202,0.95);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
    }

    .tm-error[aria-hidden="false"] { display: block; }

    .sidebar-shell {
      border-right: 1px solid rgba(148,163,184,0.10);
      background: rgba(2,6,23,0.40);
      backdrop-filter: blur(10px);
    }

    .topbar-shell {
      border-bottom: 1px solid rgba(148,163,184,0.10);
      background: rgba(2,6,23,0.38);
      backdrop-filter: blur(10px);
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(2, 6, 23, 0.45); }
    ::-webkit-scrollbar-thumb { background: rgba(245, 158, 11, 0.28); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(245, 158, 11, 0.45); }
  </style>

  <style>@view-transition { navigation: auto; }</style>
</head>

<body class="h-full bg-slate-950 text-slate-100">
  <div class="relative min-h-screen overflow-hidden">
    <div class="aurora" aria-hidden="true"></div>
    <div class="pointer-events-none absolute inset-0 noise-bg opacity-50" aria-hidden="true"></div>

    <div class="relative z-10 min-h-screen grid lg:grid-cols-[280px_1fr]">
      <aside class="hidden lg:block sidebar-shell">
        <div id="tm-sidebar" class="h-full">
          <!-- Canvas preview fallback (partials load at runtime in the real app) -->
          <div class="p-4">
            <div class="flex items-center gap-3">
              <span class="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 text-slate-950 font-bold">TM</span>
              <div>
                <div class="text-sm font-semibold text-slate-200">Tax Monitor Pro</div>
                <div class="text-xs text-slate-500">Loading sidebar…</div>
              </div>
            </div>
            <div class="mt-6 space-y-2">
              <div class="h-9 rounded-xl bg-white/5 border border-white/10"></div>
              <div class="h-9 rounded-xl bg-white/5 border border-white/10"></div>
              <div class="h-9 rounded-xl bg-white/5 border border-white/10"></div>
            </div>
          </div>
        </div>
      </aside>

      <div class="min-h-screen flex flex-col">
        <div class="topbar-shell sticky top-0 z-30">
          <div id="tm-topbar">
            <!-- Canvas preview fallback (partials load at runtime in the real app) -->
            <div class="mx-auto max-w-5xl px-6 py-3">
              <div class="flex items-center justify-between">
                <div class="h-4 w-40 rounded bg-white/10"></div>
                <div class="flex items-center gap-2">
                  <div class="h-8 w-8 rounded-full bg-white/10"></div>
                  <div class="h-8 w-8 rounded-full bg-white/10"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <header class="px-6 pt-6">
          <div class="mx-auto max-w-5xl">
            <div class="glass-card rounded-[24px] p-5 border border-white/10">
              <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div class="flex items-center gap-3">
                  <span class="flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 text-slate-950 font-bold">TM</span>
                  <div>
                    <div class="font-semibold">Tax Monitor Pro</div>
                    <div class="text-xs text-slate-400">Payment</div>
                  </div>
                </div>

                <div class="flex items-center gap-2 sm:gap-4">
                  <div class="flex items-center gap-2" data-step="intake">
                    <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center">
                      <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                      </svg>
                    </div>
                    <span class="text-sm font-semibold text-emerald-400">Intake</span>
                  </div>

                  <div class="w-8 h-0.5 bg-white/10"></div>

                  <div class="flex items-center gap-2" data-step="offer">
                    <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center">
                      <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                      </svg>
                    </div>
                    <span class="text-sm font-semibold text-emerald-400">Offer</span>
                  </div>

                  <div class="w-8 h-0.5 bg-white/10"></div>

                  <div class="flex items-center gap-2" data-step="agreement">
                    <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center">
                      <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                      </svg>
                    </div>
                    <span class="text-sm font-semibold text-emerald-400">Agreement</span>
                  </div>

                  <div class="w-8 h-0.5 bg-white/10"></div>

                  <div class="flex items-center gap-2" data-step="payment">
                    <div class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center animate-pulse-glow">
                      <span class="text-xs font-bold text-slate-950">4</span>
                    </div>
                    <span class="text-sm font-semibold text-amber-400">Payment</span>
                  </div>
                </div>

                <div>
                  <button id="back-btn" type="button" class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1.5 text-xs font-semibold text-slate-300 hover:text-amber-300 hover:border-amber-500/30">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Back
                  </button>
                </div>
              </div>

              <div class="mt-4 h-1 bg-white/5 rounded-full overflow-hidden">
                <div class="h-full w-full progress-glow rounded-full"></div>
              </div>
            </div>
          </div>
        </header>

        <main class="flex-1">
          <div class="mx-auto max-w-5xl px-6 py-10">
            <section class="gradient-border rounded-[24px] fade-in-up">
              <div class="glass-card rounded-[24px] p-6 md:p-8">
                <div class="flex flex-col gap-2">
                  <h1 class="text-2xl md:text-3xl font-bold">Secure Payment</h1>
                  <p id="page-subhead" class="text-slate-300">Complete checkout to activate your Tax Monitor service.</p>
                </div>

                <div id="form-error" class="tm-error mt-5" aria-hidden="true"></div>

                <div class="mt-8 grid gap-6 lg:grid-cols-5">
                  <div class="lg:col-span-3">
                    <div class="glass-card-light rounded-[18px] p-6 border border-white/10">
                      <h2 class="text-lg font-semibold text-slate-100">What happens next</h2>
                      <ul class="mt-4 space-y-3 text-sm text-slate-300">
                        <li class="flex gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-amber-500"></span><span>Checkout completes through <span class="text-slate-100 font-semibold">Stripe</span> on our billing domain.</span></li>
                        <li class="flex gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-amber-500"></span><span>After payment, you will be routed to your status page to confirm activation.</span></li>
                        <li class="flex gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-amber-500"></span><span>Monitoring is informational and does not create IRS representation.</span></li>
                      </ul>

                      <div class="mt-6 rounded-[18px] border border-amber-500/25 bg-amber-500/10 p-5">
                        <div class="font-semibold text-amber-300">Important notice</div>
                        <p class="mt-2 text-sm text-slate-200">Tax Monitor Pro is a monitoring and reporting service. Representation, filing, and resolution are separate engagements.</p>
                      </div>
                    </div>
                  </div>

                  <aside class="lg:col-span-2">
                    <div class="glass-card-light rounded-[18px] p-6 border border-white/10 sticky top-28">
                      <div class="flex items-center justify-between">
                        <div class="font-semibold text-slate-100">Order</div>
                        <div class="font-semibold text-slate-100">Total</div>
                      </div>

                      <div class="mt-4 flex items-start justify-between gap-4">
                        <div>
                          <div id="order-name" class="text-slate-200 font-medium">Not selected</div>
                          <div class="text-xs text-slate-500">Tax Monitor Pro</div>
                        </div>
                        <div class="text-right">
                          <div id="order-total" class="text-2xl font-extrabold bg-gradient-to-br from-amber-300 to-amber-500 bg-clip-text text-transparent">—</div>
                          <div class="text-xs text-slate-500">One-time</div>
                        </div>
                      </div>

                      <div class="mt-6 grid gap-3">
                        <button id="pay-btn" type="button" class="tm-btn tm-btn-primary" disabled>
                          <span id="pay-btn-label">Pay now</span>
                          <svg id="pay-btn-arrow" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"/>
                          </svg>
                          <svg id="pay-btn-spinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                        </button>

                        <button id="btn-back-agreement" type="button" class="tm-btn">Back to Agreement</button>
                      </div>

                      <p class="mt-5 text-xs text-slate-400 text-center">By paying, you confirm the signed agreement and proceed to service activation.</p>
                      <p class="mt-3 text-xs text-slate-400 text-center">Need help? Email <a class="underline hover:text-slate-200" href="mailto:support@taxmonitor.pro">support@taxmonitor.pro</a></p>
                    </div>
                  </aside>
                </div>

                <footer class="text-center py-6">
                  <p class="text-sm text-slate-500">© <span id="footer-year"></span> Tax Monitor Pro. All rights reserved.</p>
                  <p class="text-xs text-slate-600 mt-1">
                    Encrypted in transit using industry-standard
                    <a href="https://www.cloudflare.com/learning/ssl/what-is-tls/" target="_blank" rel="noopener noreferrer" class="underline hover:text-slate-400">TLS</a>
                  </p>
                </footer>
              </div>
            </section>
          </div>
        </main>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var y = document.getElementById('footer-year');
      if (y) y.textContent = String(new Date().getFullYear());
    })();
  </script>

  <script>
    (function () {
      'use strict';

      function injectPartial(targetId, url) {
        var el = document.getElementById(targetId);
        if (!el) return;
        fetch(url, { credentials: 'same-origin' })
          .then(function (r) { return r.ok ? r.text() : ''; })
          .then(function (html) { if (html) el.innerHTML = html; })
          .catch(function () {});
      }

      function safeText(s) {
        return String(s || '').replace(/[<>]/g, '').replace(/ +/g, ' ').trim();
      }

      function clearError() {
        var box = document.getElementById('form-error');
        if (!box) return;
        box.textContent = '';
        box.setAttribute('aria-hidden', 'true');
      }

      function showError(msg) {
        var box = document.getElementById('form-error');
        if (!box) return;
        box.textContent = String(msg || 'Something went wrong.');
        box.setAttribute('aria-hidden', 'false');
      }

      function setPayLoading(isLoading) {
        var btn = document.getElementById('pay-btn');
        var lab = document.getElementById('pay-btn-label');
        var arr = document.getElementById('pay-btn-arrow');
        var spn = document.getElementById('pay-btn-spinner');
        if (btn) btn.disabled = !!isLoading;
        if (lab) lab.textContent = isLoading ? 'Redirecting…' : 'Pay now';
        if (arr) arr.classList.toggle('hidden', !!isLoading);
        if (spn) spn.classList.toggle('hidden', !isLoading);
      }

      function money(n) {
        var num = Number(n);
        if (!isFinite(num)) return '—';
        return '$' + num.toFixed(0);
      }

      function withQuery(urlPath) {
        var u = new URL(urlPath, window.location.origin);
        var qs = new URLSearchParams(window.location.search || '');
        qs.forEach(function (v, k) { u.searchParams.set(k, v); });
        return u.toString();
      }

      injectPartial('tm-sidebar', '/app/partials/sidebar.html');
      injectPartial('tm-topbar', '/app/partials/topbar.html');

      var headerBack = document.getElementById('back-btn');
      var backAgreement = document.getElementById('btn-back-agreement');

      function goBack() {
        window.location.href = withQuery('/app/pages/flows/intake/agreement.html');
      }

      if (headerBack) headerBack.addEventListener('click', goBack);
      if (backAgreement) backAgreement.addEventListener('click', goBack);

      var params = new URLSearchParams(window.location.search || '');
      var code = safeText(params.get('code'));
      var item = safeText(params.get('item'));

      var PRICE_BY_ITEM = {
        bronze: 275,
        gold: 425,
        mfj: 325,
        one_time: 299,
        silver: 325
      };

      var NAME_BY_ITEM = {
        bronze: 'Tax Monitoring — Bronze',
        gold: 'Tax Monitoring — Gold',
        mfj: 'Tax Monitoring — Married Filing Jointly',
        one_time: 'Tax Monitoring — One-Time Service',
        silver: 'Tax Monitoring — Silver'
      };

      var orderName = document.getElementById('order-name');
      var orderTotal = document.getElementById('order-total');

      var name = NAME_BY_ITEM[item] || 'Not selected';
      var price = item && Object.prototype.hasOwnProperty.call(PRICE_BY_ITEM, item) ? money(PRICE_BY_ITEM[item]) : '—';

      if (orderName) orderName.textContent = name;
      if (orderTotal) orderTotal.textContent = price;

      var isValidItem = !!NAME_BY_ITEM[item] && Object.prototype.hasOwnProperty.call(PRICE_BY_ITEM, item);
      var isReady = !!code && !!item && isValidItem;

      var payBtn = document.getElementById('pay-btn');
      if (payBtn) payBtn.disabled = !isReady;

      if (!isReady) showError('Missing or invalid selection. Return to Offer to choose a valid plan.');

      if (!payBtn) return;

      payBtn.addEventListener('click', function () {
        clearError();

        if (!isReady) {
          showError('Missing or invalid selection. Return to Offer to choose a valid plan.');
          return;
        }

        setPayLoading(true);

        fetch('/api/stripe/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: code, item: item })
        })
          .then(function (r) {
            return r.json().catch(function () { return null; })
              .then(function (j) { return { ok: r.ok, json: j }; });
          })
          .then(function (res) {
            if (!res || !res.ok || !res.json) throw new Error('Checkout request failed.');
            if (res.json.url) { window.location.href = String(res.json.url); return; }
            if (res.json.checkout_url) { window.location.href = String(res.json.checkout_url); return; }
            throw new Error(res.json.error || 'Missing checkout URL.');
          })
          .catch(function (e) {
            setPayLoading(false);
            if (payBtn) payBtn.disabled = false;
            showError(e && e.message ? e.message : 'Unable to start checkout.');
          });
      });
    })();
  </script>

  <script>
    (function () {
      var defaultConfig = {
        page_subhead: 'Complete checkout to activate your Tax Monitor service.'
      };

      async function onConfigChange(config) {
        var pageSubhead = document.getElementById('page-subhead');
        if (pageSubhead && config && config.page_subhead) pageSubhead.textContent = config.page_subhead;
      }

      function mapToCapabilities(config) {
        return {
          borderables: [],
          fontEditable: null,
          fontSizeable: null,
          recolorables: []
        };
      }

      function mapToEditPanelValues(config) {
        return new Map([
          ['page_subhead', (config && config.page_subhead) ? config.page_subhead : defaultConfig.page_subhead]
        ]);
      }

      if (window.elementSdk && window.elementSdk.init) {
        window.elementSdk.init({
          defaultConfig: defaultConfig,
          mapToCapabilities: mapToCapabilities,
          mapToEditPanelValues: mapToEditPanelValues,
          onConfigChange: onConfigChange
        });
      }
    })();
  </script>
</body>
</html>