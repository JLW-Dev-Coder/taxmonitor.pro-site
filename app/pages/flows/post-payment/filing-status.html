<!--/app/pages/flows/post-payment/filing-status.html-->
<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tax Monitor Pro — Filing Status</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'DM Sans', sans-serif; }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .icon-float { animation: float 3s ease-in-out infinite; }

    .gradient-text {
      background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .gradient-border {
      background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444);
    }
    .glass-card {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .gradient-btn {
      background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444);
    }
    .gradient-btn:hover {
      background: linear-gradient(135deg, #d97706, #ea580c, #dc2626);
    }
    .form-input {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .form-input:focus {
      border-color: #f59e0b;
      outline: none;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }

    /* Custom select styling */
    .select-wrapper {
      position: relative;
    }
    .select-wrapper select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 3rem;
    }
    .select-arrow {
      position: absolute;
      top: 50%;
      right: 1rem;
      transform: translateY(-50%);
      pointer-events: none;
      width: 20px;
      height: 20px;
      color: #f59e0b;
      transition: transform 0.2s ease, color 0.2s ease;
    }
    .select-wrapper:focus-within .select-arrow {
      transform: translateY(-50%) rotate(180deg);
      color: #fbbf24;
    }
    .blob-1 {
      position: absolute;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(245, 158, 11, 0.15) 0%, transparent 70%);
      border-radius: 50%;
      top: -100px;
      right: -100px;
      pointer-events: none;
    }
    .blob-2 {
      position: absolute;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(239, 68, 68, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      bottom: 100px;
      left: -50px;
      pointer-events: none;
    }

    /* Email preview (match message.html look) */
    .email-glass {
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(245, 158, 11, 0.18);
    }
    .email-gradient-border {
      position: relative;
    }
    .email-gradient-border::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.55), rgba(217, 119, 6, 0.18), rgba(245, 158, 11, 0.55));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }
    .email-glow-amber {
      box-shadow: 0 0 30px rgba(245, 158, 11, 0.12), 0 0 60px rgba(245, 158, 11, 0.04);
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full bg-slate-900 text-white overflow-auto">
  <div id="app-wrapper" class="min-h-full w-full relative"><!-- Background Blobs -->
   <div class="blob-1"></div>
   <div class="blob-2"></div><!-- Main Content -->
   <div class="relative z-10 max-w-4xl mx-auto px-4 py-8"><!-- Header -->
    <header class="text-center mb-10">
     <div class="mb-6 text-left">
      <a href="/app/index.html" class="inline-flex items-center gap-2 text-sm font-medium text-amber-400 hover:text-amber-300 transition">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
       </svg> Back to Dashboard </a>
     </div>
     <div class="inline-flex items-center justify-center mb-6">
      <div class="icon-float">
       <svg class="w-16 h-16" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
         <linearGradient id="shieldGrad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#f59e0b" />
          <stop offset="50%" style="stop-color:#ef4444" />
          <stop offset="100%" style="stop-color:#fbbf24" />
         </linearGradient>
        </defs>
        <path d="M32 4L8 14v18c0 14 10 22 24 28 14-6 24-14 24-28V14L32 4z" stroke="url(#shieldGrad)" stroke-width="2" fill="rgba(245,158,11,0.10)" />
        <path d="M24 32l6 6 12-14" stroke="url(#shieldGrad)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="none" />
       </svg>
      </div>
     </div>
     <p class="text-amber-400 font-semibold tracking-wider uppercase text-sm mb-2">Tax Monitor Pro</p>
     <h1 id="main-title" class="text-3xl sm:text-4xl lg:text-5xl font-bold gradient-text mb-4">Filing Status</h1>
     <p class="text-slate-400 text-lg">This helps us prepare your IRS monitoring authorization (Form 2848).</p>
    </header><!-- Info Cards -->
    <div class="grid md:grid-cols-3 gap-4 mb-10">
     <div class="glass-card rounded-xl p-5">
      <div class="flex items-center gap-3 mb-3">
       <div class="gradient-border p-0.5 rounded-lg">
        <div class="bg-slate-800 p-2 rounded-lg">
         <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 18a6 6 0 110-12 6 6 0 010 12z" />
         </svg>
        </div>
       </div>
       <h3 class="font-semibold text-white">What This Step Does</h3>
      </div>
      <p class="text-slate-400 text-sm">Your filing status is used to prepare the right monitoring authorization, not for tax resolution.</p>
     </div>
     <div class="glass-card rounded-xl p-5">
      <div class="flex items-center gap-3 mb-3">
       <div class="gradient-border p-0.5 rounded-lg">
        <div class="bg-slate-800 p-2 rounded-lg">
         <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg>
        </div>
       </div>
       <h3 class="font-semibold text-white">Years Covered</h3>
      </div>
      <p class="text-slate-400 text-sm">Monitoring access supports up to 10 compliance years of IRS history.</p>
     </div>
     <div class="glass-card rounded-xl p-5">
      <div class="flex items-center gap-3 mb-3">
       <div class="gradient-border p-0.5 rounded-lg">
        <div class="bg-slate-800 p-2 rounded-lg">
         <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
         </svg>
        </div>
       </div>
       <h3 class="font-semibold text-white">Joint Filing Note</h3>
      </div>
      <p class="text-slate-400 text-sm">If any monitored years were Married Filing Jointly, both spouses need separate authorization.</p>
     </div>
    </div><!-- Form Section -->
    <div class="glass-card rounded-2xl p-6 md:p-8 mb-8">
     <div class="mb-6">
      <h2 id="form-title" class="text-2xl font-bold text-white mb-2">Filing Details</h2>
      <p class="text-slate-400">Enter the information exactly as it appears on your tax documents.</p>
     </div>
     <form id="tax-form" class="space-y-6">
      <!-- Hidden contract fields --> <input type="hidden" id="eventId" name="eventId"> <input type="hidden" id="orderId" name="orderId"> <input type="hidden" id="sessionToken" name="sessionToken"> <input type="hidden" id="MFJ_Add_On_Purchased" name="MFJ_Add_On_Purchased"><!-- Taxpayer Name -->
      <div><label for="taxpayer-name" class="block text-sm font-medium text-slate-300 mb-2"> Taxpayer Full Legal Name </label> <input type="text" id="taxpayer-name" name="taxpayer-name" class="form-input w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 transition-all" placeholder="Enter full legal name as shown on tax documents">
      </div><!-- Taxpayer SSN -->
      <div><label for="taxpayer-ssn" class="block text-sm font-medium text-slate-300 mb-2"> Taxpayer SSN / ITIN </label> <input type="text" id="taxpayer-ssn" name="taxpayer-ssn" class="form-input w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 transition-all" placeholder="XXX-XX-XXXX" maxlength="11">
      </div><!-- Filing Status -->
      <div>
       <label for="filing-status" class="block text-sm font-medium text-slate-300 mb-2"> Filing Status during compliance years 2016 - 2025 </label>
       <div class="select-wrapper">
        <select id="filing-status" name="filing-status" class="form-input w-full px-4 py-3 rounded-lg text-white transition-all cursor-pointer"> <option value="" class="bg-slate-800">Select your filing status</option> <option value="single" class="bg-slate-800">Single</option> <option value="mfj" class="bg-slate-800">Married Filing Jointly</option> <option value="mfs" class="bg-slate-800">Married Filing Separately</option> <option value="hoh" class="bg-slate-800">Head of Household</option> <option value="widow" class="bg-slate-800">Qualifying Widow(er)</option> </select>
        <svg class="select-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
       </div>
      </div><!-- Spouse Section (Hidden by default) -->
      <div id="spouse-section" class="hidden space-y-6 p-5 bg-slate-800/50 rounded-xl border border-amber-500/20">
       <!-- MFJ Add-On Upsell (shown only when MFJ selected but add-on not purchased) -->
       <div id="mfj-upsell" class="hidden email-glass email-gradient-border email-glow-amber rounded-xl p-4">
        <div class="flex items-start gap-3">
         <div class="mt-0.5">
          <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 18a6 6 0 110-12 6 6 0 010 12z" />
          </svg>
         </div>
         <div class="flex-1">
          <div class="text-sm font-semibold text-amber-200">
           MFJ add-on required
          </div>
          <div class="text-xs text-slate-300 mt-1">
           To invite your spouse and include MFJ years, you'll need the MFJ add-on for this order.
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
           <a id="mfj-upsell-link" href="/pricing.html" class="inline-flex items-center justify-center px-3 py-2 rounded-lg text-sm font-medium text-white gradient-btn">Upgrade to MFJ Add-On</a> <a href="/contact.html" class="inline-flex items-center justify-center px-3 py-2 rounded-lg text-sm font-medium text-amber-300 border border-amber-500/30 bg-slate-900/40 hover:bg-slate-900/60">Contact support</a>
          </div>
          <div class="text-[11px] text-slate-400 mt-2">
           Your filing status can still be saved. The spouse invitation stays disabled until upgraded.
          </div>
         </div>
        </div>
       </div>
       <div class="flex items-center gap-2 text-amber-400 mb-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 18a6 6 0 110-12 6 6 0 010 12z" />
        </svg><span class="font-medium">Joint Filing Detected</span> <button type="button" id="mfj-info-btn" class="ml-auto text-sm text-amber-400 hover:text-amber-300 underline"> How MFJ records work → </button>
       </div>
       <div><label for="spouse-name" class="block text-sm font-medium text-slate-300 mb-2"> Spouse's Full Legal Name </label> <input type="text" id="spouse-name" name="spouse-name" class="form-input w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 transition-all" placeholder="Enter spouse's full legal name">
       </div>
       <div><label for="spouse-email" class="block text-sm font-medium text-slate-300 mb-2"> Spouse's Email Address </label> <input type="email" id="spouse-email" name="spouse-email" class="form-input w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 transition-all" placeholder="spouse@email.com">
       </div>
       <div class="flex items-start gap-3"><input type="checkbox" id="invite-spouse" name="invite-spouse" class="mt-1 w-5 h-5 rounded border-slate-600 bg-slate-700 text-amber-500 focus:ring-amber-500 cursor-pointer">
        <div><label for="invite-spouse" class="text-sm font-medium text-slate-300 cursor-pointer"> Send invitation to spouse for separate authorization </label>
         <p class="text-xs text-slate-500 mt-1">We'll email authorization details and copy it to your Messaging Inbox <button type="button" id="preview-email-btn" class="text-amber-400 hover:text-amber-300 underline ml-1"> Preview email </button></p>
        </div>
       </div>
      </div><!-- Actions -->
      <div class="pt-4">
       <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button type="submit" id="submit-btn" class="gradient-btn w-full py-4 px-6 rounded-xl font-semibold text-white text-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2">
         <span id="submit-text">Submit &amp; Continue</span>
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
         </svg>
        </button>

        <button type="button" id="reset-btn" class="w-full py-4 px-6 rounded-xl font-semibold text-slate-200 text-lg border border-amber-500/30 bg-slate-900/60 hover:bg-slate-900/80 transition">
         Reset Form
        </button>
       </div>
      </div>
     </form>
    </div><!-- Footer -->
    <footer class="text-center text-slate-500 text-sm">
     <div class="flex items-center justify-center gap-4"><span class="flex items-center gap-1">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
       </svg> Secure </span> <span>•</span> <span>Confidential</span> <span>•</span> <span>Professional</span>
     </div>
    </footer>
   </div><!-- MFJ Info Modal -->
   <div id="mfj-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="glass-card rounded-2xl p-6 max-w-lg w-full max-h-[90%] overflow-auto">
     <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-bold gradient-text">How MFJ Records Work</h3><button type="button" id="close-mfj-modal" class="text-slate-400 hover:text-white transition-colors">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
       </svg></button>
     </div>
     <div class="space-y-4 text-slate-300">
      <p>For <strong class="text-white">Married Filing Jointly (MFJ)</strong> years, each spouse must enroll and authorize separately. One spouse's enrollment does not grant access to the other's IRS records.</p>
      <div class="bg-slate-800/50 rounded-lg p-4 border-l-4 border-amber-500">
       <p class="text-sm"><strong class="text-amber-400">Important:</strong> Accounts remain separate at all times. There is no shared dashboard, merged access, or combined user login.</p>
      </div>
      <ul class="space-y-2 text-sm">
       <li class="flex items-start gap-2">
        <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg> Each spouse signs their own Form 2848 authorization</li>
       <li class="flex items-start gap-2">
        <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg> After both authorizations are complete, both records can be updated with MFJ years for a complete 10-year analysis.</li>
       <li class="flex items-start gap-2">
        <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg> If one spouse does not complete enrollment and authorization, MFJ years remain unavailable</li>
       <li class="flex items-start gap-2">
        <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg> Non-completion by a spouse does not create refunds, credits, or modified service terms</li>
      </ul>
      <p class="text-sm text-slate-400">Jointly filed years require cooperation from both taxpayers. We are not responsible for delays or non-participation by a spouse.</p>
     </div><button type="button" id="got-it-mfj" class="gradient-btn w-full mt-6 py-3 px-4 rounded-lg font-medium text-white"> Got it </button>
    </div>
   </div><!-- Email Preview Modal -->
   <div id="email-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="glass-card rounded-2xl p-6 max-w-lg w-full max-h-[90%] overflow-auto">
     <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-bold gradient-text">Sample Invitation Email</h3><button type="button" id="close-email-modal" class="text-slate-400 hover:text-white transition-colors">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
       </svg></button>
     </div>
     <div class="space-y-4 text-slate-300">
      <div class="bg-slate-800/50 rounded-lg p-4 border-l-4 border-amber-500">
       <p class="text-sm"><strong class="text-amber-400">Preview:</strong> This is the invitation we send to your spouse for separate MFJ authorization.</p>
      </div>
      <div class="bg-slate-800/30 rounded-xl p-4 border border-slate-700/60">
       <div class="border-b border-slate-700/60 pb-3 mb-4">
        <p class="text-xs text-slate-400 mb-1">From: <span class="text-slate-200">Tax Monitor Pro &lt;noreply@taxmonitorpro.com&gt;</span></p>
        <p class="text-xs text-slate-400 mb-1">To: <span id="email-recipient" class="text-slate-200">spouse@email.com</span></p>
        <p class="text-xs text-slate-400">Subject: <strong class="text-slate-100">Separate authorization needed for MFJ years</strong></p>
       </div>
       <div class="space-y-3 text-sm">
        <p>Hi <span id="email-spouse-name">there</span>,</p>
        <p><span id="email-taxpayer-name">Your spouse</span> is enrolling in IRS monitoring through Tax Monitor Pro and indicated you filed jointly for at least one year.</p>
        <p>For <strong class="text-white">Married Filing Jointly (MFJ)</strong> years, each spouse must enroll separately and complete their own authorization.</p>
        <div class="bg-amber-500/10 border border-amber-500/25 rounded-lg p-3">
         <p class="text-amber-200 text-xs"><strong>What you'll need:</strong> Your SSN/ITIN and about 5 minutes to complete intake and authorization form. Enrollment requires payment with the MFJ add-on.</p>
        </div>
        <ul class="space-y-2 text-sm pt-1">
         <li class="flex items-start gap-2">
          <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg> Your account remains separate and private</li>
         <li class="flex items-start gap-2">
          <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg> Once both authorizations are complete, MFJ years can be included for a complete 10-year analysis</li>
        </ul>
        <p class="text-slate-300">Click below to begin your separate authorization:</p>
        <div class="bg-gradient-to-r from-amber-500 via-orange-500 to-red-500 text-white text-center py-3 px-4 rounded-lg font-medium">
         Start Authorization →
        </div>
        <p class="text-xs text-slate-400 mt-4">Need help or want to know more? Visit our <a href="/contact.html" target="_blank" class="text-amber-400 underline hover:text-amber-300">contact page</a> and reference ID <strong class="text-slate-200" id="email-event-id">EVT-000000</strong>. This invitation does not create shared access.</p>
       </div>
      </div>
     </div><button type="button" id="close-email-preview" class="gradient-btn w-full mt-6 py-3 px-4 rounded-lg font-medium text-white"> Close Preview </button>
    </div>
   </div><!-- Success Toast -->
   <div id="success-toast" class="fixed bottom-6 right-6 bg-green-600 text-white px-6 py-4 rounded-xl shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
    </svg><span>Filing details saved successfully!</span>
   </div><!-- Error Toast -->
   <div id="error-toast" class="fixed bottom-6 right-6 bg-red-600 text-white px-6 py-4 rounded-xl shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg><span id="error-message">An error occurred</span>
   </div>
  </div>

  <script>
const API_BASE = 'https://api.taxmonitor.pro';
const ORDER_STATE_ENDPOINT = `${API_BASE}/orders/state`;
const FILING_STATUS_ENDPOINT = `${API_BASE}/forms/post-payment/filing-status`;

const tmCommon = {
  ensureEventId: () => (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())
};

function formatSSN(value) {
  const cleaned = String(value || '').replace(/[^0-9]/g, '');
  const re = new RegExp('^([0-9]{0,3})([0-9]{0,2})([0-9]{0,4})$');
  const match = cleaned.match(re);
  if (match) return [match[1], match[2], match[3]].filter(Boolean).join('-');
  return value;
}

function getDigits(value) {
  return String(value || '').replace(/[^0-9]/g, '');
}

function getQuery(name) {
  const v = new URLSearchParams(location.search).get(name);
  return v ? v.trim() : '';
}

function showToast(type, msg) {
  console.log(String(type || '').toUpperCase() + ':', msg);
}

async function fetchOrderState(orderId, sessionToken) {
  const url = new URL(ORDER_STATE_ENDPOINT, location.origin);
  url.searchParams.set('orderId', orderId);
  url.searchParams.set('sessionToken', sessionToken);

  const res = await fetch(url.toString(), { method: 'GET' });
  if (!res.ok) throw new Error(`Order state HTTP ${res.status}`);
  return res.json();
}

(function runSelfTests() {
  const f = document.getElementById('tax-form');
  console.assert(!!f, 'Form should exist');

  console.assert(API_BASE === 'https://api.taxmonitor.pro', 'API_BASE should be canonical');
  console.assert(FILING_STATUS_ENDPOINT.endsWith('/forms/post-payment/filing-status'), 'FILING_STATUS_ENDPOINT should match contract route');

  console.assert(typeof formatSSN('123456789') === 'string', 'formatSSN should return string');
  console.assert(formatSSN('123456789') === '123-45-6789', 'formatSSN should format 9 digits');
  console.assert(formatSSN('123-45-6789') === '123-45-6789', 'formatSSN should keep formatted SSN');

  console.assert(getQuery('___does_not_exist___') === '', 'getQuery should return empty string when missing');
  console.assert(getDigits('123-45-6789') === '123456789', 'getDigits should strip dashes');
  console.assert(getDigits('abc') === '', 'getDigits should return empty string for non-digits');

  // DOM sanity checks
  console.assert(!!document.getElementById('spouse-section'), 'spouse-section should exist');
  console.assert(!document.getElementById('reset-btn'), 'reset-btn should not exist before DOMContentLoaded (added later in markup)');
  console.assert(!document.getElementById('spouse-fields'), 'spouse-fields should not exist (removed)');
})();

document.addEventListener('DOMContentLoaded', async () => {
  const primeHiddenFields = () => {
    // Keep hidden contract fields stable after resets
    if (eventIdEl) eventIdEl.value = getQuery('eventId') || tmCommon.ensureEventId();
    if (orderIdEl) orderIdEl.value = getQuery('orderId');
    if (sessionTokenEl) sessionTokenEl.value = getQuery('sessionToken');
  };
  const form = document.getElementById('tax-form');
  const filingStatus = document.getElementById('filing-status');
  const spouseSection = document.getElementById('spouse-section');
  const ssnInput = document.getElementById('taxpayer-ssn');
  const inviteSpouse = document.getElementById('invite-spouse');
  const resetBtn = document.getElementById('reset-btn');

  // Modal elements
  const mfjModal = document.getElementById('mfj-modal');
  const emailModal = document.getElementById('email-modal');
  const mfjInfoBtn = document.getElementById('mfj-info-btn');
  const previewEmailBtn = document.getElementById('preview-email-btn');
  const closeMfjModal = document.getElementById('close-mfj-modal');
  const closeEmailModal = document.getElementById('close-email-modal');
  const gotItMfj = document.getElementById('got-it-mfj');
  const closeEmailPreview = document.getElementById('close-email-preview');

  // Hidden contract fields
  const eventIdEl = document.getElementById('eventId');
  const orderIdEl = document.getElementById('orderId');
  const sessionTokenEl = document.getElementById('sessionToken');
  const mfjPurchasedEl = document.getElementById('MFJ_Add_On_Purchased');
  const mfjUpsell = document.getElementById('mfj-upsell');

  primeHiddenFields();

  // Prefetch order state
  let mfjAddOn = false;
  try {
    const orderId = orderIdEl && orderIdEl.value ? orderIdEl.value.trim() : '';
    const sessionToken = sessionTokenEl && sessionTokenEl.value ? sessionTokenEl.value.trim() : '';

    if (orderId && sessionToken) {
      const state = await fetchOrderState(orderId, sessionToken);
      mfjAddOn = !!(state && state.addons && state.addons.mfjPurchased);
      if (mfjPurchasedEl) mfjPurchasedEl.value = mfjAddOn ? 'true' : '';
    }
  } catch (err) {
    console.warn('Order state fetch failed:', err);
  }

  // Modal control functions
  function openMfjModal() {
    mfjModal.classList.remove('hidden');
    mfjModal.classList.add('flex');
  }

  function closeMfjModalFn() {
    mfjModal.classList.add('hidden');
    mfjModal.classList.remove('flex');
  }

  function openEmailModal() {
    const spouseName = document.getElementById('spouse-name').value.trim() || 'there';
    const spouseEmail = document.getElementById('spouse-email').value.trim() || 'spouse@email.com';
    const taxpayerName = document.getElementById('taxpayer-name').value.trim() || 'Your spouse';
    const eventId = eventIdEl.value || 'EVT-000000';

    document.getElementById('email-spouse-name').textContent = spouseName;
    document.getElementById('email-recipient').textContent = spouseEmail;
    document.getElementById('email-taxpayer-name').textContent = taxpayerName;
    document.getElementById('email-event-id').textContent = eventId;

    emailModal.classList.remove('hidden');
    emailModal.classList.add('flex');
  }

  function closeEmailModalFn() {
    emailModal.classList.add('hidden');
    emailModal.classList.remove('flex');
  }

  // Modal event listeners
  if (mfjInfoBtn) {
    mfjInfoBtn.addEventListener('click', (e) => {
      e.preventDefault();
      openMfjModal();
    });
  }

  if (previewEmailBtn) {
    previewEmailBtn.addEventListener('click', (e) => {
      e.preventDefault();
      openEmailModal();
    });
  }

  if (closeMfjModal) {
    closeMfjModal.addEventListener('click', closeMfjModalFn);
  }

  if (closeEmailModal) {
    closeEmailModal.addEventListener('click', closeEmailModalFn);
  }

  if (gotItMfj) {
    gotItMfj.addEventListener('click', closeMfjModalFn);
  }

  if (closeEmailPreview) {
    closeEmailPreview.addEventListener('click', closeEmailModalFn);
  }

  // Close modals on backdrop click
  if (mfjModal) {
    mfjModal.addEventListener('click', (e) => {
      if (e.target === mfjModal) closeMfjModalFn();
    });
  }

  if (emailModal) {
    emailModal.addEventListener('click', (e) => {
      if (e.target === emailModal) closeEmailModalFn();
    });
  }

  if (ssnInput) {
    ssnInput.addEventListener('input', (e) => {
      e.target.value = formatSSN(e.target.value);
    });
  }

  if (filingStatus) {
    filingStatus.addEventListener('change', (e) => {
      if (e.target.value === 'mfj') {
        spouseSection.classList.remove('hidden');

        if (mfjAddOn) {
          if (mfjUpsell) mfjUpsell.classList.add('hidden');
          if (inviteSpouse) inviteSpouse.disabled = false;
        } else {
          if (mfjUpsell) mfjUpsell.classList.remove('hidden');
          if (inviteSpouse) inviteSpouse.disabled = true;
          showToast('info', 'Upgrade to MFJ add-on to invite spouse.');
        }
      } else {
        spouseSection.classList.add('hidden');
        if (mfjUpsell) mfjUpsell.classList.add('hidden');
        if (inviteSpouse) inviteSpouse.disabled = true;
      }
    });
  }

  // Reset
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      if (form) form.reset();
      primeHiddenFields();
      if (spouseSection) spouseSection.classList.add('hidden');
      if (mfjUpsell) mfjUpsell.classList.add('hidden');
      if (inviteSpouse) inviteSpouse.disabled = true;
      if (filingStatus) filingStatus.value = '';
      const nameEl = document.getElementById('taxpayer-name');
      if (nameEl) nameEl.focus();
      showToast('info', 'Form reset');
    });
  }

  // ===== SUBMIT HANDLER (POST TO WORKER) =====
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('taxpayer-name').value.trim();
      const ssn = document.getElementById('taxpayer-ssn').value.trim();
      const status = filingStatus ? filingStatus.value : '';

      if (!name) {
        showToast('error', 'Name required');
        return;
      }

      if (getDigits(ssn).length !== 9) {
        showToast('error', 'Valid SSN required');
        return;
      }

      if (!status) {
        showToast('error', 'Select a filing status');
        return;
      }

      try {
        const payload = new FormData(form);

        const res = await fetch(FILING_STATUS_ENDPOINT, {
          method: 'POST',
          body: payload
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        if (status === 'mfj' && !mfjAddOn) {
          showToast('info', 'Saved MFJ status. Upgrade to enable spouse invitation.');
        }

        showToast('success', 'Saved');

        // Expected behavior question (answer in chat):
        // Should this page redirect immediately after a successful POST,
        // or should it stay put and show the success toast?

        // Current behavior: redirect forward preserving querystring
        const qs = location.search || '';
        window.location.href = `/app/pages/flows/post-payment/address-update.html${qs}`;
      } catch (err) {
        console.error('Submit failed:', err);
        showToast('error', 'Unable to save filing details');
      }
    });
  }
});
  </script>
 </body>
</html>