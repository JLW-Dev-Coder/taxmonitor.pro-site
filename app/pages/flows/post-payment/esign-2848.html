<!--/app/pages/flows/post-payment/esign-2848.html-->
<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tax Monitor Pro — eSign 2848</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'DM Sans', sans-serif; }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    .icon-float { animation: float 3s ease-in-out infinite; }

    .gradient-text {
      background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .gradient-border { background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444); }
    .glass-card {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .gradient-btn {
      background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444);
    }
    .gradient-btn:hover {
      background: linear-gradient(135deg, #d97706, #ea580c, #dc2626);
    }

    .blob-1 {
      position: absolute;
      width: 420px;
      height: 420px;
      background: radial-gradient(circle, rgba(245, 158, 11, 0.15) 0%, transparent 70%);
      border-radius: 50%;
      top: -110px;
      right: -120px;
      pointer-events: none;
    }
    .blob-2 {
      position: absolute;
      width: 320px;
      height: 320px;
      background: radial-gradient(circle, rgba(239, 68, 68, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      bottom: 90px;
      left: -60px;
      pointer-events: none;
    }

    /* Content typography */
    .tm-prose h2 { font-size: 1.15rem; font-weight: 800; margin-top: 1.25rem; margin-bottom: .4rem; color: #fff; }
    .tm-prose h3 { font-size: 1rem; font-weight: 800; margin-top: 1rem; margin-bottom: .25rem; color: #e2e8f0; }
    .tm-prose p { color: rgba(148,163,184,1); line-height: 1.65; }
    .tm-prose ul { margin-top: .25rem; margin-bottom: .75rem; padding-left: 1.2rem; color: rgba(148,163,184,1); }
    .tm-prose li { margin: .25rem 0; }
    .tm-prose hr { border: 0; border-top: 1px solid rgba(255,255,255,0.10); margin: 1.1rem 0; }

    /* Inline preview table */
    .tm-kv {
      display: grid;
      grid-template-columns: 1fr;
      gap: .6rem;
    }
    @media (min-width: 640px) {
      .tm-kv { grid-template-columns: 1fr 1fr; }
    }
    .tm-kv-item {
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px 14px;
    }
    .tm-kv-k { font-size: 12px; text-transform: uppercase; letter-spacing: .08em; color: rgba(251,191,36,0.85); }
    .tm-kv-v { margin-top: 6px; font-weight: 700; color: #fff; }
    .tm-muted { font-weight: 600; color: rgba(148,163,184,1); }

    /* Draft bar */
    .tm-draft {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(245, 158, 11, 0.18);
      backdrop-filter: blur(18px);
    }

    /* Toast */
    .tm-toast {
      transform: translateY(20px);
      opacity: 0;
      transition: transform .25s ease, opacity .25s ease;
    }
    .tm-toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* Status indicator */
    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .status-dot.ready { background-color: #94a3b8; }
    .status-dot.generating { background-color: #f59e0b; animation: pulse 1.5s ease-in-out infinite; }
    .status-dot.success { background-color: #10b981; }
    .status-dot.error { background-color: #ef4444; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Flip card styles */
    .flip-card-container {
      perspective: 1000px;
      height: 100%;
      min-height: 500px;
      position: relative;
    }
    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      transform-style: preserve-3d;
    }
    .flip-card-inner.flipped {
      transform: rotateY(180deg);
    }
    .flip-card-front,
    .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      box-sizing: border-box;
    }
    .flip-card-back {
      transform: rotateY(180deg);
    }
    .flip-card-label {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: rgba(251, 191, 36, 0.85);
      z-index: 10;
    }
    .flip-card-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .flip-toggle-btn {
      flex: 1;
      padding: 0.65rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.85rem;
      font-weight: 600;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(15, 23, 42, 0.6);
      color: rgba(148, 163, 184, 1);
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .flip-toggle-btn:hover {
      border-color: rgba(245, 158, 11, 0.3);
      background: rgba(15, 23, 42, 0.8);
    }
    .flip-toggle-btn.active {
      background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444);
      color: white;
      border-color: transparent;
    }
    .flip-toggle-btn:focus {
      outline: none;
      border-color: rgba(245, 158, 11, 0.5);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }

    .flip-card-svg {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* Form input styling */
    input[type="text"], input[type="tel"], input[type="email"], input[type="date"] {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #fff;
      padding: 0.65rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.95rem;
    }
    input[type="text"]::placeholder,
    input[type="tel"]::placeholder,
    input[type="email"]::placeholder,
    input[type="date"]::placeholder { color: rgba(148, 163, 184, 0.6); }
    input[type="text"]:focus,
    input[type="tel"]:focus,
    input[type="email"]:focus,
    input[type="date"]:focus {
      outline: none;
      border-color: rgba(245, 158, 11, 0.5);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }

    input[type="checkbox"] {
      width: 1.25rem;
      height: 1.25rem;
      accent-color: #f59e0b;
      cursor: pointer;
    }

    input[type="radio"] {
      width: 1.25rem;
      height: 1.25rem;
      accent-color: #f59e0b;
      cursor: pointer;
    }

    /* Section divider styling */
    .form-section-divider {
      border-top: 2px solid rgba(255,255,255,0.08);
      padding-top: 2rem;
      margin-top: 2rem;
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-slate-900 text-white overflow-auto">
  <div id="app-wrapper" class="min-h-full w-full relative">
   <div class="blob-1"></div>
   <div class="blob-2"></div>
   <div class="relative z-10 max-w-4xl mx-auto px-4 py-8"><!-- Header -->
    <header class="text-center mb-10">
     <div class="mb-6 text-left"><a href="/app/index.html" class="inline-flex items-center gap-2 text-sm font-medium text-amber-400 hover:text-amber-300 transition">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
       </svg> Back to Dashboard </a>
     </div>
     <div class="inline-flex items-center justify-center mb-6">
      <div class="icon-float">
       <svg class="w-16 h-16" viewbox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><defs>
         <lineargradient id="shieldGrad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#f59e0b" />
          <stop offset="50%" style="stop-color:#ef4444" />
          <stop offset="100%" style="stop-color:#fbbf24" />
         </lineargradient>
        </defs> <path d="M32 4L8 14v18c0 14 24 22 24 22s24-8 24-22V14L32 4z" stroke="url(#shieldGrad)" stroke-width="2" fill="rgba(245,158,11,0.10)" /> <path d="M24 32l6 6 12-14" stroke="url(#shieldGrad)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="none" />
       </svg>
      </div>
     </div>
     <p class="text-amber-400 font-semibold tracking-wider uppercase text-sm mb-2">Tax Monitor Pro</p>
     <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold gradient-text mb-4">IRS Authorization (2848)</h1>
     <p class="text-slate-400 text-lg">Sign Form 2848 to authorize us to represent you before the IRS and access your records.</p>
    </header><!-- Map cards -->
    <div class="grid md:grid-cols-3 gap-4 mb-10">
     <div class="glass-card rounded-xl p-5">
      <div class="flex items-center gap-3 mb-3">
       <div class="gradient-border p-0.5 rounded-lg">
        <div class="bg-slate-800 p-2 rounded-lg">
         <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12a8 8 0 11-16 0 8 8 0 0116 0z" />
         </svg>
        </div>
       </div>
       <h3 class="font-semibold text-white">Action Required From You</h3>
      </div>
      <p class="text-slate-400 text-sm">Electronic signature and identity verification.</p>
     </div>
     <div class="glass-card rounded-xl p-5">
      <div class="flex items-center gap-3 mb-3">
       <div class="gradient-border p-0.5 rounded-lg">
        <div class="bg-slate-800 p-2 rounded-lg">
         <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewbox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg>
        </div>
       </div>
       <h3 class="font-semibold text-white">What This Step Does</h3>
      </div>
      <p class="text-slate-400 text-sm">Authorizes monitoring by granting IRS records access through Form 2848.</p>
     </div>
     <div class="glass-card rounded-xl p-5">
      <div class="flex items-center gap-3 mb-3">
       <div class="gradient-border p-0.5 rounded-lg">
        <div class="bg-slate-800 p-2 rounded-lg">
         <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewbox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 18a. 18z" />
         </svg>
        </div>
       </div>
       <h3 class="font-semibold text-white">What We Do</h3>
      </div>
      <p class="text-slate-400 text-sm">File with IRS, obtain CAF number, begin representation.</p>
     </div>
    </div><!-- Main unified content -->
    <section class="glass-card rounded-2xl px-6 pb-6 pt-4 md:px-8 md:pb-8 md:pt-5 lg:px-10 lg:pb-10 lg:pt-6 w-full">
     <form id="esign-form" class="space-y-8"><!-- Required hidden fields --> <input type="hidden" id="eventId" name="eventId"> <input type="hidden" id="orderId" name="orderId"> <input type="hidden" id="sessionToken" name="sessionToken"> <!-- Form Introduction -->
      <div class="tm-prose">
       <h1 class="text-xl font-semibold text-white mt-0 mb-3">IRS Form 2848 — Power of Attorney</h1>
       <p class="tm-hero-lead text-slate-300 mt-2">This step authorizes us to access IRS records for monitoring.</p>
       <p class="tm-hero-note mt-3">Form 2848 appoints an IRS-authorized representative so we can access and review your IRS records. This authorization is required to deliver Tax Monitoring services.</p>
      </div>
      <p class="text-slate-300">If you are married and filed jointly, <strong class="text-white">each spouse must complete and sign a separate Form 2848</strong>. If you indicated you are married, your spouse will receive a separate invitation to complete and eSign their own authorization.</p>
      <div class="p-4 rounded-lg bg-slate-900/40 border border-white/5">
       <p class="text-sm text-slate-400"><span class="text-amber-300 font-semibold">(Rev. January 2021)</span><br>
         IRS Form 2848 — Power of Attorney and Declaration of Representative<br>
         ▶ Go to <a class="text-amber-400 hover:text-amber-300 underline" href="http://www.irs.gov/Form2848" target="_blank" rel="noopener">www.irs.gov/Form2848</a> for instructions and the latest information.</p>
      </div><!-- Draft & Preview Bar -->
      <div class="tm-draft rounded-xl p-4">
       <div class="flex items-start gap-3 mb-4">
        <div class="mt-0.5">
         <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewbox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a. 0z" />
         </svg>
        </div>
        <div class="flex-1">
         <div class="text-sm font-semibold text-amber-200">
          Draft saving is enabled
         </div>
         <div class="text-xs text-slate-300 mt-1">
          Save your progress and return later. Your response stays on this device.
         </div>
        </div>
       </div>
       <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-3"><button type="button" id="draft-save" class="w-full py-2.5 px-4 rounded-lg font-semibold text-white gradient-btn">Save Draft</button> <button type="button" id="draft-clear" class="w-full py-2.5 px-4 rounded-lg font-semibold text-slate-200 border border-amber-500/30 bg-slate-900/60 hover:bg-slate-900/80 transition">Clear Draft</button>
       </div>
       <div class="text-[11px] text-slate-400" id="draft-status">
        Draft not saved.
       </div>
      </div><!-- Form Preview -->
      <div>
       <h3 class="text-lg font-extrabold text-white mb-3">Form Preview</h3>
       <p class="text-slate-400 text-sm mb-4">Here's what will be used to generate your Form 2848:</p>
       <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6"><!-- Flip Card Preview -->
        <div class="lg:col-span-1">
         <div class="flip-card-controls">
          <button type="button" id="page-1-btn" class="flip-toggle-btn active" aria-pressed="true" aria-label="Show page 1 preview">Page 1</button> <button type="button" id="page-2-btn" class="flip-toggle-btn" aria-pressed="false" aria-label="Show page 2 preview">Page 2</button>
         </div>
         <div class="flip-card-container rounded-lg shadow-lg overflow-hidden" aria-label="Form 2848 preview card, currently showing page 1">
          <div class="flip-card-inner" id="flip-card">
           <!-- Page 1 (Front) -->
           <div class="flip-card-front">
            <span class="flip-card-label">Preview: Page 1</span>
            <svg class="flip-card-svg" viewbox="0 0 210 280" xmlns="http://www.w3.org/2000/svg"><!-- Background --> <rect width="210" height="280" fill="#0f172a" stroke="#64748b" stroke-width="0.5" /> <!-- IRS Header --> <rect width="210" height="16" fill="#1e293b" /> <text x="105" y="12" font-size="8" font-weight="bold" fill="#f59e0b" text-anchor="middle" font-family="Arial">
              DEPARTMENT OF THE TREASURY
             </text> <!-- Form Title --> <text x="105" y="28" font-size="10" font-weight="bold" fill="#f97316" text-anchor="middle" font-family="Arial">
              Form 2848
             </text> <text x="105" y="38" font-size="6" fill="#cbd5e1" text-anchor="middle" font-family="Arial">
              Power of Attorney and Declaration of Representative
             </text> <!-- Section Headers --> <rect x="5" y="46" width="200" height="6" fill="#1e293b" /> <text x="7" y="50" font-size="5" font-weight="bold" fill="#f59e0b" font-family="Arial">
              SECTION 1 — TAXPAYER INFORMATION
             </text> <!-- Taxpayer Info Lines --> <text x="7" y="60" font-size="4.5" fill="#cbd5e1" font-family="Arial">
              Name: _________________ | SSN: ___-__-____
             </text> <text x="7" y="68" font-size="4.5" fill="#cbd5e1" font-family="Arial">
              Address: ________________________________________________
             </text> <text x="7" y="76" font-size="4.5" fill="#cbd5e1" font-family="Arial">
              City, State, ZIP: ____________________________________________
             </text> <!-- Section 2 --> <rect x="5" y="84" width="200" height="6" fill="#1e293b" /> <text x="7" y="88" font-size="5" font-weight="bold" fill="#f59e0b" font-family="Arial">
              SECTION 2 — REPRESENTATIVE INFORMATION
             </text> <!-- Rep Info Lines --> <text x="7" y="98" font-size="4.5" fill="#cbd5e1" font-family="Arial">
              Name: _________________ | PTIN: __________
             </text> <text x="7" y="106" font-size="4.5" fill="#cbd5e1" font-family="Arial">
              Address: ________________________________________________
             </text> <text x="7" y="114" font-size="4.5" fill="#cbd5e1" font-family="Arial">
              Phone: ________________________ Fax: _____________________
             </text> <!-- Section 3 --> <rect x="5" y="122" width="200" height="6" fill="#1e293b" /> <text x="7" y="126" font-size="5" font-weight="bold" fill="#f59e0b" font-family="Arial">
              SECTION 3 — TAX MATTERS
             </text> <!-- Tax Info --> <text x="7" y="136" font-size="4.5" fill="#cbd5e1" font-family="Arial">
              Tax Type: _______________ Form(s): __________
             </text> <text x="7" y="144" font-size="4.5" fill="#cbd5e1" font-family="Arial">
              Years: ________________________________________________
             </text> <!-- Section 5 --> <rect x="5" y="152" width="200" height="6" fill="#1e293b" /> <text x="7" y="156" font-size="5" font-weight="bold" fill="#f59e0b" font-family="Arial">
              SECTION 5 — ADDITIONAL ACTS
             </text> <!-- Checkboxes --> <rect x="7" y="162" width="3" height="3" fill="none" stroke="#94a3b8" /> <text x="12" y="165" font-size="4" fill="#cbd5e1" font-family="Arial">
              Sign and file returns
             </text> <rect x="7" y="172" width="3" height="3" fill="none" stroke="#94a3b8" /> <text x="12" y="175" font-size="4" fill="#cbd5e1" font-family="Arial">
              Represent at appeals
             </text> <rect x="7" y="182" width="3" height="3" fill="none" stroke="#94a3b8" /> <text x="12" y="185" font-size="4" fill="#cbd5e1" font-family="Arial">
              Obtain records and documents
             </text> <!-- Signature Section --> <rect x="5" y="194" width="200" height="6" fill="#1e293b" /> <text x="7" y="198" font-size="5" font-weight="bold" fill="#f59e0b" font-family="Arial">
              SECTION 7 — SIGNATURE
             </text> <!-- Sig Line --> <line x1="7" y1="220" x2="90" y2="220" stroke="#94a3b8" stroke-width="0.5" /> <text x="8" y="226" font-size="4" fill="#64748b" font-family="Arial">
              Taxpayer Signature
             </text> <line x1="120" y1="220" x2="203" y2="220" stroke="#94a3b8" stroke-width="0.5" /> <text x="121" y="226" font-size="4" fill="#64748b" font-family="Arial">
              Date
             </text> <!-- Footer --> <text x="105" y="270" font-size="4" fill="#64748b" text-anchor="middle" font-family="Arial">
              (Rev. January 2021)
             </text>
            </svg>
           </div><!-- Page 2 (Back) -->
           <div class="flip-card-back">
            <span class="flip-card-label">Preview: Page 2</span>
            <svg class="flip-card-svg" viewbox="0 0 210 280" xmlns="http://www.w3.org/2000/svg"><!-- Background --> <rect width="210" height="280" fill="#0f172a" stroke="#64748b" stroke-width="0.5" /> <!-- IRS Header --> <rect width="210" height="16" fill="#1e293b" /> <text x="105" y="12" font-size="8" font-weight="bold" fill="#f59e0b" text-anchor="middle" font-family="Arial">
              FORM 2848 — PAGE 2
             </text> <!-- Part II: Representative Declaration --> <rect x="5" y="24" width="200" height="6" fill="#1e293b" /> <text x="7" y="28" font-size="5" font-weight="bold" fill="#f59e0b" font-family="Arial">
              PART II — REPRESENTATIVE DECLARATION
             </text> <!-- Rep Declaration Text --> <text x="7" y="38" font-size="4.5" fill="#cbd5e1" font-family="Arial">
              I declare that I am the individual described above and authorized
             </text> <text x="7" y="45" font-size="4.5" fill="#cbd5e1" font-family="Arial">
              to represent the taxpayer indicated on Page 1 before the IRS.
             </text> <!-- Rep Signature Section --> <rect x="5" y="56" width="200" height="6" fill="#1e293b" /> <text x="7" y="60" font-size="5" font-weight="bold" fill="#f59e0b" font-family="Arial">
              REPRESENTATIVE SIGNATURE &amp; DATE
             </text> <!-- Signature lines --> <line x1="7" y1="75" x2="100" y2="75" stroke="#94a3b8" stroke-width="0.5" /> <text x="8" y="81" font-size="4" fill="#64748b" font-family="Arial">
              Representative Signature
             </text> <line x1="110" y1="75" x2="203" y2="75" stroke="#94a3b8" stroke-width="0.5" /> <text x="111" y="81" font-size="4" fill="#64748b" font-family="Arial">
              Date
             </text> <!-- Part III: CAF Info --> <rect x="5" y="94" width="200" height="6" fill="#1e293b" /> <text x="7" y="98" font-size="5" font-weight="bold" fill="#f59e0b" font-family="Arial">
              PART III — CENTRALIZED AUTHORIZATION FILE (CAF)
             </text> <!-- CAF Number --> <text x="7" y="108" font-size="4.5" fill="#cbd5e1" font-family="Arial">
              CAF Number: ________________________
             </text> <text x="7" y="116" font-size="4.5" fill="#cbd5e1" font-family="Arial">
              (Assigned by IRS; leave blank if unknown)
             </text> <!-- Instructions box --> <rect x="5" y="130" width="200" height="60" fill="rgba(30, 41, 59, 0.4)" stroke="#64748b" stroke-width="0.5" /> <text x="8" y="140" font-size="4.5" font-weight="bold" fill="#f59e0b" font-family="Arial">
              INSTRUCTIONS:
             </text> <text x="8" y="148" font-size="4" fill="#cbd5e1" font-family="Arial">
              1. Both taxpayer and representative must sign and date
             </text> <text x="8" y="154" font-size="4" fill="#cbd5e1" font-family="Arial">
              2. Attach Form 2848-D if needed (2+ representatives)
             </text> <text x="8" y="160" font-size="4" fill="#cbd5e1" font-family="Arial">
              3. File with your tax return or separately with the IRS
             </text> <text x="8" y="166" font-size="4" fill="#cbd5e1" font-family="Arial">
              4. Keep a copy for your records
             </text> <text x="8" y="172" font-size="4" fill="#cbd5e1" font-family="Arial">
              5. Effective from date of signature through revocation
             </text> <text x="8" y="184" font-size="3.5" fill="#94a3b8" font-family="Arial">
              For more information, visit www.irs.gov/Form2848
             </text>
            </svg>
           </div>
          </div>
         </div>
        </div><!-- Info Grid -->
        <div class="lg:col-span-2 tm-kv grid-cols-1">
         <div class="tm-kv-item">
          <div class="tm-kv-k">
           Date
          </div>
          <div class="tm-kv-v" id="pv-date">
           <span class="tm-muted">Auto</span>
          </div>
         </div>
         <div class="tm-kv-item">
          <div class="tm-kv-k">
           Signature
          </div>
          <div class="tm-kv-v" id="pv-signature">
           <span class="tm-muted">Pending</span>
          </div>
         </div>
         <div class="tm-kv-item">
          <div class="tm-kv-k">
           Taxpayer Info
          </div>
          <div class="tm-kv-v" id="pv-taxpayer">
           <span class="tm-muted">From your account</span>
          </div>
         </div>
         <div class="tm-kv-item">
          <div class="tm-kv-k">
           Representative Info
          </div>
          <div class="tm-kv-v" id="pv-rep">
           <span class="tm-muted">From Tax Monitor Pro</span>
          </div>
         </div>
         <div class="tm-kv-item">
          <div class="tm-kv-k">
           Tax Matters
          </div>
          <div class="tm-kv-v" id="pv-matters">
           <span class="tm-muted">Income tax monitoring years</span>
          </div>
         </div>
        </div>
       </div>
      </div><!-- Section 1 — Taxpayer Information (EDITABLE FORM) -->
      <div class="form-section-divider">
       <div class="tm-prose mb-6">
        <h3>Section 1 — Taxpayer Information</h3>
  <p>
    This section includes your name, address, and taxpayer identification number. Your signature and date appear on page 2, line 7. We will facilitate your e-signature. 
    <span class="text-slate-300">This information must match IRS records, so verify each field carefully before proceeding.</span>
  </p>
</div>
       <h4 class="text-base font-bold text-white mb-4 uppercase tracking-wide">Edit Your Information</h4><!-- Row 1a/1b/1c: Name fields on one row -->
       <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
        <div>
         <label class="block text-xs font-semibold text-slate-300 mb-2"><span class="text-amber-400">1a.</span> Last Name</label>
         <input type="text" id="form-taxpayer-lastname" placeholder="Last name" class="w-full">
        </div>
        <div>
         <label class="block text-xs font-semibold text-slate-300 mb-2"><span class="text-amber-400">1b.</span> First Name</label>
         <input type="text" id="form-taxpayer-firstname" placeholder="First name" class="w-full">
        </div>
        <div>
         <label class="block text-xs font-semibold text-slate-300 mb-2"><span class="text-amber-400">1c.</span> Middle Initial (optional)</label>
         <input type="text" id="form-taxpayer-middleinitial" placeholder="M.I." maxlength="1" class="w-full">
        </div>
       </div>

       <!-- Row 2: Address -->
       <div class="mb-4"><label class="block text-xs font-semibold text-slate-300 mb-2"><span class="text-amber-400">2.</span> Address (number, street, and apt. or suite number)</label> <input type="text" id="form-taxpayer-address" placeholder="123 Main Street, Apt 4B" class="w-full">
       </div><!-- Row 3: City, State, ZIP -->
       <div class="grid grid-cols-3 gap-2 mb-4">
        <div><label class="block text-xs font-semibold text-slate-300 mb-2">City</label> <input type="text" id="form-taxpayer-city" placeholder="City" class="w-full">
        </div>
        <div><label class="block text-xs font-semibold text-slate-300 mb-2">State</label> <input type="text" id="form-taxpayer-state" placeholder="CA" maxlength="2" class="w-full">
        </div>
        <div><label class="block text-xs font-semibold text-slate-300 mb-2">ZIP</label> <input type="text" id="form-taxpayer-zip" placeholder="12345" class="w-full">
        </div>
       </div><!-- Row 4: SSN/ITIN with toggle -->
       <div class="mb-4"><label class="block text-xs font-semibold text-slate-300 mb-2"> <span class="text-amber-400">4.</span> Taxpayer Identification Number (SSN or ITIN) <button type="button" id="toggle-ssn" class="text-amber-400 hover:text-amber-300 text-[10px] ml-2">Show</button> </label> <input type="text" id="form-taxpayer-id" placeholder="•••-••-1234" class="w-full">
        <p class="text-[10px] text-slate-500 mt-1">Format: XXX-XX-XXXX</p>
       </div><!-- Row 5: Daytime Phone -->
       <div class="mb-4"><label class="block text-xs font-semibold text-slate-300 mb-2"><span class="text-amber-400">5.</span> Daytime Telephone Number</label> <input type="tel" id="form-taxpayer-phone" placeholder="(555) 123-4567" class="w-full">
        <p class="text-[10px] text-slate-500 mt-1">Optional: Email address can be provided below</p>
       </div><!-- Row 6: Email (optional) -->
       <div><label class="block text-xs font-semibold text-slate-300 mb-2"><span class="text-amber-400">6.</span> Email Address (optional)</label> <input type="email" id="form-taxpayer-email" placeholder="you@example.com" class="w-full">
       </div><!-- Form guidance note -->
       
      </div><!-- Section 2 — Representative Information (READ-ONLY) -->
<div class="form-section-divider">
  <div class="tm-prose mb-6">
    <h3>Section 2 — Representative Information</h3>
    <p>This section appoints your representative(s). Our team will sign and date the representative portion on page 2, Part II.</p>
    
  </div>

  <h4 class="text-base font-bold text-white mb-4 uppercase tracking-wide">Representative Information (Provided by Tax Monitor Pro)</h4>

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    <div class="tm-kv-item">
      <div class="tm-kv-k">Representative Name and Address</div>
      <div class="tm-kv-v" id="rep-ro-nameAddress"><span class="tm-muted">Provided by Tax Monitor Pro</span></div>
    </div>

    <div class="tm-kv-item">
      <div class="tm-kv-k">Representative ID</div>
      <div class="tm-kv-v" id="rep-ro-id"><span class="tm-muted">Provided by Tax Monitor Pro</span></div>
    </div>

    <div class="tm-kv-item">
      <div class="tm-kv-k">Daytime Phone</div>
      <div class="tm-kv-v" id="rep-ro-phone"><span class="tm-muted">Provided by Tax Monitor Pro</span></div>
    </div>

    <div class="tm-kv-item">
      <div class="tm-kv-k">Email</div>
      <div class="tm-kv-v" id="rep-ro-email"><span class="tm-muted">Optional</span></div>
    </div>

    <div class="tm-kv-item sm:col-span-2">
      <div class="tm-kv-k">Fax</div>
      <div class="tm-kv-v" id="rep-ro-fax"><span class="tm-muted">Optional</span></div>
    </div>
  </div>

  
</div>

<!-- Section 3 — Tax Matters and Years -->
      <div class="form-section-divider">
       <div class="tm-prose mb-6">
        <h3>Section 3 — Tax Matters and Years</h3>
        <p>This section defines what the authorization covers, including tax type, form number, and tax years or periods. For Tax Monitoring, we request access aligned to the income tax years required to produce your monitoring report.</p>
        
       </div>
       <h4 class="text-base font-bold text-white mb-4 uppercase tracking-wide">Edit Tax Matters</h4><!-- Row 3a: Tax Type -->
       <div class="mb-4"><label class="block text-xs font-semibold text-slate-300 mb-2"><span class="text-amber-400">3a.</span> Tax Type</label> <input type="text" id="form-tax-type" placeholder="e.g., Income Tax" class="w-full">
       </div><!-- Row 3b: Form Number -->
       <div class="mb-4"><label class="block text-xs font-semibold text-slate-300 mb-2"><span class="text-amber-400">3b.</span> Form Number(s)</label> <input type="text" id="form-tax-form" placeholder="e.g., Form 1040" class="w-full">
       </div><!-- Row 3c: Tax Years -->
       <div><label class="block text-xs font-semibold text-slate-300 mb-2"><span class="text-amber-400">3c.</span> Tax Years or Periods</label> <input type="text" id="form-tax-years" placeholder="e.g., 2022, 2023, 2024" class="w-full">
       </div>
       
      </div><!-- Section 4 — Specific Use Not Recorded on CAF -->
      <div class="form-section-divider">
       <div class="tm-prose mb-6">
        <h3>Section 4 — Specific Use Not Recorded on CAF</h3>
        <p>This section is used only when the authorization is for a purpose <span class="text-slate-300">not recorded</span> on the Centralized Authorization File (CAF). For Tax Monitor Pro monitoring, this section is not used and will remain blank.</p>
       </div>

       <h4 class="text-base font-bold text-white mb-4 uppercase tracking-wide">Specific Use (Not Applicable)</h4>

       <div class="mt-3 p-3 rounded-lg bg-slate-900/40 border border-white/5">
        <p class="text-sm text-slate-300">This section is not used for your monitoring authorization and will remain blank.</p>
       </div>

       <div class="mt-4">
        <label class="block text-xs font-semibold text-slate-300 mb-2"><span class="text-amber-400">4.</span> Specific Use</label>
        <textarea id="form-specific-use" class="w-full min-h-[96px] bg-slate-900/40 border border-white/10 rounded-xl px-4 py-3 text-slate-200 placeholder:text-slate-500 focus:outline-none focus:border-amber-500/40" placeholder="(Not applicable for monitoring)" readonly></textarea>
        <p class="text-[11px] text-slate-500 mt-1"></p>
       </div>
      </div>

      <!-- Section 5 — Additional Acts Authorized -->
      <div class="form-section-divider">
       <div class="tm-prose mb-6">
        <h3>Section 5 — Additional Acts Authorized</h3>
        <p>This section lists permissions beyond standard representation. For monitoring delivery, we include only the limited permissions necessary to obtain and access IRS records and coordinate processing. For monitoring services, only record retrieval authority is authorized, and signing returns or appeals representation is not included.</p>
       </div>

       <h4 class="text-base font-bold text-white mb-4 uppercase tracking-wide">Additional Acts Authorized (Read-Only)</h4>

       <div class="grid grid-cols-1 gap-3">
        <label class="flex items-start gap-3 p-3 rounded-xl border border-white/10 bg-slate-900/40">
         <input type="checkbox" id="form-acts-sign" disabled class="mt-1" />
         <span>
          <span class="font-medium text-slate-200">Sign and file returns</span>
          <span class="block text-sm text-slate-400 mt-1">Authority to sign and file tax returns on your behalf.</span>
         </span>
        </label>

        <label class="flex items-start gap-3 p-3 rounded-xl border border-white/10 bg-slate-900/40">
         <input type="checkbox" id="form-acts-appeal" disabled class="mt-1" />
         <span>
          <span class="font-medium text-slate-200">Represent at appeals</span>
          <span class="block text-sm text-slate-400 mt-1">Authority to represent you in appeals before the IRS.</span>
         </span>
        </label>

        <label class="flex items-start gap-3 p-3 rounded-xl border border-white/10 bg-slate-900/40">
         <input type="checkbox" id="form-acts-records" checked disabled class="mt-1" />
         <span>
          <span class="font-medium text-slate-200">Obtain records and documents</span>
          <span class="block text-sm text-slate-400 mt-1">Authority to obtain and access IRS records and documents.</span>
         </span>
        </label>
       </div>

       
      </div>

      <!-- Section 6 — Retention/Revocation of Prior Power of Attorney -->
      <div class="form-section-divider">
       <div class="tm-prose mb-6">
        <h3>Section 6 — Retention/Revocation of Prior Power of Attorney</h3>
        <p>This section determines how prior authorizations are treated. For Tax Monitor Pro monitoring, existing representatives remain in place and this authorization is added.</p>
       </div>

       <h4 class="text-base font-bold text-white mb-4 uppercase tracking-wide">Prior Power of Attorney Handling (Read-Only)</h4>

       <div class="grid grid-cols-1 gap-3">
        <label class="flex items-start gap-3 p-3 rounded-xl border border-white/10 bg-slate-900/40">
         <input type="radio" name="priorPoaHandling" value="revoke" id="prior-poa-revoke" disabled class="mt-1" />
         <span>
          <span class="font-medium text-slate-200">Revoke all prior representations</span>
          <span class="block text-sm text-slate-400 mt-1">This new authorization replaces all prior POAs for these matters and years.</span>
         </span>
        </label>

        <label class="flex items-start gap-3 p-3 rounded-xl border border-white/10 bg-slate-900/40">
         <input type="radio" name="priorPoaHandling" value="retain" id="prior-poa-retain" checked disabled class="mt-1 accent-white scale-110" />
         <span>
          <span class="font-medium text-slate-200">Retain prior representations</span>
          <span class="block text-sm text-slate-400 mt-1">Keep existing representatives and add this new authorization.</span>
         </span>
        </label>
       </div>

       <div class="mt-4">
        <label class="block text-xs font-semibold text-slate-300 mb-2"><span class="text-amber-400">6.</span> List any prior representatives you want to retain</label>
        <textarea id="form-prior-reps" class="w-full min-h-[96px] bg-slate-900/40 border border-white/10 rounded-xl px-4 py-3 text-slate-200 placeholder:text-slate-500 focus:outline-none focus:border-amber-500/40" placeholder="Optional" readonly></textarea>
        <p class="text-[11px] text-slate-500 mt-1">This monitoring authorization is added without revoking prior representatives.</p>
       </div>

       <div class="mt-4 p-3 rounded-lg bg-slate-900/40 border border-white/5">
        <p class="text-[11px] text-slate-400">Existing authorizations remain active. This monitoring authorization is added without revoking prior representatives.</p>
       </div>
      </div>

      <!-- Section 7 — Signature -->
      <div class="form-section-divider">
       <div class="tm-prose">
        <h3>Section 7 — Signature</h3>
        <p>You must sign and date the form. If you filed jointly, both spouses must sign their own separate Form 2848 authorizations.</p>
       </div>
      </div><!-- Generate PDF Panel -->
      <div class="glass-card rounded-xl p-4 border-l-4 border-amber-500/50">
       <h3 class="text-sm font-bold text-white uppercase tracking-wide mb-2">Generate Form 2848 (Page 1)</h3>
       <p class="text-xs text-slate-400 mb-4">Downloads a PDF using your saved account details so you can review before e-signing.</p><button type="button" id="generate-pdf-btn" class="w-full py-3 px-4 rounded-lg font-semibold text-white bg-amber-600 hover:bg-amber-700 transition flex items-center justify-center gap-2 mb-3">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 16v-4m0 0V8m0 4H8m4 0h4" />
        </svg><span id="pdf-btn-text">Generate PDF</span> </button>
       <div class="text-xs text-slate-400"><span class="status-dot ready" id="pdf-status-dot"></span> <span id="pdf-status-text">Ready</span>
       </div>
      </div><!-- Electronic Signature Section -->
      <div class="form-section-divider">
       <h3 class="text-lg font-extrabold text-white mb-4 uppercase tracking-wide">Your Electronic Signature</h3>
       <p class="text-slate-400 text-sm mb-6">Complete your e-signature to authorize this form:</p>
       <div class="space-y-4">
        <div><label for="signature-name" class="block text-xs font-semibold text-slate-300 mb-2">Full Legal Name (required)</label> <input type="text" id="signature-name" name="signature-name" placeholder="Type your full legal name exactly as shown above" class="w-full">
         <p class="text-[11px] text-slate-500 mt-1">Type your full legal name exactly as shown above.</p>
        </div>
        <div><label for="signature-date" class="block text-xs font-semibold text-slate-300 mb-2">Date (auto-filled)</label> <input type="date" id="signature-date" name="signature-date" readonly class="w-full bg-slate-800/50 border border-white/5">
        </div><label class="flex items-start gap-3 p-3 rounded-lg border border-white/10 bg-slate-900/40 hover:bg-slate-900/55 transition cursor-pointer"> <input type="checkbox" id="consent-checkbox" name="consent-checkbox" class="mt-1"> <span class="text-xs leading-relaxed"> <span class="text-white font-semibold">I consent to use of an electronic signature</span> <span class="block text-slate-400 mt-1">I consent to use of an electronic signature and confirm the taxpayer information above is accurate.</span> </span> </label>
       </div>
      </div><!-- Ready to eSign Radio -->
      <div><label class="block text-sm font-bold text-white uppercase tracking-wide mb-3">Ready to eSign (required)</label>
       <div class="space-y-2"><label class="flex items-start gap-3 p-3 rounded-xl border border-white/10 bg-slate-900/40 hover:bg-slate-900/55 transition cursor-pointer"> <input type="radio" name="monitoringAuthorizationStatus" value="ready" class="mt-1" required> <span> <span class="font-semibold text-white">Yes, I'm ready to eSign</span> <span class="block text-xs text-slate-400 mt-1">Submitting will generate your Form 2848 and start the e-sign step.</span> </span> </label> <label class="flex items-start gap-3 p-3 rounded-xl border border-white/10 bg-slate-900/40 hover:bg-slate-900/55 transition cursor-pointer"> <input type="radio" name="monitoringAuthorizationStatus" value="not_ready" class="mt-1" required> <span> <span class="font-semibold text-white">Not yet</span> <span class="block text-xs text-slate-400 mt-1">Save a draft now and come back when you're ready.</span> </span> </label>
       </div>
      </div><!-- Action Buttons -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-4 border-t border-white/10"><button type="submit" id="submit-btn" class="gradient-btn w-full py-4 px-6 rounded-xl font-semibold text-white text-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2"> <span id="submit-text">Complete eSign 2848</span>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
        </svg></button> <a href="/app/pages/projects.html" class="w-full py-4 px-6 rounded-xl font-semibold text-slate-200 text-lg border border-amber-500/30 bg-slate-900/60 hover:bg-slate-900/80 transition flex items-center justify-center gap-2"> View Timeline 
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a. 0z" />
        </svg></a> <a href="/app/pages/files.html" class="sm:col-span-2 w-full py-3 px-6 rounded-xl font-semibold text-slate-200 border border-white/10 bg-slate-900/35 hover:bg-slate-900/50 transition flex items-center justify-center gap-2"> View Files 
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z" />
        </svg></a>
      </div><!-- Status messages -->
      <div id="success" class="hidden mt-3 rounded-xl border border-green-500/25 bg-green-500/10 p-4 text-center">
       <h4 class="font-extrabold text-white">Submission Received</h4>
       <p class="text-slate-200 text-sm mt-1">Thank you. Your authorization step has been recorded.</p>
       <p class="text-slate-200 text-sm mt-2">Please hold while the page reloads.</p>
      </div>
      <div id="error" class="hidden mt-3 rounded-xl border border-red-500/25 bg-red-500/10 p-4">
       <div class="font-bold">
        Couldn't save your authorization.
       </div>
       <div class="text-sm text-slate-200 mt-1" id="error-msg">
        Please try again.
       </div>
      </div>
     </form>
    </section><!-- Footer -->
    <footer class="text-center text-slate-500 text-sm mt-10 pb-8">
     <div class="flex items-center justify-center gap-4"><span class="flex items-center gap-1">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
       </svg> Secure </span> <span>•</span> <span>Confidential</span> <span>•</span> <span>Professional</span>
     </div>
    </footer><!-- Toasts -->
    <div id="toast" class="fixed bottom-6 right-6 z-50 tm-toast rounded-xl px-5 py-4 shadow-lg border border-white/10 bg-slate-950/80 backdrop-blur">
     <div class="flex items-start gap-3">
      <div class="mt-0.5" id="toast-icon"></div>
      <div>
       <div class="font-bold" id="toast-title">
        Saved
       </div>
       <div class="text-sm text-slate-300" id="toast-body">
        Draft saved.
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Flip card functionality
    const flipCard = document.getElementById('flip-card');
    const page1Btn = document.getElementById('page-1-btn');
    const page2Btn = document.getElementById('page-2-btn');

    let isFlipped = false;

    function toggleFlip() {
      isFlipped = !isFlipped;
      flipCard.classList.toggle('flipped', isFlipped);

      // Update button states
      page1Btn.classList.toggle('active', !isFlipped);
      page1Btn.setAttribute('aria-pressed', !isFlipped);
      page2Btn.classList.toggle('active', isFlipped);
      page2Btn.setAttribute('aria-pressed', isFlipped);
    }

    page1Btn.addEventListener('click', () => {
      if (isFlipped) toggleFlip();
    });

    page2Btn.addEventListener('click', () => {
      if (!isFlipped) toggleFlip();
    });

    // Keyboard support for flip buttons
    page1Btn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (isFlipped) toggleFlip();
      }
    });

    page2Btn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (!isFlipped) toggleFlip();
      }
    });

    const API_BASE = 'https://api.taxmonitor.pro';
    const ESIGN_2848_ENDPOINT = `${API_BASE}/forms/post-payment/esign-2848`;
    const TEMPLATE_PDF_PATH = '/assets/forms/f2848.pdf';

    // State from R2 render
    const renderState = window.TM_RENDER_STATE || window.__TM_RENDER_STATE__ || window.tmRenderState || {
      taxpayerName: 'Jane Smith',
      taxpayerFirstName: 'Jane',
      taxpayerLastName: 'Smith',
      taxpayerAddress: '123 Main Street',
      taxpayerCityStateZip: 'Anytown, CA 12345',
      taxpayerSSN: '123-45-6789',
      taxpayerPhone: '(555) 123-4567',
      repName: 'Tax Monitor Pro, Inc.',
      taxMatters: 'Income Tax - Form 1040',
      taxYears: '2023, 2024'
    };

    const tmCommon = {
      ensureEventId: () => (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
      getQuery: (k) => {
        const v = new URLSearchParams(location.search).get(k);
        return v ? String(v).trim() : '';
      },
      syncSessionToken: () => {
        const q = tmCommon.getQuery('sessionToken');
        if (q) {
          try { sessionStorage.setItem('tm_sessionToken', q); } catch (_) {}
          return q;
        }
        try { return sessionStorage.getItem('tm_sessionToken') || ''; } catch (_) { return ''; }
      }
    };

    function qsKeep() {
      return location.search || '';
    }

    function todayLabel() {
      const d = new Date();
      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function todayISO() {
      const d = new Date();
      return d.toISOString().split('T')[0];
    }

    function maskSSN(ssn) {
      const clean = String(ssn || '').replace(/\D/g, '');
      if (clean.length < 4) return '••••••••••••';
      return '•••-••-' + clean.slice(-4);
    }

    function toast(type, title, body) {
      const el = document.getElementById('toast');
      const icon = document.getElementById('toast-icon');
      const t = document.getElementById('toast-title');
      const b = document.getElementById('toast-body');

      const okSvg = '<svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
      const warnSvg = '<svg class="w-6 h-6 text-amber-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4v2m-6-4v6a2 2 0 002 2h8a2 2 0 002-2v-6m-12 0V5a2 2 0 012-2h8a2 2 0 012 2v6"/></svg>';
      const errSvg = '<svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';

      icon.innerHTML = type === 'error' ? errSvg : (type === 'warn' ? warnSvg : okSvg);
      t.textContent = title || '';
      b.textContent = body || '';

      el.classList.add('show');
      window.clearTimeout(window.__tmToastTimer);
      window.__tmToastTimer = window.setTimeout(() => el.classList.remove('show'), 2600);
    }

    function draftKey(orderId) {
      const k = String(orderId || '').trim();
      return `tm_draft_esign_2848_${k || 'no_order'}`;
    }

    function setDraftStatus(msg) {
      const el = document.getElementById('draft-status');
      if (el) el.textContent = msg;
    }

    function setPdfStatus(state) {
      const dot = document.getElementById('pdf-status-dot');
      const text = document.getElementById('pdf-status-text');
      const btn = document.getElementById('generate-pdf-btn');

      dot.className = 'status-dot ' + state;
      btn.disabled = state !== 'ready';

      if (state === 'ready') {
        text.textContent = 'Ready';
        document.getElementById('pdf-btn-text').textContent = 'Generate PDF';
      } else if (state === 'generating') {
        text.textContent = 'Generating…';
        document.getElementById('pdf-btn-text').textContent = 'Generating…';
      } else if (state === 'success') {
        text.textContent = 'PDF generated';
        document.getElementById('pdf-btn-text').textContent = 'Download PDF';
      } else if (state === 'error') {
        text.textContent = 'Error generating PDF';
        document.getElementById('pdf-btn-text').textContent = 'Try again';
      }
    }

    async function generatePDF() {
      setPdfStatus('generating');

      try {
        const response = await fetch(TEMPLATE_PDF_PATH);
        if (!response.ok) throw new Error('Failed to load template');

        const arrayBuffer = await response.arrayBuffer();
        const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
        const page = pdfDoc.getPage(0);
        const { width, height } = page.getSize();

        const name = renderState.taxpayerName || 'Jane Smith';
        const firstName = renderState.taxpayerFirstName || 'Jane';
        const lastName = renderState.taxpayerLastName || 'Smith';
        const address = renderState.taxpayerAddress || '123 Main Street';
        const cityStateZip = renderState.taxpayerCityStateZip || 'Anytown, CA 12345';
        const ssn = renderState.taxpayerSSN || '123-45-6789';
        const phone = renderState.taxpayerPhone || '(555) 123-4567';
        const repName = renderState.repName || 'Tax Monitor Pro, Inc.';
        const taxMatters = renderState.taxMatters || 'Income Tax - Form 1040';
        const taxYears = renderState.taxYears || '2023, 2024';

        page.drawText(lastName, { x: 50, y: height - 150, size: 12, color: PDFLib.rgb(0, 0, 0) });
        page.drawText(firstName, { x: 150, y: height - 150, size: 12, color: PDFLib.rgb(0, 0, 0) });
        page.drawText(address, { x: 50, y: height - 180, size: 12, color: PDFLib.rgb(0, 0, 0) });
        page.drawText(cityStateZip, { x: 50, y: height - 210, size: 12, color: PDFLib.rgb(0, 0, 0) });
        page.drawText(repName, { x: 50, y: height - 280, size: 12, color: PDFLib.rgb(0, 0, 0) });

        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'Form_2848.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        setPdfStatus('success');
        toast('ok', 'PDF Generated', 'Your Form 2848 is ready to download.');

        setTimeout(() => setPdfStatus('ready'), 3000);
      } catch (err) {
        console.error('PDF generation error:', err);
        setPdfStatus('error');
        toast('error', 'Generation Failed', 'Could not generate PDF. Please try again.');
        setTimeout(() => setPdfStatus('ready'), 3000);
      }
    }

    document.getElementById('generate-pdf-btn').addEventListener('click', generatePDF);

    // Form field initialization and draft management
    function initForm() {
      document.getElementById('signature-date').valueAsDate = new Date();

      const orderId = tmCommon.getQuery('orderId') || 'default';
      const dk = draftKey(orderId);

      // Load draft if available
      try {
        const draft = JSON.parse(localStorage.getItem(dk) || '{}');
        if (draft && Object.keys(draft).length > 0) {
          Object.keys(draft).forEach((key) => {
            const el = document.getElementById(key);
            if (el) {
              if (el.type === 'checkbox' || el.type === 'radio') {
                el.checked = draft[key];
              } else {
                el.value = draft[key];
              }
            }
          });
          setDraftStatus('Draft loaded from your device.');
        }
      } catch (_) {}

      // Force-lock Section 3 values (always win, even after draft load)
      (function lockSection3() {
        const taxType = 'Income, Employment, Payroll, Excise, Estate, Gift, Civil Penalty, Sec. 4980H Shared Responsibility Payment';
        const forms = '940, 941, 720, 1040, 1120, 1120S';
        const years = '2016 - 2025';

        const taxTypeInput = document.getElementById('form-tax-type');
        const formsTaxInput = document.getElementById('form-tax-form');
        const taxYearsInput = document.getElementById('form-tax-years');

        if (taxTypeInput) {
          taxTypeInput.value = taxType;
          taxTypeInput.readOnly = true;
        }
        if (formsTaxInput) {
          formsTaxInput.value = forms;
          formsTaxInput.readOnly = true;
        }
        if (taxYearsInput) {
          taxYearsInput.value = years;
          taxYearsInput.readOnly = true;
        }

        const pvMatters = document.getElementById('pv-matters');
        if (pvMatters) pvMatters.textContent = `${taxType} • Forms: ${forms} • Years: ${years}`;
      })();
    }

    document.getElementById('draft-save').addEventListener('click', () => {
      const orderId = tmCommon.getQuery('orderId') || 'default';
      const dk = draftKey(orderId);

      const fieldIds = [
        'form-taxpayer-lastname', 'form-taxpayer-firstname', 'form-taxpayer-middleinitial',
        'form-taxpayer-address', 'form-taxpayer-city', 'form-taxpayer-state', 'form-taxpayer-zip',
        'form-taxpayer-id', 'form-taxpayer-phone', 'form-taxpayer-email',
        'form-rep-name', 'form-rep-title', 'form-rep-address', 'form-rep-city', 'form-rep-state',
        'form-rep-zip', 'form-rep-id', 'form-rep-phone', 'form-rep-fax', 'form-rep-email',
        'form-specific-use',
        'form-acts-sign', 'form-acts-appeal', 'form-acts-records',
        'form-prior-reps', 'signature-name', 'consent-checkbox'
      ];

      const draft = {};
      fieldIds.forEach((id) => {
        const el = document.getElementById(id);
        if (el) {
          draft[id] = (el.type === 'checkbox' || el.type === 'radio') ? el.checked : el.value;
        }
      });

      try {
        localStorage.setItem(dk, JSON.stringify(draft));
        setDraftStatus(`Draft saved at ${new Date().toLocaleTimeString()}.`);
        toast('ok', 'Draft Saved', 'Your progress has been saved to this device.');
      } catch (err) {
        setDraftStatus('Error saving draft.');
        toast('error', 'Save Failed', 'Could not save draft to this device.');
      }
    });

    document.getElementById('draft-clear').addEventListener('click', () => {
      if (confirm('Clear your draft? This cannot be undone.')) {
        const orderId = tmCommon.getQuery('orderId') || 'default';
        const dk = draftKey(orderId);
        try {
          localStorage.removeItem(dk);
          setDraftStatus('Draft cleared.');
          location.reload();
        } catch (_) {
          setDraftStatus('Error clearing draft.');
        }
      }
    });

    document.getElementById('esign-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const ready = document.querySelector('input[name="monitoringAuthorizationStatus"]:checked');
      if (!ready || ready.value !== 'ready') {
        toast('warn', 'Not Ready', 'Please confirm you are ready to eSign.');
        return;
      }

      if (!document.getElementById('consent-checkbox').checked) {
        toast('warn', 'Consent Required', 'Please consent to electronic signature.');
        return;
      }

      const sigName = document.getElementById('signature-name').value.trim();
      if (!sigName) {
        toast('warn', 'Name Required', 'Please enter your full legal name.');
        return;
      }

      const btn = document.getElementById('submit-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Processing…';

      try {
        const payload = {
          eventId: document.getElementById('eventId').value || tmCommon.ensureEventId(),
          orderId: tmCommon.getQuery('orderId') || '',
          sessionToken: tmCommon.syncSessionToken(),
          taxpayerName: `${document.getElementById('form-taxpayer-firstname').value} ${document.getElementById('form-taxpayer-lastname').value}`,
          taxpayerAddress: document.getElementById('form-taxpayer-address').value,
          taxpayerPhone: document.getElementById('form-taxpayer-phone').value,
          taxpayerId: document.getElementById('form-taxpayer-id').value,
          signatureName: sigName,
          signatureDate: document.getElementById('signature-date').value,
          consentElectronicSignature: true
        };

        const response = await fetch(ESIGN_2848_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(errorData.error || `Server error: ${response.status}`);
        }

        document.getElementById('success').classList.remove('hidden');
        document.getElementById('error').classList.add('hidden');

        const dk = draftKey(tmCommon.getQuery('orderId') || 'default');
        try { localStorage.removeItem(dk); } catch (_) {}

        setTimeout(() => {
          window.location.href = `/app/pages/projects.html${qsKeep()}`;
        }, 2000);
      } catch (err) {
        console.error('Submission error:', err);
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('error-msg').textContent = err.message || 'An error occurred. Please try again.';
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });

    // SSN toggle
    document.getElementById('toggle-ssn').addEventListener('click', (e) => {
      e.preventDefault();
      const input = document.getElementById('form-taxpayer-id');
      const btn = e.target;
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'Hide';
      } else {
        input.type = 'password';
        btn.textContent = 'Show';
      }
    });

    initForm();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d10e772850027d2',t:'MTc3MTYyMDkxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>