<!-- /app/pages/projects.html -->
<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tax Monitor Pro - Project Map</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet" />

  <style>
    * { font-family: 'DM Sans', sans-serif; }
    body { box-sizing: border-box; }

    .glow-amber { box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
    .glow-green { box-shadow: 0 0 15px rgba(34, 197, 94, 0.2); }

    @keyframes dash { to { stroke-dashoffset: -100; } }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
      50% { box-shadow: 0 0 30px rgba(251, 191, 36, 0.5); }
    }

    .node-current { animation: pulse-glow 2s ease-in-out infinite; }

    .node-card { transition: all 0.3s ease; }

    .node-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    /* Locked nodes are still clickable (we show messaging instead of blocking clicks). */
    .node-card.locked {
      opacity: 0.65;
      cursor: pointer;
    }

    .detail-panel { animation: slideIn 0.3s ease; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .phase-connector {
      background: linear-gradient(90deg, transparent, rgba(251, 191, 36, 0.3), transparent);
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
  </style>
</head>

<!--
  SCROLL FIX NOTE:
  Flex + overflow requires min-h-0 on the flex children you want to scroll.
  Roadmap uses: main(min-h-0) + roadmap(min-h-0 overflow-y-auto)
-->

<body class="h-screen bg-slate-900 text-slate-100 overflow-hidden">
  <div class="h-screen flex">

    <!-- SIDEBAR (inline) -->
    <aside class="w-64 bg-slate-900 border-r border-slate-800/50 flex flex-col shrink-0">
      <div class="p-5 border-b border-slate-800/50">
        <div class="flex items-center gap-3">
          <div
            class="w-10 h-10 rounded-lg flex items-center justify-center font-bold text-slate-900 text-lg"
            style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);"
            aria-hidden="true"
          >
            TM
          </div>
          <div>
            <div class="font-semibold text-white text-sm">Tax Monitor Pro</div>
            <div class="text-xs text-slate-500">IRS Monitoring</div>
          </div>
        </div>
      </div>

      <div class="p-5 border-b border-slate-800/50">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm font-medium text-slate-300 tm-user-initials">TM</div>
          <div class="flex-1 min-w-0">
            <div id="sidebar-user-name" class="font-medium text-sm text-white truncate">Jane Doe</div>
            <div id="sidebar-account-label" class="text-xs text-slate-500">Account: Monitoring</div>
          </div>
        </div>
        <a href="javascript:void(0)" class="text-xs text-amber-500 hover:text-amber-400 mt-2 inline-block transition-colors">Edit profile</a>
      </div>

      <nav class="flex-1 py-4 px-3">
        <ul class="space-y-1">
          <li>
            <a href="/app/index.html" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-white">
              <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
              </svg>
              Start Here
            </a>
          </li>

          <li>
            <a href="/app/pages/calendar.html" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-slate-400 hover:text-white">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              Calendar
            </a>
          </li>

          <li>
            <a href="/app/pages/files.html" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-slate-400 hover:text-white">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/>
              </svg>
              Files
            </a>
          </li>

          <li>
            <a href="/app/pages/messaging.html" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-slate-400 hover:text-white">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 10h8m-8 4h5m-7 7l-3 3V5a2 2 0 012-2h14a2 2 0 012 2v12a2 2 0 01-2 2H7z"/>
              </svg>
              Messaging
            </a>
          </li>

          <li>
            <a href="/app/pages/office.html" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-slate-400 hover:text-white">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 21h18M5 21V7a2 2 0 012-2h3v16M14 21V3h3a2 2 0 012 2v16"/>
              </svg>
              Office
            </a>
          </li>

          <li>
            <a href="/app/pages/projects.html" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-white">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5h6m-8 4h10M7 13h10M7 17h6"/>
              </svg>
              Projects
            </a>
          </li>

          <li>
            <a href="/app/pages/support.html" class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-slate-400 hover:text-white">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/>
              </svg>
              Support
            </a>
          </li>
        </ul>
      </nav>

      <div class="p-4 border-t border-slate-800/50">
        <p id="sidebar-footnote" class="text-[11px] text-slate-500 leading-relaxed">Monitoring does not create IRS representation.</p>
      </div>
    </aside>

    <!-- MAIN COLUMN -->
    <div class="flex-1 min-w-0 flex flex-col h-screen overflow-hidden">

      <!-- TOPBAR (inline) -->
      <header class="h-16 bg-slate-900/50 border-b border-slate-800/50 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-3">
          <div class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800/50 border border-slate-700/50">
            <span class="w-2 h-2 rounded-full bg-amber-500"></span>
            <span id="topbar-mode" class="text-xs text-slate-300">Monitoring Portal</span>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button class="p-2 text-slate-400 hover:text-white transition-colors" aria-label="Search">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </button>

          <button class="p-2 text-slate-400 hover:text-white transition-colors relative" aria-label="Notifications">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
            <span id="notif-dot" class="absolute top-1.5 right-1.5 w-2 h-2 bg-amber-500 rounded-full"></span>
          </button>

          <a href="/app/pages/support.html" class="p-2 text-slate-400 hover:text-white transition-colors" aria-label="Help">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </a>

          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-slate-600 to-slate-700 flex items-center justify-center text-sm font-medium text-slate-300 cursor-pointer hover:ring-2 hover:ring-amber-500/50 transition-all tm-user-initials">TM</div>
          <span id="topbar-user-name" class="sr-only">Jane Doe</span>
        </div>
      </header>

      <!-- PHASE PROGRESS BAR -->
      <div class="bg-slate-800/30 border-b border-slate-700/30 shrink-0">
        <div class="max-w-7xl mx-auto px-4 py-3">
          <div class="flex items-center gap-2">
            <div id="phase-indicators" class="flex items-center gap-1 flex-1"></div>
          </div>
        </div>
      </div>

      <!-- MAIN CONTENT -->
      <main class="flex-1 min-h-0 flex flex-col lg:flex-row overflow-hidden">

        <!-- Roadmap (scrollable) -->
        <section class="flex-1 min-w-0 min-h-0 overflow-y-auto overscroll-contain p-4 lg:p-6" aria-label="Roadmap">
          <div id="mind-map" class="space-y-8 pb-24"></div>
        </section>

        <!-- Details (scrollable) -->
        <aside class="w-full lg:w-[35rem] shrink-0 min-h-0 border-t lg:border-t-0 lg:border-l border-slate-700/50 bg-slate-800/30 overflow-y-auto overscroll-contain" aria-label="Details">
          <div id="detail-panel" class="p-4 lg:p-6"></div>
        </aside>

      </main>

      <!-- Activity Timeline Footer -->
      <footer class="border-t border-slate-700/50 bg-slate-800/50 shrink-0">
        <div class="max-w-7xl mx-auto px-4 py-3">
          <div class="flex items-center gap-2 text-xs text-slate-400">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Recent Activity:</span>
            <div id="activity-timeline" class="flex items-center gap-4 overflow-x-auto flex-1"></div>
          </div>
        </div>
      </footer>

    </div>
  </div>

  <script>
    // Demo flags
    const DEMO_LOCK_ALL = true;
    const WET_SIGNATURE_REQUIRED = true; // toggle for Phase 2 wet signature requirement

    const projectData = {
      phases: [
        {
          id: 0,
          name: 'Lead Capture & Payment',
          connector: 'Unlocked after Payment',
          steps: [
            {
              id: 'intake',
              name: 'Intake',
              status: 'complete',
              type: 'form',
              icon: 'clipboard',
              microcopy: 'Initial information collection',
              description: 'We collect your basic information to understand your tax situation and determine how we can help you.',
              whatWeNeed: ['Full legal name', 'Contact information', 'Tax years of concern', 'Brief description of issue'],
              whatWeDo: ['Review your submission', 'Assign a case specialist', 'Prepare next steps'],
              formFields: ['Full Name', 'Email', 'Phone', 'Tax Years', 'Issue Type', 'Description'],
              link: '/app/pages/flows/intake/intake.html'
            },
            {
              id: 'offer',
              name: 'Offer',
              status: 'complete',
              type: 'form',
              icon: 'document',
              microcopy: 'Service proposal review',
              description: 'Review our proposed services and pricing based on your specific tax situation.',
              whatWeNeed: ['Review of proposed services', 'Confirmation of scope'],
              whatWeDo: ['Customize service package', 'Provide transparent pricing', 'Answer questions'],
              formFields: ['Service Selection', 'Add-ons', 'Payment Plan', 'Questions'],
              link: '/app/pages/flows/intake/offer.html'
            },
            {
              id: 'agreement',
              name: 'Agreement',
              status: 'complete',
              type: 'form',
              icon: 'shield',
              microcopy: 'Service agreement signing',
              description: 'Sign our service agreement to formalize our engagement and protect both parties.',
              whatWeNeed: ['Electronic signature', 'Agreement acknowledgment'],
              whatWeDo: ['Provide clear terms', 'Secure your data', 'Begin onboarding'],
              formFields: ['Agreement Review', 'Terms Acceptance', 'E-Signature', 'Date'],
              link: '/app/pages/flows/intake/agreement.html'
            },
            {
              id: 'payment',
              name: 'Payment',
              status: 'complete',
              type: 'form',
              icon: 'credit-card',
              microcopy: 'Secure payment processing',
              description: 'Complete your payment to activate your account and begin the compliance process.',
              whatWeNeed: ['Payment method', 'Billing information'],
              whatWeDo: ['Process securely', 'Send receipt', 'Activate account'],
              formFields: ['Payment Method', 'Billing Address', 'Amount', 'Confirmation'],
              link: '/app/pages/flows/intake/payment.html'
            }
          ]
        },
        {
          id: 1,
          name: 'ESign 2848 / Review',
          connector: 'Next: IRS Authorization & Review Begins',
          steps: [
            {
              id: 'welcome',
              name: 'Welcome',
              status: 'complete',
              type: 'form',
              icon: 'sparkles',
              microcopy: 'Account setup & orientation',
              description: 'Complete your welcome questionnaire to help us personalize your experience.',
              whatWeNeed: ['Communication preferences', 'Availability windows'],
              whatWeDo: ['Set up your portal', 'Assign your team', 'Create your timeline'],
              formFields: ['Preferred Contact Method', 'Best Times', 'Timezone', 'Additional Info'],
              link: '/app/pages/flows/review/welcome.html'
            },
            {
              id: 'filing-status',
              name: 'Filing Status',
              status: 'complete',
              type: 'form',
              icon: 'user-group',
              microcopy: 'Verify filing status details',
              description: 'Confirm your current filing status to ensure accurate representation with the IRS.',
              whatWeNeed: ['Current filing status', 'Dependent information'],
              whatWeDo: ['Verify against IRS records', 'Flag discrepancies', 'Update if needed'],
              formFields: ['Filing Status', 'Spouse Info', 'Dependents', 'Changes'],
              link: '/app/pages/flows/review/filing-status.html'
            },
            {
              id: 'address-update',
              name: 'Address Update',
              status: 'current',
              type: 'form',
              icon: 'location',
              microcopy: 'Confirm current address',
              description: 'Verify your current mailing address to ensure all IRS correspondence reaches you.',
              whatWeNeed: ['Current mailing address', 'Address history if changed'],
              whatWeDo: ['Update IRS records', 'Redirect correspondence', 'Confirm receipt'],
              formFields: ['Street Address', 'City', 'State', 'ZIP', 'Previous Address'],
              link: '/app/pages/flows/review/address-update.html'
            },
            {
              id: 'esign-2848',
              name: 'eSign 2848',
              status: 'ready',
              type: 'form',
              icon: 'pencil',
              microcopy: 'Power of Attorney authorization',
              description: 'Sign Form 2848 to authorize us to represent you before the IRS and access your records.',
              whatWeNeed: ['Electronic signature', 'Identity verification'],
              whatWeDo: ['File with IRS', 'Obtain CAF number', 'Begin representation'],
              formFields: ['Taxpayer Info', 'Representative Info', 'Tax Matters', 'Signature', 'Date'],
              link: '/app/pages/flows/review/esign-2848.html'
            }
          ]
        },
        {
          id: 2,
          name: 'Processing / Due Diligence',
          connector: 'Requires CAF Verified',
          steps: [
            {
              id: 'authorization-caf',
              name: 'Authorization + CAF',
              status: 'locked',
              type: 'operator',
              icon: 'key',
              microcopy: 'IRS authorization processing',
              description: 'We process your Form 2848 with the IRS and obtain your Centralized Authorization File (CAF) number.',
              whatWeNeed: ['Completed 2848', 'Patience while processing'],
              whatWeDo: ['Submit to IRS', 'Track processing', 'Verify authorization'],
              checklist: ['Submit Form 2848 to IRS', 'Receive CAF confirmation', 'Verify access level', 'Test record access'],
              estimate: '3-5 business days'
            },
            ...(WET_SIGNATURE_REQUIRED ? [
              {
                id: 'wet-signature-2848',
                name: 'Wet Signature Required (2848)',
                status: 'locked',
                type: 'form',
                icon: 'pencil',
                microcopy: 'Print, sign, and upload Form 2848',
                description: 'In certain cases, the IRS requires a physical (wet) signature on Form 2848. Please print, sign, and upload the completed form so we can proceed.',
                whatWeNeed: ['Printed Form 2848', 'Handwritten signature', 'Uploaded signed copy (PDF)'],
                whatWeDo: ['Review for accuracy', 'Submit to IRS', 'Confirm receipt'],
                formFields: ['Download 2848', 'Upload Signed Copy'],
                link: '/app/pages/flows/review/wet-sign-2848.html'
              }
            ] : []),
            {
              id: 'record-retrieval',
              name: 'Record Retrieval + Analysis',
              status: 'locked',
              type: 'operator',
              icon: 'search',
              microcopy: 'IRS record analysis',
              description: 'We retrieve your complete tax records from the IRS and perform comprehensive analysis.',
              whatWeNeed: ['CAF verification', 'Any additional documents'],
              whatWeDo: ['Pull IRS transcripts', 'Analyze records', 'Identify issues', 'Prepare findings'],
              checklist: ['Request wage & income', 'Request account transcripts', 'Request return transcripts', 'Cross-reference data', 'Document findings'],
              estimate: '5-7 business days'
            }
          ]
        },
        {
          id: 3,
          name: 'Results',
          connector: null,
          steps: [
            {
              id: 'compliance-report',
              name: 'Compliance Report',
              status: 'locked',
              type: 'operator',
              icon: 'chart',
              microcopy: 'Comprehensive findings report',
              description: 'Receive your detailed compliance report with findings, recommendations, and next steps.',
              whatWeNeed: ['Review of findings', 'Questions prepared'],
              whatWeDo: ['Compile findings', 'Create recommendations', 'Prepare presentation'],
              checklist: ['Compile all findings', 'Create visual summary', 'Draft recommendations', 'Prepare action items'],
              estimate: '2-3 business days'
            },
            {
              id: 'results-appointment',
              name: 'Results Appointment',
              status: 'locked',
              type: 'form',
              icon: 'calendar',
              microcopy: 'Staff schedules your review appointment',
              description: 'Your assigned specialist will schedule your results appointment after the compliance report is ready.',
              whatWeNeed: ['Keep an eye out for a scheduling message'],
              whatWeDo: ['Send scheduling options', 'Confirm appointment time', 'Prepare review agenda'],
              formFields: [
                "Client's Preferred Date",
                "Client's Preferred Time",
                "Meeting Type",
                "Topics to Discuss"
              ],
              link: '/app/pages/flows/results/appointment.html'
            },
            {
              id: 'exit-survey',
              name: 'Exit Survey',
              status: 'locked',
              type: 'form',
              icon: 'star',
              microcopy: 'Share your feedback',
              description: 'Help us improve by sharing your experience with our service.',
              whatWeNeed: ['Honest feedback', 'Suggestions'],
              whatWeDo: ['Review feedback', 'Improve services', 'Follow up if needed'],
              formFields: ['Overall Rating', 'Service Quality', 'Communication', 'Recommendations', 'Comments'],
              link: '/app/pages/flows/results/exit-survey.html'
            }
          ]
        }
      ],
      crossPhaseSteps: [
        {
          id: 'support-ticket',
          name: 'Support Ticket',
          status: 'ready',
          type: 'form',
          icon: 'support',
          microcopy: 'Get help anytime',
          description: 'Need assistance? Visit the Support page and our team will respond within 24 hours.',
          whatWeNeed: ['Issue description', 'Relevant details'],
          whatWeDo: ['Review immediately', 'Assign specialist', 'Resolve promptly'],
          formFields: ['Subject', 'Category', 'Priority', 'Description', 'Attachments'],
          link: '/app/pages/support.html'
        }
      ],
      activities: [
        { text: 'Payment confirmed', time: '2 days ago', type: 'success' },
        { text: 'Filing status submitted', time: '1 day ago', type: 'success' },
        { text: 'Welcome packet sent', time: '1 day ago', type: 'info' },
        { text: 'Address update pending', time: 'Now', type: 'warning' }
      ]
    };

    let selectedStep = null;
    let config = {};

    const defaultConfig = {
      background_color: '#0f172a',
      page_title: 'Tax Monitor Pro',
      primary_color: '#f59e0b',
      secondary_color: '#475569',
      surface_color: '#1e293b',
      text_color: '#f1f5f9',
      welcome_message: 'Your Compliance Journey'
    };

    const icons = {
      'arrow-right': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>',
      'calendar': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>',
      'chart': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>',
      'check': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',
      'clipboard': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>',
      'credit-card': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>',
      'document': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>',
      'key': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>',
      'location': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>',
      'lock': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>',
      'pencil': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>',
      'search': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>',
      'shield': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>',
      'sparkles': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>',
      'star': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>',
      'support': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/>',
      'user-group': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>'
    };

    function getIcon(name, className = 'w-5 h-5') {
      return `<svg class="${className}" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icons[name] || icons.document}</svg>`;
    }

    function getStatusStyles(status) {
      const styles = {
        blocked: { bg: 'bg-red-500/10', border: 'border-red-500/30', pill: 'bg-red-500/20 text-red-400', pillText: 'Blocked', text: 'text-red-400' },
        complete: { bg: 'bg-emerald-500/20', border: 'border-emerald-500/30', pill: 'bg-emerald-500/20 text-emerald-400', pillText: 'Complete', text: 'text-emerald-400' },
        current: { bg: 'bg-amber-500/20', border: 'border-amber-500/50', pill: 'bg-amber-500/20 text-amber-400', pillText: 'Current', text: 'text-amber-400' },
        locked: { bg: 'bg-slate-800/50', border: 'border-slate-700/30', pill: 'bg-slate-600/20 text-slate-500', pillText: 'Locked', text: 'text-slate-500' },
        ready: { bg: 'bg-slate-700/50', border: 'border-slate-600/50', pill: 'bg-blue-500/20 text-blue-400', pillText: 'Ready', text: 'text-slate-300' }
      };
      return styles[status] || styles.locked;
    }

    function getLinearSteps() {
      return [
        ...projectData.phases.flatMap(p => p.steps),
        ...projectData.crossPhaseSteps
      ];
    }

    function getPrerequisiteStep(stepId) {
      const steps = getLinearSteps();
      const index = steps.findIndex(s => s.id === stepId);
      if (index > 0) return steps[index - 1];
      return null;
    }

    function lockAllSteps() {
      projectData.phases.forEach(phase => {
        phase.steps.forEach(step => { step.status = 'locked'; });
      });

      // Demo start: Intake is the only unlocked step.
      const intake = projectData.phases.flatMap(p => p.steps).find(s => s.id === 'intake');
      if (intake) intake.status = 'ready';

      // Support remains available.
      projectData.crossPhaseSteps.forEach(step => {
        step.status = (step.id === 'support-ticket') ? 'ready' : 'locked';
      });
    }

    function renderPhaseIndicators() {
      const container = document.getElementById('phase-indicators');
      let html = '';

      projectData.phases.forEach((phase, index) => {
        const isComplete = phase.steps.every(s => s.status === 'complete');
        const isCurrent = phase.steps.some(s => s.status === 'current');

        let statusClass = 'bg-slate-700 text-slate-400';
        if (isComplete) statusClass = 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30';
        else if (isCurrent) statusClass = 'bg-amber-500/20 text-amber-400 border border-amber-500/50';

        html += `
          <div class="flex items-center ${index < projectData.phases.length - 1 ? 'flex-1' : ''}">
            <div class="px-3 py-1.5 rounded-full text-xs font-medium ${statusClass} whitespace-nowrap">
              Phase ${phase.id}: ${phase.name}
            </div>
            ${index < projectData.phases.length - 1 ? `<div class="flex-1 h-0.5 mx-2 phase-connector rounded-full"></div>` : ''}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderStepNode(step) {
      const styles = getStatusStyles(step.status);
      const isLocked = step.status === 'locked';
      const isCurrent = step.status === 'current';
      const isComplete = step.status === 'complete';
      const isSelected = selectedStep === step.id;
      const isStart = step.id === 'intake';

      const prerequisite = getPrerequisiteStep(step.id);
      const lockedMessage = isLocked
        ? (prerequisite ? `Locked — complete ${prerequisite.name} first` : 'Locked')
        : step.microcopy;

      return `
        <div
          class="node-card p-4 rounded-xl border ${styles.border} ${styles.bg} ${isLocked ? 'locked' : 'cursor-pointer'} ${(isCurrent || isStart) ? 'node-current' : ''} ${isSelected ? 'ring-2 ring-amber-500/50' : ''} ${isStart ? 'ring-2 ring-amber-500/40' : ''}"
          data-step-id="${step.id}"
        >
          <div class="flex items-start justify-between mb-3">
            <div class="w-10 h-10 rounded-lg ${isComplete ? 'bg-emerald-500/20' : isCurrent ? 'bg-amber-500/20' : 'bg-slate-700/50'} flex items-center justify-center ${styles.text}">
              ${isComplete ? getIcon('check') : isLocked ? getIcon('lock') : getIcon(step.icon)}
            </div>
            <span class="px-2 py-0.5 rounded-full text-[10px] font-medium ${styles.pill}">
              ${styles.pillText}
            </span>
          </div>
          <h3 class="font-semibold text-white text-sm mb-1">${step.name}</h3>
          <p class="text-xs ${styles.text} line-clamp-2">${lockedMessage}</p>
        </div>
      `;
    }

    function renderMindMap() {
      const container = document.getElementById('mind-map');
      let html = '';

      projectData.phases.forEach(phase => {
        const phaseStatus =
          phase.steps.every(s => s.status === 'complete') ? 'complete' :
          phase.steps.some(s => s.status === 'current') ? 'current' :
          'locked';

        const styles = getStatusStyles(phaseStatus);

        html += `
          <div class="phase-section">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-8 h-8 rounded-lg ${styles.bg} ${styles.border} border flex items-center justify-center">
                <span class="text-sm font-bold ${styles.text}">${phase.id}</span>
              </div>
              <h2 class="text-lg font-semibold text-white">${phase.name}</h2>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
              ${phase.steps.map(renderStepNode).join('')}
            </div>

            ${phase.connector ? `
              <div class="flex items-center gap-2 text-xs text-slate-500 ml-4 mb-2">
                ${getIcon('arrow-right', 'w-4 h-4')}
                <span class="italic">${phase.connector}</span>
              </div>
            ` : ''}
          </div>
        `;
      });

      html += `
        <div class="mt-6 pt-6 border-t border-slate-700/30">
          <div class="flex items-center gap-2 mb-4 text-slate-400">
            <span class="text-xs uppercase tracking-wider">Cross-Phase Support</span>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
            ${projectData.crossPhaseSteps.map(renderStepNode).join('')}
          </div>
        </div>
      `;

      container.innerHTML = html;

      document.querySelectorAll('.node-card').forEach(node => {
        node.addEventListener('click', () => selectStep(node.dataset.stepId));
      });

      if (!selectedStep) {
        const currentStep = projectData.phases.flatMap(p => p.steps).find(s => s.status === 'current');
        if (currentStep) selectStep(currentStep.id);
      }
    }

    function selectStep(stepId) {
      selectedStep = stepId;

      document.querySelectorAll('.node-card').forEach(node => {
        node.classList.remove('ring-2', 'ring-amber-500/50');
        if (node.dataset.stepId === stepId) node.classList.add('ring-2', 'ring-amber-500/50');
      });

      renderDetailPanel();
    }

    function findStep(stepId) {
      for (const phase of projectData.phases) {
        const step = phase.steps.find(s => s.id === stepId);
        if (step) return step;
      }
      return projectData.crossPhaseSteps.find(s => s.id === stepId) || null;
    }

    function renderFormContent(step) {
      const isComplete = step.status === 'complete';
      if (!step.formFields) return '';

      return `
        <div class="bg-slate-800/30 rounded-lg p-4 border border-slate-700/30">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Form Preview</h3>
            ${isComplete ? `<span class="flex items-center gap-1 text-xs text-slate-500">${getIcon('lock', 'w-3 h-3')}Submitted</span>` : ''}
          </div>
          <div class="space-y-2">
            ${step.formFields.slice(0, 5).map(field => `
              <div class="flex items-center gap-2 px-3 py-2 rounded-lg ${isComplete ? 'bg-slate-700/30 opacity-60' : 'bg-slate-700/50'}">
                <span class="w-2 h-2 rounded-full ${isComplete ? 'bg-emerald-500' : 'bg-slate-500'}"></span>
                <span class="text-sm ${isComplete ? 'text-slate-400' : 'text-slate-300'}">${field}</span>
                ${isComplete ? `<span class="ml-auto text-xs text-emerald-400">✓</span>` : ''}
              </div>
            `).join('')}
            ${step.formFields.length > 5 ? `<p class="text-xs text-slate-500 text-center pt-2">+${step.formFields.length - 5} more fields</p>` : ''}
          </div>
          ${isComplete ? `<p class="text-xs text-slate-500 mt-3 italic">Changes require a support request.</p>` : ''}
        </div>
      `;
    }

    function renderOperatorContent(step) {
      const statusMap = {
        blocked: { text: 'Waiting on You', class: 'text-red-400 bg-red-500/20' },
        complete: { text: 'Complete', class: 'text-emerald-400 bg-emerald-500/20' },
        current: { text: 'In Progress', class: 'text-amber-400 bg-amber-500/20' },
        locked: { text: 'Pending', class: 'text-slate-400 bg-slate-700/50' }
      };

      const status = statusMap[step.status] || statusMap.locked;

      return `
        <div class="bg-slate-800/30 rounded-lg p-4 border border-slate-700/30">
          <div class="flex items-center justify-between mb-4">
            <span class="px-3 py-1 rounded-full text-xs font-medium ${status.class}">${status.text}</span>
            ${step.estimate ? `<span class="text-xs text-slate-500">Est. ${step.estimate}</span>` : ''}
          </div>

          <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Processing Checklist</h3>
          <div class="space-y-2">
            ${(step.checklist || []).map((item, index) => {
              const isItemComplete = step.status === 'complete' || (step.status === 'current' && index === 0);
              return `
                <div class="flex items-center gap-3 px-3 py-2 rounded-lg bg-slate-700/30">
                  <div class="w-5 h-5 rounded-full ${isItemComplete ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-600/50 text-slate-500'} flex items-center justify-center flex-shrink-0">
                    ${isItemComplete ? getIcon('check', 'w-3 h-3') : `<span class="text-xs">${index + 1}</span>`}
                  </div>
                  <span class="text-sm ${isItemComplete ? 'text-slate-400 line-through' : 'text-slate-300'}">${item}</span>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function getDynamicButtonConfig(step) {
      const isComplete = step.status === 'complete';
      const isLocked = step.status === 'locked';
      const isOperator = step.type === 'operator';
      const isSupport = step.id === 'support-ticket';

      // Support is always available
      if (isSupport) {
        return { href: '/app/pages/support.html', icon: 'support', label: 'Go To Support Page', style: 'primary' };
      }

      // Operator steps are read-only from this page
      if (isOperator) {
        return { href: '#', icon: 'chart', label: 'View Processing Details', style: 'operator' };
      }

      const varietyMap = {
        agreement: { edit: 'Edit Agreement', view: 'View Signed Agreement' },
        'address-update': { edit: 'Edit Address Information', view: 'View Address Details' },
        'esign-2848': { edit: 'Complete eSign 2848', view: 'View eSigned 2848' },
        'exit-survey': { edit: 'Complete Exit Survey', view: 'View Survey Submission' },
        'filing-status': { edit: 'Edit Filing Status', view: 'View Filing Status' },
        intake: { edit: 'Edit Intake Form', view: 'View Intake Form' },
        offer: { edit: 'Edit Offer Details', view: 'View Offer Summary' },
        payment: { edit: 'Update Payment Method', view: 'View Payment Receipt' },
        'results-appointment': { edit: 'Await Staff Scheduling', view: 'View Scheduled Results Appointment' },
        welcome: { edit: 'Edit Welcome Info', view: 'View Welcome Responses' },
        'wet-signature-2848': { edit: 'Upload Signed 2848', view: 'View Uploaded 2848' }
      };

      const map = varietyMap[step.id] || { edit: `Edit ${step.name}`, view: `View ${step.name}` };

      // Results appointment is staff-scheduled, always ghost unless complete.
      if (step.id === 'results-appointment' && !isComplete) {
        return { href: step.link || '#', icon: 'lock', label: map.edit, style: 'ghost' };
      }

      if (isComplete) {
        return { href: step.link || '#', icon: 'search', label: map.view, style: 'complete' };
      }

      // Unlocked editable steps are orange; locked steps are ghost.
      return {
        href: step.link || '#',
        icon: isLocked ? 'lock' : 'pencil',
        label: map.edit,
        style: isLocked ? 'ghost' : 'primary'
      };
    }

    function renderPrimaryAction(step) {
      const cfg = getDynamicButtonConfig(step);

      if (cfg.style === 'operator') {
        return `
          <button
            class="w-full py-3 px-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-all bg-slate-800/40 text-slate-300 border border-slate-700/40 hover:bg-slate-800/60"
            data-action="noop"
            type="button"
          >
            ${getIcon(cfg.icon)}
            ${cfg.label}
          </button>
        `;
      }

      const baseClass = cfg.style === 'complete'
        ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 hover:bg-emerald-500/30'
        : cfg.style === 'ghost'
          ? 'bg-slate-800/40 text-slate-300 border border-slate-700/40 hover:bg-slate-800/60'
          : 'bg-gradient-to-r from-amber-500 to-amber-600 text-slate-900 hover:from-amber-400 hover:to-amber-500 shadow-lg shadow-amber-500/20';

      const weightClass = cfg.style === 'ghost' ? 'font-medium' : 'font-semibold';

      return `
        <button
          class="w-full py-3 px-4 rounded-xl ${weightClass} flex items-center justify-center gap-2 transition-all ${baseClass}"
          data-action="navigate"
          data-href="${cfg.href}"
          type="button"
        >
          ${getIcon(cfg.icon)}
          ${cfg.label}
        </button>
      `;
    }

    function renderDetailBadge(step) {
      const isOperator = step.type === 'operator';
      const isSupport = step.id === 'support-ticket';
      const isStaffScheduled = step.id === 'results-appointment';

      if (isOperator) {
        return `
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded bg-purple-500/20 text-purple-400 text-xs">
            ${getIcon('shield', 'w-3 h-3')}
            Internal Processing
          </span>
        `;
      }

      if (isStaffScheduled) {
        return `
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded bg-slate-700/40 text-slate-300 text-xs">
            ${getIcon('lock', 'w-3 h-3')}
            Staff Scheduled
          </span>
        `;
      }

      if (isSupport) {
        return `
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded bg-amber-500/15 text-amber-300 text-xs">
            ${getIcon('support', 'w-3 h-3')}
            Optional — If You Need Help
          </span>
        `;
      }

      return `
        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded bg-amber-500/20 text-amber-400 text-xs">
          ${getIcon('user-group', 'w-3 h-3')}
          Action Required From You
        </span>
      `;
    }

    function renderDetailPanel() {
      const container = document.getElementById('detail-panel');

      if (!selectedStep) {
        container.innerHTML = `
          <div class="flex flex-col items-center justify-center h-64 text-center">
            <div class="w-16 h-16 rounded-full bg-slate-700/50 flex items-center justify-center mb-4">
              ${getIcon('document', 'w-8 h-8 text-slate-500')}
            </div>
            <h3 class="text-lg font-medium text-slate-400 mb-2">Select a Step</h3>
            <p class="text-sm text-slate-500">Click on any step in the roadmap to view details</p>
          </div>
        `;
        return;
      }

      const step = findStep(selectedStep);
      if (!step) return;

      const styles = getStatusStyles(step.status);
      const isOperator = step.type === 'operator';

      container.innerHTML = `
        <div class="detail-panel">
          <div class="flex items-start gap-4 mb-6">
            <div class="w-14 h-14 rounded-xl ${styles.bg} ${styles.border} border flex items-center justify-center ${styles.text} flex-shrink-0">
              ${getIcon(step.icon, 'w-7 h-7')}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h2 class="text-xl font-bold text-white">${step.name}</h2>
                <span class="px-2 py-0.5 rounded-full text-xs font-medium ${styles.pill}">${styles.pillText}</span>
              </div>
              ${renderDetailBadge(step)}
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">What This Step Does</h3>
            <p class="text-sm text-slate-300 leading-relaxed">${step.description}</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-slate-800/50 rounded-lg p-4">
              <h3 class="text-xs font-semibold text-amber-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                ${getIcon('user-group', 'w-4 h-4')}
                What We Need From You
              </h3>
              <ul class="space-y-2">
                ${(step.whatWeNeed || []).map(item => `
                  <li class="flex items-start gap-2 text-sm text-slate-300">
                    <span class="w-1.5 h-1.5 rounded-full bg-amber-500 mt-1.5 flex-shrink-0"></span>
                    ${item}
                  </li>
                `).join('')}
              </ul>
            </div>

            <div class="bg-slate-800/50 rounded-lg p-4">
              <h3 class="text-xs font-semibold text-emerald-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                ${getIcon('sparkles', 'w-4 h-4')}
                What We Do
              </h3>
              <ul class="space-y-2">
                ${(step.whatWeDo || []).map(item => `
                  <li class="flex items-start gap-2 text-sm text-slate-300">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 flex-shrink-0"></span>
                    ${item}
                  </li>
                `).join('')}
              </ul>
            </div>
          </div>

          ${isOperator ? renderOperatorContent(step) : renderFormContent(step)}

          <div class="flex flex-col gap-3 mt-6">
            ${renderPrimaryAction(step)}
            <div class="flex items-center gap-3 text-xs">
              <a href="#" class="text-slate-400 hover:text-amber-400 transition-colors flex items-center gap-1">
                ${getIcon('calendar', 'w-4 h-4')}
                View Timeline
              </a>
              <a href="#" class="text-slate-400 hover:text-amber-400 transition-colors flex items-center gap-1">
                ${getIcon('document', 'w-4 h-4')}
                View Files
              </a>
            </div>
          </div>
        </div>
      `;

      wireDetailPanelActions(container);
    }

    function wireDetailPanelActions(container) {
      container.querySelectorAll('button[data-action]').forEach(btn => {
        const action = btn.getAttribute('data-action');
        if (action !== 'navigate') return;

        btn.addEventListener('click', () => {
          const href = btn.getAttribute('data-href');
          if (!href || href === '#') return;
          window.location.href = href;
        });
      });
    }

    function renderActivityTimeline() {
      const container = document.getElementById('activity-timeline');

      const typeStyles = {
        error: 'bg-red-500',
        info: 'bg-blue-500',
        success: 'bg-emerald-500',
        warning: 'bg-amber-500'
      };

      container.innerHTML = projectData.activities.map(activity => `
        <div class="flex items-center gap-2 whitespace-nowrap">
          <span class="w-1.5 h-1.5 rounded-full ${typeStyles[activity.type] || typeStyles.info}"></span>
          <span class="text-slate-300">${activity.text}</span>
          <span class="text-slate-500">•</span>
          <span class="text-slate-500">${activity.time}</span>
        </div>
      `).join('');
    }

    function applyColors() {
      const bgColor = config.background_color || defaultConfig.background_color;
      const textColor = config.text_color || defaultConfig.text_color;
      document.body.style.backgroundColor = bgColor;
      document.body.style.color = textColor;
    }

    async function onConfigChange(newConfig) {
      config = newConfig;
      applyColors();
    }

    function mapToCapabilities(cfg) {
      return {
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined,
        recolorables: [
          { get: () => cfg.background_color || defaultConfig.background_color, set: (value) => { cfg.background_color = value; window.elementSdk.setConfig({ background_color: value }); } },
          { get: () => cfg.primary_color || defaultConfig.primary_color, set: (value) => { cfg.primary_color = value; window.elementSdk.setConfig({ primary_color: value }); } },
          { get: () => cfg.secondary_color || defaultConfig.secondary_color, set: (value) => { cfg.secondary_color = value; window.elementSdk.setConfig({ secondary_color: value }); } },
          { get: () => cfg.surface_color || defaultConfig.surface_color, set: (value) => { cfg.surface_color = value; window.elementSdk.setConfig({ surface_color: value }); } },
          { get: () => cfg.text_color || defaultConfig.text_color, set: (value) => { cfg.text_color = value; window.elementSdk.setConfig({ text_color: value }); } }
        ]
      };
    }

    function mapToEditPanelValues(cfg) {
      return new Map([
        ['page_title', cfg.page_title || defaultConfig.page_title],
        ['welcome_message', cfg.welcome_message || defaultConfig.welcome_message]
      ]);
    }

    // Tiny smoke tests. These run in the browser console.
    function assert(condition, message) {
      if (!condition) throw new Error(message);
    }

    function runTests() {
      try {
        const readyIntake = { id: 'intake', status: 'ready', type: 'form', icon: 'clipboard', link: '/app/pages/flows/intake/intake.html', name: 'Intake' };
        const lockedOffer = { id: 'offer', status: 'locked', type: 'form', icon: 'document', link: '/app/pages/flows/intake/offer.html', name: 'Offer' };
        const completeOffer = { id: 'offer', status: 'complete', type: 'form', icon: 'document', link: '/app/pages/flows/intake/offer.html', name: 'Offer' };
        const staffScheduled = { id: 'results-appointment', status: 'locked', type: 'form', icon: 'calendar', link: '/app/pages/flows/results/appointment.html', name: 'Results Appointment' };
        const operatorStep = { id: 'z', status: 'current', type: 'operator', icon: 'chart' };
        const supportStep = { id: 'support-ticket', status: 'ready', type: 'form', icon: 'support' };

        const intakeHtml = renderPrimaryAction(readyIntake);
        const lockedOfferHtml = renderPrimaryAction(lockedOffer);
        const completeOfferHtml = renderPrimaryAction(completeOffer);
        const staffScheduledHtml = renderPrimaryAction(staffScheduled);
        const operatorHtml = renderPrimaryAction(operatorStep);
        const supportHtml = renderPrimaryAction(supportStep);

        assert(intakeHtml.includes('Edit Intake Form'), 'Expected ready intake button to say Edit Intake Form');
        assert(intakeHtml.includes('from-amber-500'), 'Expected ready intake button to be orange');

        assert(lockedOfferHtml.includes('Edit Offer Details'), 'Expected locked offer button to say Edit Offer Details');
        assert(!lockedOfferHtml.includes('from-amber-500'), 'Expected locked offer button to NOT be orange');

        assert(completeOfferHtml.includes('View Offer Summary'), 'Expected completed offer button to say View Offer Summary');
        assert(completeOfferHtml.includes('bg-emerald-500/20'), 'Expected completed offer button to use complete style');

        assert(staffScheduledHtml.includes('Await Staff Scheduling'), 'Expected results appointment to say Await Staff Scheduling when locked');
        assert(!staffScheduledHtml.includes('from-amber-500'), 'Expected staff-scheduled results appointment to be ghost/inactive');

        assert(operatorHtml.includes('View Processing Details'), 'Expected operator primary action to say View Processing Details');
        assert(!operatorHtml.includes('bg-purple-500/20'), 'Expected operator button to NOT use purple style');

        assert(supportHtml.includes('Go To Support Page'), 'Expected support primary action to say Go To Support Page');

        const phase2 = projectData.phases.find(p => p.id === 2);
        assert(!!phase2, 'Expected Phase 2 to exist');

        if (WET_SIGNATURE_REQUIRED) {
          assert(phase2.steps.some(s => s.id === 'wet-signature-2848'), 'Expected wet signature step in Phase 2 when required');
        } else {
          assert(!phase2.steps.some(s => s.id === 'wet-signature-2848'), 'Expected wet signature step NOT in Phase 2 when not required');
        }

        console.info('[projects.html] tests: PASS');
      } catch (err) {
        console.error('[projects.html] tests: FAIL', err);
        throw err;
      }
    }

    function init() {
      if (DEMO_LOCK_ALL) {
        lockAllSteps();
        selectedStep = 'intake';
      }

      runTests();
      renderActivityTimeline();
      renderMindMap();
      renderPhaseIndicators();
      applyColors();

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          mapToCapabilities,
          mapToEditPanelValues,
          onConfigChange
        });
      }
    }

    init();
  </script>
</body>
</html>