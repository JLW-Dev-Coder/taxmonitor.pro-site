<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Case Studies</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    html, body { height: 100%; }
    body { box-sizing: border-box; overflow-x: hidden; }
    * { font-family: 'DM Sans', sans-serif; }

    /* Theme tokens (aligned to index.html config) */
    :root{
      --bg: #020617;
      --surface: #1e293b;
      --surface-muted: rgba(30, 41, 59, 0.5);

      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --text-subtle: #64748b;

      --border: rgba(148, 163, 184, 0.25);
      --border-strong: rgba(148, 163, 184, 0.4);

      --primary: #f59e0b;
      --secondary: #94a3b8;

      /* Optional semantic tags */
      --tag-ethics-bg: rgba(245, 158, 11, 0.16);
      --tag-ethics-fg: #fbbf24;

      --tag-financial-bg: rgba(239, 68, 68, 0.18);
      --tag-financial-fg: #fca5a5;

      --tag-industry-bg: rgba(59, 130, 246, 0.18);
      --tag-industry-fg: #93c5fd;

      --tag-operational-bg: rgba(16, 185, 129, 0.18);
      --tag-operational-fg: #6ee7b7;

      --tag-structural-bg: rgba(168, 85, 247, 0.18);
      --tag-structural-fg: #d8b4fe;
    }

    .gradient-text {
      background: linear-gradient(135deg, var(--primary), color-mix(in srgb, var(--primary) 70%, #ffffff));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero-pattern {
      background-image:
        radial-gradient(1200px 600px at 70% -10%,
          color-mix(in srgb, var(--primary) 18%, transparent),
          transparent 60%),
        radial-gradient(900px 500px at 10% 10%,
          color-mix(in srgb, #ffffff 6%, transparent),
          transparent 55%);
    }

    .document-texture {
      background:
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 28px,
          color-mix(in srgb, var(--text) 4%, transparent) 28px,
          color-mix(in srgb, var(--text) 4%, transparent) 29px
        );
      opacity: 0.55;
    }

    .card-hover { transition: all 0.2s ease; }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 60px -18px color-mix(in srgb, #000000 55%, transparent);
      border-color: var(--border-strong);
    }

    .tag-ethics { background: var(--tag-ethics-bg); color: var(--tag-ethics-fg); }
    .tag-financial { background: var(--tag-financial-bg); color: var(--tag-financial-fg); }
    .tag-industry { background: var(--tag-industry-bg); color: var(--tag-industry-fg); }
    .tag-operational { background: var(--tag-operational-bg); color: var(--tag-operational-fg); }
    .tag-structural { background: var(--tag-structural-bg); color: var(--tag-structural-fg); }

    .chart-bar {
      animation: growBar 1s ease-out forwards;
      transform-origin: bottom;
    }
    @keyframes growBar {
      from { transform: scaleY(0); }
      to { transform: scaleY(1); }
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .tm-bg { background-color: var(--bg); }
    .tm-surface { background-color: var(--surface); }
    .tm-surface-muted { background-color: var(--surface-muted); }
    .tm-text { color: var(--text); }
    .tm-text-muted { color: var(--text-muted); }
    .tm-text-subtle { color: var(--text-subtle); }
    .tm-border { border-color: var(--border); }
    .tm-border-strong { border-color: var(--border-strong); }
    .tm-primary { color: var(--primary); }
    .tm-secondary { color: var(--secondary); }
    .tm-primary-bg { background-color: var(--primary); }

    /* Case modal */
    .tm-modal-backdrop { background: rgba(0,0,0,0.65); }
    .tm-scrollbar::-webkit-scrollbar { width: 10px; height: 10px; }
    .tm-scrollbar::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.22); border-radius: 999px; }
    .tm-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(148,163,184,0.32); }
  </style>

  <script>
    tailwind.config = { theme: { extend: {} } };
  </script>
</head>

<body class="h-full tm-bg tm-text">
  <div id="app-wrapper" class="w-full h-full overflow-auto">

    <!-- PARTIAL:header -->

    <!-- Hero Section -->
    <section class="hero-pattern relative overflow-hidden">
      <div class="absolute inset-0 document-texture pointer-events-none"></div>

      <div class="absolute top-0 right-0 w-1/2 h-full opacity-[0.05] pointer-events-none">
        <svg viewBox="0 0 400 600" class="w-full h-full">
          <g stroke="currentColor" stroke-width="0.6" fill="none" opacity="0.75">
            <rect x="20" y="40" width="360" height="520" rx="4"/>
            <line x1="20" y1="80" x2="380" y2="80"/>
            <line x1="20" y1="120" x2="380" y2="120"/>
            <line x1="20" y1="160" x2="380" y2="160"/>
            <line x1="20" y1="200" x2="380" y2="200"/>
            <line x1="20" y1="240" x2="380" y2="240"/>
            <line x1="20" y1="280" x2="380" y2="280"/>
            <rect x="40" y="50" width="120" height="16" rx="2" fill="currentColor" opacity="0.25"/>
            <rect x="40" y="90" width="200" height="8" rx="1" fill="currentColor" opacity="0.18"/>
            <rect x="40" y="130" width="180" height="8" rx="1" fill="currentColor" opacity="0.18"/>
            <rect x="40" y="170" width="220" height="8" rx="1" fill="currentColor" opacity="0.18"/>
          </g>
        </svg>
      </div>

      <div class="relative max-w-6xl mx-auto px-6 py-20 md:py-28">
        <div class="max-w-3xl">
          <p class="text-xs tracking-widest uppercase mb-4 fade-in tm-text-muted">Case Studies</p>

          <h1 id="hero-headline" class="text-4xl md:text-5xl lg:text-6xl font-bold leading-tight mb-6 fade-in" style="animation-delay: 0.1s">
            Clarity Before Resolution
          </h1>

          <p id="hero-subheadline" class="text-xl md:text-2xl tm-text-muted font-normal mb-6 fade-in" style="animation-delay: 0.2s">
            Real-world examples of what happens when resolution begins without verified IRS account data.
          </p>

          <p class="text-base tm-text-muted leading-relaxed mb-10 max-w-2xl fade-in" style="animation-delay: 0.3s">
            These case studies illustrate operational patterns we see repeatedly across the tax resolution industry. Each represents a structural failure, not a personnel failure. The common thread: resolution strategies initiated before account verification was complete.
          </p>

          <div class="flex flex-wrap gap-4 fade-in" style="animation-delay: 0.4s">
            <a
              id="cta-primary"
              href="#featured"
              data-scroll="featured"
              class="inline-flex items-center gap-2 px-6 py-3 rounded font-medium transition-colors tm-primary-bg text-slate-950 hover:opacity-90"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <span id="cta-primary-text">Review Featured Analysis</span>
            </a>

            <a
              id="cta-secondary"
              href="#case-grid"
              data-scroll="case-grid"
              class="inline-flex items-center gap-2 px-6 py-3 rounded font-medium border transition-colors tm-surface-muted tm-border hover:tm-border-strong"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7c0-2-1-3-3-3H7c-2 0-3 1-3 3z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7l7 5-7 5z"/>
              </svg>
              <span id="cta-secondary-text">Browse All Cases</span>
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Case Study Grid -->
    <section class="py-20 border-t tm-border" id="case-index">
      <div class="max-w-6xl mx-auto px-6">
        <div class="mb-10 flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
          <div>
            <h2 class="text-2xl md:text-3xl font-bold mb-2">Case Study Index</h2>
            <p class="tm-text-muted">Ten documented scenarios. One systemic pattern.</p>
          </div>

          <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
            <div class="relative">
              <input
                id="case-search"
                type="search"
                class="w-full sm:w-72 px-4 py-2 rounded border tm-border tm-surface-muted tm-text placeholder:tm-text-subtle focus:outline-none focus:ring-2"
                style="--tw-ring-color: color-mix(in srgb, var(--primary) 35%, transparent);"
                placeholder="Search case studies"
                aria-label="Search case studies"
              />
            </div>

            <div>
              <select
                id="case-filter"
                class="w-full sm:w-52 px-4 py-2 rounded border tm-border tm-surface-muted tm-text focus:outline-none"
                aria-label="Filter by category"
              >
                <option value="all">All categories</option>
                <option value="ethics">Ethics</option>
                <option value="financial">Financial Risk</option>
                <option value="industry">Industry Norms</option>
                <option value="operational">Operational Design</option>
                <option value="structural">Structural Reform</option>
              </select>
            </div>
          </div>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="case-grid" aria-live="polite"></div>
      </div>
    </section>

    <!-- Featured Case Section -->
    <section class="py-20 border-t tm-border tm-surface-muted" id="featured">
      <div class="max-w-6xl mx-auto px-6">
        <div class="mb-12">
          <p class="text-xs tracking-widest uppercase mb-3 tm-text-muted">Featured Analysis</p>
          <h2 id="featured-title" class="text-2xl md:text-3xl font-bold mb-3">The OIC That Should Never Have Been Filed</h2>
          <p id="featured-subtitle" class="tm-text-muted">A detailed examination of structural failure in Offer in Compromise processing.</p>
        </div>

        <div class="grid lg:grid-cols-2 gap-8 mb-16">
          <div class="tm-surface border tm-border rounded-xl p-8">
            <div class="space-y-6" id="featured-body"></div>
          </div>

          <div class="space-y-6">
            <div class="tm-surface border tm-border rounded-xl overflow-hidden" id="featured-compare"></div>
            <div class="tm-surface border tm-border rounded-xl p-6" id="featured-timeline"></div>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <button id="featured-open" type="button" class="inline-flex items-center gap-2 px-5 py-2.5 rounded font-medium transition-colors tm-primary-bg text-slate-950 hover:opacity-90">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            Read full case
          </button>
          <span class="text-sm tm-text-subtle">Featured case updates when you open a card.</span>
        </div>
      </div>
    </section>

    <!-- Data Reinforcement Section -->
    <section class="py-20 border-t tm-border" id="stats">
      <div class="max-w-6xl mx-auto px-6">
        <div class="text-center mb-12">
          <p class="text-xs tracking-widest uppercase mb-3 tm-text-muted">Statistical Context</p>
          <h2 class="text-2xl md:text-3xl font-bold mb-3">National Data Tells the Same Story</h2>
          <p class="tm-text-muted max-w-2xl mx-auto">Resolution decisions without account verification ignore statistical reality.</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8 mb-10">
          <div class="tm-surface-muted rounded-xl border tm-border p-6">
            <h4 class="text-sm font-semibold mb-1">OIC Acceptance Rates</h4>
            <p class="text-xs tm-text-muted mb-4">Fiscal Years 2019–2023</p>

            <!-- Column chart (SVG) -->
            <div class="relative">
              <svg class="w-full h-56" viewBox="0 0 520 240" role="img" aria-label="OIC acceptance rates, fiscal years 2019 through 2023">
                <!-- Plot area: left=52, right=12, top=16, bottom=44 -->
                <defs>
                  <clipPath id="oicPlotClip">
                    <rect x="52" y="16" width="456" height="180" rx="6" />
                  </clipPath>
                </defs>

                <!-- Gridlines + y-axis labels (0–40%) -->
                <g stroke="rgba(148,163,184,0.25)" stroke-width="1">
                  <line x1="52" y1="196" x2="508" y2="196" />
                  <line x1="52" y1="151" x2="508" y2="151" stroke-dasharray="4 4" />
                  <line x1="52" y1="106" x2="508" y2="106" stroke-dasharray="4 4" />
                  <line x1="52" y1="61"  x2="508" y2="61"  stroke-dasharray="4 4" />
                  <line x1="52" y1="16"  x2="508" y2="16"  stroke-dasharray="4 4" />
                </g>

                <g fill="rgba(148,163,184,0.75)" font-size="11" font-family="DM Sans, system-ui, sans-serif">
                  <text x="10" y="200">0%</text>
                  <text x="10" y="155">10%</text>
                  <text x="10" y="110">20%</text>
                  <text x="10" y="65">30%</text>
                  <text x="10" y="20">40%</text>
                </g>

                <!-- Axes -->
                <g stroke="rgba(148,163,184,0.35)" stroke-width="1">
                  <line x1="52" y1="16" x2="52" y2="196" />
                  <line x1="52" y1="196" x2="508" y2="196" />
                </g>

                <!-- Bars (scale: 0–40% maps to 0–180px) -->
                <!-- Values: 2019=36, 2020=33, 2021=30, 2022=28, 2023=25 -->
                <g clip-path="url(#oicPlotClip)">
                  <!-- Bar geometry -->
                  <!-- helper: barH = (value/40)*180; y = 196 - barH -->
                  <g>
                    <rect class="chart-bar" x="90"  y="34"  width="58" height="162" rx="8" style="animation-delay:0.10s; fill: rgba(148, 163, 184, 0.22);" />
                    <rect class="chart-bar" x="176" y="47.5" width="58" height="148.5" rx="8" style="animation-delay:0.20s; fill: rgba(148, 163, 184, 0.22);" />
                    <rect class="chart-bar" x="262" y="61"  width="58" height="135" rx="8" style="animation-delay:0.30s; fill: rgba(148, 163, 184, 0.22);" />
                    <rect class="chart-bar" x="348" y="70"  width="58" height="126" rx="8" style="animation-delay:0.40s; fill: rgba(148, 163, 184, 0.22);" />
                    <rect class="chart-bar" x="434" y="83.5" width="58" height="112.5" rx="8" style="animation-delay:0.50s; fill: var(--primary);" />
                  </g>

                  <!-- Value labels -->
                  <g font-size="12" font-family="DM Sans, system-ui, sans-serif" font-weight="600">
                    <text x="119" y="26" text-anchor="middle" fill="rgba(241,245,249,0.92)">36%</text>
                    <text x="205" y="39" text-anchor="middle" fill="rgba(241,245,249,0.92)">33%</text>
                    <text x="291" y="52" text-anchor="middle" fill="rgba(241,245,249,0.92)">30%</text>
                    <text x="377" y="61" text-anchor="middle" fill="rgba(241,245,249,0.92)">28%</text>
                    <text x="463" y="75" text-anchor="middle" fill="var(--primary)">25%</text>
                  </g>
                </g>

                <!-- X labels -->
                <g fill="rgba(148,163,184,0.75)" font-size="11" font-family="DM Sans, system-ui, sans-serif">
                  <text x="119" y="226" text-anchor="middle">2019</text>
                  <text x="205" y="226" text-anchor="middle">2020</text>
                  <text x="291" y="226" text-anchor="middle">2021</text>
                  <text x="377" y="226" text-anchor="middle">2022</text>
                  <text x="463" y="226" text-anchor="middle">2023</text>
                </g>

                <!-- Axis title -->
                <g fill="rgba(148,163,184,0.7)" font-size="11" font-family="DM Sans, system-ui, sans-serif">
                  <text x="52" y="10">Acceptance rate</text>
                </g>
              </svg>

              <div class="mt-3 text-xs tm-text-subtle text-center">Source: IRS Data Book, Table 16</div>
            </div>
          </div>

          <div class="tm-surface-muted rounded-xl border tm-border p-6">
            <h4 class="text-sm font-semibold mb-1">Collection Actions Volume</h4>
            <p class="text-xs tm-text-muted mb-6">Liens and Levies Filed (in thousands)</p>

            <div class="h-48 relative">
              <div class="absolute inset-0 flex flex-col justify-between">
                <div class="border-b border-dashed tm-border"></div>
                <div class="border-b border-dashed tm-border"></div>
                <div class="border-b border-dashed tm-border"></div>
                <div class="border-b border-dashed tm-border"></div>
                <div class="border-b tm-border"></div>
              </div>

              <svg class="absolute inset-0 w-full h-full" viewBox="0 0 400 200" preserveAspectRatio="none" aria-hidden="true">
                <polyline fill="none" stroke="rgba(241,245,249,0.85)" stroke-width="2" points="40,60 120,80 200,140 280,130 360,70"/>
                <circle cx="40" cy="60" r="4" fill="rgba(241,245,249,0.85)"/>
                <circle cx="120" cy="80" r="4" fill="rgba(241,245,249,0.85)"/>
                <circle cx="200" cy="140" r="4" fill="rgba(241,245,249,0.85)"/>
                <circle cx="280" cy="130" r="4" fill="rgba(241,245,249,0.85)"/>
                <circle cx="360" cy="70" r="4" fill="rgba(241,245,249,0.85)"/>

                <polyline fill="none" stroke="var(--primary)" stroke-width="2" stroke-dasharray="4,4" points="40,100 120,110 200,160 280,150 360,90"/>
                <circle cx="40" cy="100" r="4" fill="var(--primary)"/>
                <circle cx="120" cy="110" r="4" fill="var(--primary)"/>
                <circle cx="200" cy="160" r="4" fill="var(--primary)"/>
                <circle cx="280" cy="150" r="4" fill="var(--primary)"/>
                <circle cx="360" cy="90" r="4" fill="var(--primary)"/>
              </svg>

              <div class="absolute left-0 top-0 h-full flex flex-col justify-between text-xs tm-text-subtle -ml-2">
                <span>800k</span><span>600k</span><span>400k</span><span>200k</span><span>0</span>
              </div>
            </div>

            <div class="flex items-center justify-center gap-6 mt-4">
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full" style="background: rgba(241,245,249,0.85);"></div>
                <span class="text-xs tm-text-muted">Federal Tax Liens</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full" style="background: var(--primary);"></div>
                <span class="text-xs tm-text-muted">Levies Served</span>
              </div>
            </div>

            <p class="text-xs tm-text-subtle mt-4 text-center">Source: IRS Data Book, Table 25</p>
          </div>
        </div>

        <div class="text-center">
          <a href="https://www.irs.gov/statistics/soi-tax-stats-irs-data-book" target="_blank" rel="noreferrer" class="inline-flex items-center gap-2 font-medium transition-colors tm-primary hover:opacity-90">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a1 1 0 01-1-1"/>
            </svg>
            Explore the Interactive IRS Data Book
          </a>
        </div>
      </div>
    </section>

    <!-- Closing Authority Section -->
    <section class="py-20 border-t tm-border" id="close">
      <div class="max-w-4xl mx-auto px-6 text-center">
        <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-8" style="background: color-mix(in srgb, var(--primary) 18%, transparent);">
          <svg class="w-8 h-8" style="color: var(--primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>

        <h2 class="text-2xl md:text-3xl font-bold mb-6">Structure Prevents Preventable Failure</h2>

        <p class="tm-text-muted text-lg leading-relaxed mb-10 max-w-2xl mx-auto">
          Every case study above reflects the same structural gap: resolution strategy initiated before account verification completed. The solution is better operational design that makes verification the prerequisite, not the afterthought.
        </p>

        <div class="flex flex-wrap justify-center gap-4">
          <a href="/site/contact.html" class="inline-flex items-center gap-2 px-6 py-3 rounded font-medium transition-colors text-slate-950 tm-primary-bg hover:opacity-90">
            Request a Demo
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
            </svg>
          </a>
          <a href="/site/pricing.html" class="inline-flex items-center gap-2 px-6 py-3 rounded font-medium transition-colors border tm-border tm-surface-muted hover:tm-border-strong">
            See Pricing
          </a>
        </div>
      </div>
    </section>

    <!-- PARTIAL:footer -->

    <!-- Case Modal -->
    <div id="case-modal" class="fixed inset-0 hidden" aria-hidden="true">
      <div class="absolute inset-0 tm-modal-backdrop" data-close="true"></div>

      <div class="relative mx-auto max-w-4xl px-6 py-10 h-full flex items-start">
        <div class="w-full tm-surface border tm-border rounded-2xl overflow-hidden shadow-[0_40px_120px_rgba(0,0,0,.65)]">
          <div class="px-6 py-4 border-b tm-border flex items-start justify-between gap-6">
            <div class="min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span id="modal-tag" class="text-xs font-medium px-2 py-1 rounded"></span>
                <span id="modal-id" class="text-xs tm-text-subtle"></span>
              </div>
              <h3 id="modal-title" class="text-xl md:text-2xl font-semibold leading-tight truncate"></h3>
              <p id="modal-summary" class="text-sm tm-text-muted mt-2"></p>
            </div>

            <button id="modal-close" type="button" class="shrink-0 inline-flex items-center justify-center w-10 h-10 rounded-xl border tm-border tm-surface-muted hover:tm-border-strong" aria-label="Close" data-close="true">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="px-6 py-6 max-h-[70vh] overflow-auto tm-scrollbar" id="modal-body"></div>

          <div class="px-6 py-4 border-t tm-border flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
            <div class="text-xs tm-text-subtle">
              <span>These are anonymized workflow patterns.</span>
            </div>
            <div class="flex gap-3">
              <button id="modal-feature" type="button" class="px-4 py-2 rounded font-medium border tm-border tm-surface-muted hover:tm-border-strong text-sm">Make featured</button>
              <a href="/site/contact.html" class="px-4 py-2 rounded font-medium tm-primary-bg text-slate-950 hover:opacity-90 text-sm">Talk to us</a>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    'use strict';

    const defaultConfig = {
      background_color: '#020617',
      cta_primary: 'Review Featured Analysis',
      cta_secondary: 'Browse All Cases',
      font_family: 'DM Sans',
      font_size: 16,
      hero_headline: 'Clarity Before Resolution',
      hero_subheadline: 'Real-world examples of what happens when resolution begins without verified IRS account data.',
      primary_action_color: '#f59e0b',
      secondary_action_color: '#94a3b8',
      surface_color: '#1e293b',
      text_color: '#f1f5f9'
    };

    function el(id) { return document.getElementById(id); }

    function safeText(v) {
      if (typeof v !== 'string') return '';
      return v;
    }

    function clampPercent(n, fallback) {
      const x = Number(n);
      if (!Number.isFinite(x)) return fallback;
      return Math.max(0, Math.min(100, x));
    }

    async function onConfigChange(config) {
      const heroHeadline = el('hero-headline');
      const heroSubheadline = el('hero-subheadline');
      const ctaPrimaryText = el('cta-primary-text');
      const ctaSecondaryText = el('cta-secondary-text');

      const baseFontStack = 'system-ui, sans-serif';
      const customFont = config.font_family || defaultConfig.font_family;

      if (heroHeadline) heroHeadline.textContent = config.hero_headline || defaultConfig.hero_headline;
      if (heroSubheadline) heroSubheadline.textContent = config.hero_subheadline || defaultConfig.hero_subheadline;
      if (ctaPrimaryText) ctaPrimaryText.textContent = config.cta_primary || defaultConfig.cta_primary;
      if (ctaSecondaryText) ctaSecondaryText.textContent = config.cta_secondary || defaultConfig.cta_secondary;

      const bg = config.background_color || defaultConfig.background_color;
      const surface = config.surface_color || defaultConfig.surface_color;
      const text = config.text_color || defaultConfig.text_color;
      const primary = config.primary_action_color || defaultConfig.primary_action_color;
      const secondary = config.secondary_action_color || defaultConfig.secondary_action_color;

      document.documentElement.style.setProperty('--bg', bg);
      document.documentElement.style.setProperty('--surface', surface);
      document.documentElement.style.setProperty('--text', text);
      document.documentElement.style.setProperty('--primary', primary);
      document.documentElement.style.setProperty('--secondary', secondary);

      document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
    }

    function mapToCapabilities(config) {
      return {
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => { config.font_family = value; window.elementSdk.setConfig({ font_family: value }); }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (value) => { config.font_size = value; window.elementSdk.setConfig({ font_size: value }); }
        },
        recolorables: [
          { get: () => config.background_color || defaultConfig.background_color, set: (value) => { config.background_color = value; window.elementSdk.setConfig({ background_color: value }); } },
          { get: () => config.primary_action_color || defaultConfig.primary_action_color, set: (value) => { config.primary_action_color = value; window.elementSdk.setConfig({ primary_action_color: value }); } },
          { get: () => config.secondary_action_color || defaultConfig.secondary_action_color, set: (value) => { config.secondary_action_color = value; window.elementSdk.setConfig({ secondary_action_color: value }); } },
          { get: () => config.surface_color || defaultConfig.surface_color, set: (value) => { config.surface_color = value; window.elementSdk.setConfig({ surface_color: value }); } },
          { get: () => config.text_color || defaultConfig.text_color, set: (value) => { config.text_color = value; window.elementSdk.setConfig({ text_color: value }); } }
        ]
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ['cta_primary', config.cta_primary || defaultConfig.cta_primary],
        ['cta_secondary', config.cta_secondary || defaultConfig.cta_secondary],
        ['hero_headline', config.hero_headline || defaultConfig.hero_headline],
        ['hero_subheadline', config.hero_subheadline || defaultConfig.hero_subheadline]
      ]);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }

    const caseData = [
      {
        id: '01',
        tagKey: 'ethics',
        tagLabel: 'Ethics',
        title: 'Is There a Human in There?',
        blurb: 'A compliance call that reveals the difference between scripted procedure and real authority.',
        subtitle: 'Structure, humanity, and real-time verification',
        icon: 'user',
        body: {
          problem: 'On a routine compliance call, an IRS agent asked: "Has your CAF changed in the last few moments we’ve been talking?" It was clearly a required question delivered with a fun spin. Scripted. Procedural. Structured. Compliance calls follow cadence, not conversation. Same questions. Same order. Different agent.',
          assumed: 'Many firms assume compliance calls are adversarial checkpoints or mere formalities. That resolution happens through persuasion, positioning, or packaged solutions.',
          revealed: 'What actually matters is real-time account clarity. This moment. This day. This account. Verified records. Structured questions. Expert judgment. A live conversation with the client present. Not marketing. Not promises. Not "we resolve."',
          risk: 'When structure is replaced by automation or sales scripting, the human element disappears. Clients become case numbers. Authority erodes. Engagements stall. Trust weakens because clarity was never established in the first place.',
          lesson: 'Compliance calls test structure, not charisma. Authority lives where verified data, structured inquiry, and human judgment meet. The engagement must be defined, guided, documented, and closed with clarity, not momentum.'
        },
        compare: {
          resolutionFirst: [
            'Lead with resolution pitch',
            'Assume suitability before verification',
            'Treat compliance call as procedural hurdle',
            'Client hears promises before facts',
            'Trust depends on outcome, not clarity'
          ],
          clarityFirst: [
            'Define engagement before strategy',
            'Verify account data in real time',
            'Use structured questioning',
            'Client present during verification',
            'Trust built on documented clarity'
          ]
        },
        timeline: {
          resolutionFirstLabel: 'Momentum without clarity',
          resolutionFirstWidth: 85,
          clarityFirstLabel: 'Defined scope / Clean close',
          clarityFirstWidth: 40
        }
      },
      {
        id: '02',
        tagKey: 'financial',
        tagLabel: 'Financial Risk',
        title: 'The $3,000 Contract That Never Ended',
        blurb: 'When a resolution engagement has no defined end, it quietly becomes an infinite obligation.',
        subtitle: 'Infinite scope disguised as service',
        icon: 'coin',
        body: {
          problem: 'A resolution case was marked complete in January 2024. The client paid roughly $3,000. Agreement signed. File closed. On paper, it ended. In reality, it never did. Notices kept arriving. Staff kept replying "real quick." Emails reopened old context. No new invoice. No new scope. By 2026, the firm was still working the case. 2026 labor. Paid with 2024 dollars.',
          assumed: 'Resolution was treated as a state rather than a phase. Once the issue was addressed, the engagement was considered implicitly ongoing. Small follow-ups felt harmless. Quick replies felt like good service.',
          revealed: 'Without a defined stopping point, every open thread becomes assumed service. Every notice reactivates obligation. There was no artifact stating: "This engagement is complete. This is what was determined. This is what happens next." The structure failed, not the people.',
          risk: 'The real risk is not underpricing. It is infinite obligation. Quiet scope expansion erodes margins, authority, and calendar control. If the contract does not end, it owns the firm.',
          lesson: 'Resolution engagements must be defined as phases with clear deliverables and a documented close. Firms do not sell outcomes. They deliver expert clarity, define boundaries, and close the engagement cleanly.'
        },
        compare: {
          resolutionFirst: [
            'Sell resolution as finished state',
            'Mark case complete without final artifact',
            'Reply to notices as courtesy',
            'No boundary between phases',
            'Future labor absorbed silently'
          ],
          clarityFirst: [
            'Define engagement scope in writing',
            'Deliver documented findings',
            'Issue clear completion notice',
            'Separate new work from prior phase',
            'Protect calendar and authority'
          ]
        },
        timeline: {
          resolutionFirstLabel: 'Open-ended obligation',
          resolutionFirstWidth: 95,
          clarityFirstLabel: 'Defined phase / Clean close',
          clarityFirstWidth: 45
        }
      },
      {
        id: '03',
        tagKey: 'ethics',
        tagLabel: 'Ethics',
        title: 'Outcome Menus & False Choice',
        blurb: 'Resolution promises made before account data review. Marketing framed as suitability.',
        subtitle: 'Selling certainty without verification',
        icon: 'alert',
        body: {
          problem: 'Advertisements promise: "We can get the IRS off your back for good. Call now." Or testimonials declare: "I owed $50,000 and with X company’s help I’m now debt free." These claims are presented before transcripts are reviewed, before compliance history is examined, before anyone knows whether relief was statistically or legally viable. Resolution is sold as certainty without data.',
          assumed: 'The consultation is structured like a menu. Installment Agreement. Offer in Compromise. Currently Not Collectible. The client is presented with options before suitability is determined. The assumption is that one of them must fit.',
          revealed: 'Without verified IRS account data, there is no basis for a promise. Collection statute dates, filing gaps, prior defaults, income volatility, assessed balances, and enforcement status determine feasibility. Marketing certainty replaces professional judgment.',
          risk: 'False certainty creates client harm and professional exposure. When expectations are set before analysis, trust collapses once reality contradicts the promise. Circular 230 standards (especially in Part 10) exist to prevent false, misleading, or deceptive representations that cannot be supported without verified account data.',
          lesson: 'Resolution options must follow transcript analysis, not precede it. The ethical code in Circular 230 Part 10 exists to stop promises without a factual foundation. Firms do not sell outcomes. They determine suitability based on verified records, then advise accordingly. Structure must prevent promises before proof.'
        },
        compare: {
          resolutionFirst: [
            'Advertise guaranteed relief',
            'Present solution menu before transcript review',
            'Imply certainty without data',
            'Collect fee on assumed suitability',
            'Correct expectations after engagement'
          ],
          clarityFirst: [
            'Obtain and analyze transcripts first',
            'Identify statutory and compliance limits',
            'Rule out ineligible options',
            'Set expectations based on evidence',
            'Recommend only viable strategies'
          ]
        },
        timeline: {
          resolutionFirstLabel: 'Expectation inflation / later correction',
          resolutionFirstWidth: 90,
          clarityFirstLabel: 'Data review / informed recommendation',
          clarityFirstWidth: 40
        }
      },
      {
        id: '04',
        tagKey: 'operational',
        tagLabel: 'Operational Design',
        title: 'The EIC Credit That Was Never Possible',
        blurb: 'Selling EIC recovery without prerequisites. The client pays for an outcome that compliance history makes impossible.',
        subtitle: 'Promised outcomes without prerequisites',
        icon: 'doc',
        body: {
          problem: 'Client paid for "help getting EIC." The client would not provide required information. Transcripts showed non-compliance. The credit could not be claimed. The client perceived failure.',
          assumed: 'The engagement was sold as a credit outcome, not a determination. The assumption was: "We can get you EIC" even though eligibility depends on facts that were not collected or verified.',
          revealed: 'EIC requires specific qualifying facts and filing compliance. If the client will not provide required details and the transcript history shows non-compliance, there is no legitimate path to claim the credit.',
          risk: 'You get the worst combination: client disappointment plus professional exposure. The firm is blamed for failing to deliver something that was never possible from the start.',
          lesson: 'TM alternative: Transcript → expert determination → report → contract closed. Sell the determination, not the credit. The structure prevents a promise that depends on missing facts.'
        },
        compare: {
          resolutionFirst: [
            'Sell EIC recovery as outcome',
            'Begin work without eligibility facts',
            'Delay proof until after fee',
            'Client interprets ineligibility as failure',
            'No clean close when credit is impossible'
          ],
          clarityFirst: [
            'Pull transcripts first',
            'Collect required eligibility facts',
            'Issue determination with documentation',
            'Explain why credit is or isn’t viable',
            'Close engagement with artifact'
          ]
        },
        timeline: {
          resolutionFirstLabel: 'Promise first / Reality later',
          resolutionFirstWidth: 85,
          clarityFirstLabel: 'Verify / Determine / Close',
          clarityFirstWidth: 40
        }
      },
      {
        id: '05',
        tagKey: 'financial',
        tagLabel: 'Financial Risk',
        title: 'The OIC That Should Never Have Been Filed',
        blurb: 'An Offer in Compromise submitted without reviewing collection statute. Costing the client time, money, and eligibility.',
        subtitle: 'CSED ignored before OIC',
        icon: 'scales',
        body: {
          problem: 'Client paid $7,500 for OIC preparation and filing. Application was rejected. Collection statute had 14 months remaining, the liability would have expired before any OIC processing completed.',
          assumed: 'Client owed $84,000. OIC was the "best option" based on income and asset evaluation. Filing would protect from enforcement.',
          revealed: 'Collection Statute Expiration Date (CSED) was December 2024. Average OIC processing time: 18-24 months. Even if accepted, client would pay more than waiting.',
          risk: '$7,500 fee for inappropriate service. OIC filing suspended collection statute, adding months to liability. Client harm compounded by solution design.',
          lesson: 'CSED analysis must precede any OIC recommendation. This is not about due diligence, it is about having account data before offering solutions.'
        },
        compare: {
          resolutionFirst: [
            'Intake call presents OIC as solution',
            'Fee collected before transcript review',
            'CSED discovered after filing',
            'Client pays for inappropriate service',
            'Statute suspended, extending liability'
          ],
          clarityFirst: [
            'Transcript analysis before consultation',
            'CSED identified in initial review',
            'OIC ruled out as option',
            'Monitoring strategy recommended',
            'Client protected from unnecessary cost'
          ]
        },
        timeline: {
          resolutionFirstLabel: '+$7,500 / +18 months liability',
          resolutionFirstWidth: 100,
          clarityFirstLabel: '$0 unnecessary / Natural expiration',
          clarityFirstWidth: 35
        }
      },
      {
        id: '06',
        tagKey: 'industry',
        tagLabel: 'Industry Norms',
        title: 'The Lamborghini Firm',
        blurb: '$3,000 per client. One new client per day. When volume math starts driving resolution advice.',
        subtitle: 'Overhead creates incentive pressure',
        icon: 'building',
        body: {
          problem: 'Average fee per client: $3,000. The owner openly stated he added one new client per day. Advertising promised: "We’ve handled thousands of cases like yours." Prospects were told they could likely resolve their issue through an Offer in Compromise. During intake, income and expenses were gathered over the phone, similar to a simplified Form 433 discussion.',
          assumed: 'If income and expenses appear workable on a quick call, OIC must be viable. High case volume justifies standardized solution pathways. Selling confidence builds momentum.',
          revealed: 'What was not reviewed before payment: CSED, filing compliance history, prior default status, income volatility, enforcement posture. Without transcript verification, the financial picture discussed on the phone was incomplete. Volume math required closing one client per day to sustain revenue flow.',
          risk: 'When overhead depends on daily acquisition, structural pressure shifts from verification to conversion. Suitability becomes secondary to intake volume. The firm may not intend harm, but the incentive design increases the likelihood of recommending OIC before eligibility is confirmed.',
          lesson: 'When revenue depends on one new $3,000 client per day, the structure itself influences advice. Clarity-first design removes conversion pressure by separating determination from resolution. Transcript review must precede any OIC positioning. Math should never dictate suitability.'
        },
        compare: {
          resolutionFirst: [
            'Promise high-volume experience',
            'Position OIC during intake',
            'Collect simplified financial data by phone',
            'Accept payment before transcript review',
            'Revenue target drives daily intake'
          ],
          clarityFirst: [
            'Pull transcripts before recommendation',
            'Review CSED and compliance history',
            'Evaluate income stability over time',
            'Rule out ineligible strategies early',
            'Separate determination from resolution sale'
          ]
        },
        timeline: {
          resolutionFirstLabel: 'Daily conversion pressure',
          resolutionFirstWidth: 95,
          clarityFirstLabel: 'Verify before advising',
          clarityFirstWidth: 40
        }
      },
      {
        id: '07',
        tagKey: 'operational',
        tagLabel: 'Operational Design',
        title: 'The New Pro Trap',
        blurb: 'Good practitioners inheriting broken workflows and the predictable harm that follows.',
        subtitle: 'Good intentions, weak structure',
        icon: 'search',
        body: {
          problem: 'A new practitioner inherits hundreds of active resolution cases. There is no documented workflow. Deadlines are unclear. Notices are untracked. Statute dates are not noted. Case stage is ambiguous for both client and practitioner.',
          assumed: 'Professional skill can compensate for structural gaps. Case status will become clear once the file is reviewed. Growth pressure justifies operational looseness.',
          revealed: 'Without workflow, deadlines were missed. Notices were not followed up on. Statute dates were not tracked. Clients became confused and frustrated. Time and money were wasted correcting preventable issues.',
          risk: 'Missed deadlines increase enforcement exposure. Untracked CSED distorts strategy. Client trust erodes when progress is invisible. The harm is structural, not personal.',
          lesson: 'Skill cannot replace workflow. Resolution requires defined stages, statute tracking, notice tracking, responsibility markers, and client-facing visibility. Structure prevents preventable failure.'
        },
        compare: {
          resolutionFirst: [
            'Rely on individual memory',
            'Deadlines tracked informally',
            'Case stage unclear',
            'Reactive client communication',
            'Correct preventable errors later'
          ],
          clarityFirst: [
            'Defined case stages',
            'Documented deadline tracking',
            'Visible case status',
            'Structured onboarding steps',
            'Prevent issues before escalation'
          ]
        },
        timeline: {
          resolutionFirstLabel: 'Ambiguity / Correction',
          resolutionFirstWidth: 90,
          clarityFirstLabel: 'Defined / Predictable',
          clarityFirstWidth: 40
        }
      },
      {
        id: '08',
        tagKey: 'structural',
        tagLabel: 'Structural Reform',
        title: 'Compliance vs. Resolution Reality',
        blurb: 'Credentialing teaches standards. Resolution requires operational architecture.',
        subtitle: 'Education without workflow',
        icon: 'shield',
        body: {
          problem: 'Tax professionals complete rigorous credentialing processes and learn IRS structure, thresholds, and standards. But resolution workflow design is not part of that education.',
          assumed: 'Technical knowledge automatically produces procedural clarity. Knowing the law means knowing how to run the case.',
          revealed: 'Resolution work requires front-loaded factual completeness, transcript verification, statute tracking, enforcement review, and defined sequencing. Education teaches standards. It does not teach case architecture.',
          risk: 'Without workflow, strategy can begin before verification. Deadlines can be missed. Recommendations may be premature. The issue is not ignorance but absence of design.',
          lesson: 'Professional competence is necessary. Structure is protective. Resolution requires defined stages, verification gates, and documented sequencing before recommendations are made.'
        },
        compare: {
          resolutionFirst: [
            'Lead with legal knowledge',
            'Assume facts will emerge',
            'Begin strategy early',
            'Rely on memory and experience',
            'Correct course midstream'
          ],
          clarityFirst: [
            'Mandate transcript retrieval',
            'Validate factual completeness',
            'Track statute and enforcement',
            'Stage case progression',
            'Recommend only after verification'
          ]
        },
        timeline: {
          resolutionFirstLabel: 'Knowledge without structure',
          resolutionFirstWidth: 85,
          clarityFirstLabel: 'Structure reinforcing standards',
          clarityFirstWidth: 40
        }
      },
      {
        id: '09',
        tagKey: 'operational',
        tagLabel: 'Operational Design',
        title: 'You’re Already Doing Parts of This',
        blurb: 'Informal transcript monitoring that needs structure, scope, and closure.',
        subtitle: 'From informal value to defined service',
        icon: 'check',
        body: {
          problem: 'Some professionals already pull transcripts under existing authorization and discover planning or resolution opportunities. The clarity exists, but it is not defined as a standalone service.',
          assumed: 'Transcript pulls are internal tools. Value lies in the solution, not the verification. Clients can access and interpret transcripts on their own.',
          revealed: 'Transcript retrieval and interpretation requires skill, authorization, and experience. Access is not always simple. Interpretation is never simple. The true value being delivered is verified visibility.',
          risk: 'Without structure, monitoring becomes opportunistic. Scope and duration are undefined. Revenue timing influences transcript review. Informal value is difficult to price, scale, or close cleanly.',
          lesson: 'Formalize transcript monitoring as a defined service. Set duration, scope, and deliverable. Charge for clarity itself. Separate monitoring from resolution.'
        },
        compare: {
          resolutionFirst: [
            'Pull transcripts when convenient',
            'Upsell after discovery',
            'Undefined monitoring duration',
            'Value tied to resolution',
            'Scope left open'
          ],
          clarityFirst: [
            'Define monitoring as service',
            'Set fixed duration',
            'Deliver written findings',
            'Charge for visibility',
            'Close engagement cleanly'
          ]
        },
        timeline: {
          resolutionFirstLabel: 'Opportunity-driven',
          resolutionFirstWidth: 85,
          clarityFirstLabel: 'Defined visibility phase',
          clarityFirstWidth: 40
        }
      },
      {
        id: '10',
        tagKey: 'structural',
        tagLabel: 'Structural Reform',
        title: 'The Structure',
        blurb: 'Clarity-first architecture that separates determination from resolution.',
        subtitle: 'Design beats assumption',
        icon: 'grid',
        body: {
          problem: 'Traditional bundled resolution agreements list multiple potential services before suitability is verified, creating scope ambiguity and premature positioning.',
          assumed: 'A resolution path will be required. One of the listed options will apply. Effort equals deliverable.',
          revealed: 'Resolution is conditional. Eligibility depends on verified transcripts, confirmed CSED, compliance status, enforcement posture, and factual completeness.',
          risk: 'Bundled agreements can blur scope, inflate expectations, and delay suitability determination. The issue is sequence, not intent.',
          lesson: 'Clarity-first architecture separates engagement into phases. Phase 1: determination with defined scope and written artifact. Phase 2: resolution only if viable. One service. One specification. One stop point.'
        },
        compare: {
          resolutionFirst: [
            'Bundle multiple pathways',
            'Assume resolution needed',
            'Price before viability',
            'Blur phase boundaries',
            'Leave closure ambiguous'
          ],
          clarityFirst: [
            'Single-service determination phase',
            'Verify before advising',
            'Deliver written artifact',
            'Close phase explicitly',
            'Offer resolution only if viable'
          ]
        },
        timeline: {
          resolutionFirstLabel: 'Assumption-driven',
          resolutionFirstWidth: 90,
          clarityFirstLabel: 'Clarity-first sequencing',
          clarityFirstWidth: 40
        }
      }
    ];

    const tagToClass = {
      ethics: 'tag-ethics',
      financial: 'tag-financial',
      industry: 'tag-industry',
      operational: 'tag-operational',
      structural: 'tag-structural'
    };

    const iconSvg = {
      alert: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>',
      building: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>',
      check: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',
      coin: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>',
      doc: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>',
      grid: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>',
      scales: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>',
      search: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>',
      shield: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>',
      user: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>'
    };

    function getIconStyles(tagKey) {
      const map = {
        ethics: { fg: 'var(--primary)', bg: 'color-mix(in srgb, var(--primary) 18%, transparent)' },
        financial: { fg: '#fca5a5', bg: 'rgba(239, 68, 68, 0.16)' },
        industry: { fg: '#93c5fd', bg: 'rgba(59, 130, 246, 0.16)' },
        operational: { fg: '#6ee7b7', bg: 'rgba(16, 185, 129, 0.16)' },
        structural: { fg: '#d8b4fe', bg: 'rgba(168, 85, 247, 0.16)' }
      };
      return map[tagKey] || map.ethics;
    }

    function renderCompareBlock(c) {
      const rf = (c.compare && Array.isArray(c.compare.resolutionFirst)) ? c.compare.resolutionFirst : [];
      const cf = (c.compare && Array.isArray(c.compare.clarityFirst)) ? c.compare.clarityFirst : [];

      return `
        <div class="tm-surface-muted border tm-border rounded-xl overflow-hidden">
          <div class="grid grid-cols-1 md:grid-cols-2">
            <div class="p-6 border-b md:border-b-0 md:border-r tm-border" style="background: rgba(239, 68, 68, 0.06);">
              <div class="flex items-center gap-2 mb-4">
                <svg class="w-5 h-5" style="color: #fca5a5;" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                <h4 class="font-semibold">Resolution First</h4>
              </div>
              <ul class="space-y-3 text-sm tm-text-muted">
                ${rf.map(x => `<li class="flex items-start gap-2"><span class="w-1.5 h-1.5 rounded-full mt-1.5 flex-shrink-0" style="background:#fca5a5;"></span><span>${safeText(x)}</span></li>`).join('')}
              </ul>
            </div>

            <div class="p-6" style="background: color-mix(in srgb, var(--primary) 10%, transparent);">
              <div class="flex items-center gap-2 mb-4">
                <svg class="w-5 h-5" style="color: var(--primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                <h4 class="font-semibold">Clarity First</h4>
              </div>
              <ul class="space-y-3 text-sm tm-text-muted">
                ${cf.map(x => `<li class="flex items-start gap-2"><span class="w-1.5 h-1.5 rounded-full mt-1.5 flex-shrink-0" style="background:var(--primary);"></span><span>${safeText(x)}</span></li>`).join('')}
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    function renderTimelineBlock(c, compact) {
      const tl = c.timeline || {};
      const rfW = clampPercent(tl.resolutionFirstWidth, 100);
      const cfW = clampPercent(tl.clarityFirstWidth, 35);
      const wrapClass = compact ? 'tm-surface-muted border tm-border rounded-xl p-6' : 'mt-6 tm-surface-muted border tm-border rounded-xl p-6';

      return `
        <div class="${wrapClass}">
          <h4 class="text-sm font-semibold mb-4">Timeline Comparison</h4>
          <div class="space-y-4">
            <div>
              <div class="flex justify-between text-xs tm-text-muted mb-1">
                <span>Resolution First Path</span>
                <span style="color:#fca5a5;">${safeText(tl.resolutionFirstLabel || '')}</span>
              </div>
              <div class="h-3 rounded-full overflow-hidden" style="background: rgba(148, 163, 184, 0.14);">
                <div class="h-full rounded-full" style="width:${rfW}%; background: linear-gradient(to right, rgba(239,68,68,0.9), rgba(239,68,68,0.55));"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-xs tm-text-muted mb-1">
                <span>Clarity First Path</span>
                <span style="color:var(--primary);">${safeText(tl.clarityFirstLabel || '')}</span>
              </div>
              <div class="h-3 rounded-full overflow-hidden" style="background: rgba(148, 163, 184, 0.14);">
                <div class="h-full rounded-full" style="width:${cfW}%; background: linear-gradient(to right, var(--primary), color-mix(in srgb, var(--primary) 70%, #ffffff));"></div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderCaseCard(c) {
      const tagClass = tagToClass[c.tagKey] || 'tag-ethics';
      const iconPath = iconSvg[c.icon] || iconSvg.doc;
      const icon = getIconStyles(c.tagKey);

      return `
        <article class="card-hover tm-surface-muted border tm-border rounded-lg p-6 flex flex-col" data-case-id="${c.id}">
          <div class="flex items-start justify-between mb-4">
            <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background:${icon.bg};">
              <svg class="w-5 h-5" style="color:${icon.fg};" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">${iconPath}</svg>
            </div>
            <span class="${tagClass} text-xs font-medium px-2 py-1 rounded">${safeText(c.tagLabel)}</span>
          </div>
          <h3 class="text-lg font-semibold mb-2">${safeText(c.title)}</h3>
          <p class="text-sm tm-text-muted mb-4 flex-grow">${safeText(c.blurb)}</p>
          <button type="button" class="case-open text-sm font-medium tm-primary hover:opacity-90 flex items-center gap-1 mt-auto" aria-label="Read case ${safeText(c.title)}">
            Read Case
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </article>
      `;
    }

    function renderModalBody(c) {
      const b = c.body || {};
      const sections = [
        { k: 'problem', t: 'The Problem' },
        { k: 'assumed', t: 'What Was Assumed' },
        { k: 'revealed', t: 'What the Data Revealed' },
        { k: 'risk', t: 'Financial / Ethical Risk' },
        { k: 'lesson', t: 'Structural Lesson' }
      ];

      const blocks = sections.map(s => {
        return `
          <div class="border-b tm-border pb-5 mb-5">
            <h4 class="text-xs font-semibold tm-text-subtle uppercase tracking-wider mb-2">${s.t}</h4>
            <p class="tm-text">${safeText(b[s.k] || '(Missing)')}</p>
          </div>
        `;
      }).join('');

      return `${blocks}${renderCompareBlock(c)}${renderTimelineBlock(c, false)}`;
    }

    function setFeatured(c) {
      const title = el('featured-title');
      const subtitle = el('featured-subtitle');
      const body = el('featured-body');
      const compare = el('featured-compare');
      const timeline = el('featured-timeline');

      if (title) title.textContent = safeText(c.title);
      if (subtitle) subtitle.textContent = safeText(c.subtitle || '');

      if (body) {
        const b = c.body || {};
        body.innerHTML = `
          <div>
            <h4 class="text-xs font-semibold tm-text-subtle uppercase tracking-wider mb-2">The Problem</h4>
            <p>${safeText(b.problem || '(Missing)')}</p>
          </div>
          <div class="border-t tm-border pt-6">
            <h4 class="text-xs font-semibold tm-text-subtle uppercase tracking-wider mb-2">What Was Assumed</h4>
            <p>${safeText(b.assumed || '(Missing)')}</p>
          </div>
          <div class="border-t tm-border pt-6">
            <h4 class="text-xs font-semibold tm-text-subtle uppercase tracking-wider mb-2">What the Data Revealed</h4>
            <p>${safeText(b.revealed || '(Missing)')}</p>
          </div>
          <div class="border-t tm-border pt-6">
            <h4 class="text-xs font-semibold tm-text-subtle uppercase tracking-wider mb-2">Financial / Ethical Risk</h4>
            <p>${safeText(b.risk || '(Missing)')}</p>
          </div>
          <div class="border-t tm-border pt-6">
            <h4 class="text-xs font-semibold tm-text-subtle uppercase tracking-wider mb-2">Structural Lesson</h4>
            <p>${safeText(b.lesson || '(Missing)')}</p>
          </div>
        `;
      }

      if (compare) compare.innerHTML = renderCompareBlock(c);
      if (timeline) timeline.innerHTML = renderTimelineBlock(c, true);

      window.__featuredCaseId = c.id;
    }

    function openModal(c) {
      const modal = el('case-modal');
      if (!modal) return;

      const tag = el('modal-tag');
      const id = el('modal-id');
      const title = el('modal-title');
      const summary = el('modal-summary');
      const body = el('modal-body');

      const tagClass = tagToClass[c.tagKey] || 'tag-ethics';

      if (tag) {
        tag.className = `${tagClass} text-xs font-medium px-2 py-1 rounded`;
        tag.textContent = safeText(c.tagLabel);
      }
      if (id) id.textContent = `Case ${safeText(c.id)}`;
      if (title) title.textContent = safeText(c.title);
      if (summary) summary.textContent = safeText(c.blurb);
      if (body) body.innerHTML = renderModalBody(c);

      window.__activeCaseId = c.id;

      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      const modal = el('case-modal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }

    function getCaseById(id) {
      for (let i = 0; i < caseData.length; i++) {
        if (caseData[i].id === id) return caseData[i];
      }
      return null;
    }

    function matchesFilter(c, q, tagKey) {
      const text = `${c.title} ${c.blurb} ${c.tagLabel}`.toLowerCase();
      const queryOk = !q || text.includes(q);
      const tagOk = tagKey === 'all' || c.tagKey === tagKey;
      return queryOk && tagOk;
    }

    function scrollToId(id) {
      const target = document.getElementById(id);
      if (!target || !target.scrollIntoView) return;
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function wireScrollLinks() {
      const links = document.querySelectorAll('[data-scroll]');
      Array.prototype.forEach.call(links, (a) => {
        a.addEventListener('click', (e) => {
          const id = a.getAttribute('data-scroll') || '';
          if (!id) return;
          e.preventDefault();
          scrollToId(id);
        });
      });
    }

    function renderGrid() {
      const grid = el('case-grid');
      const search = el('case-search');
      const filter = el('case-filter');
      if (!grid) return;

      const q = ((search && search.value) ? search.value : '').trim().toLowerCase();
      const tagKey = (filter && filter.value) ? filter.value : 'all';

      const items = caseData
        .filter(c => matchesFilter(c, q, tagKey))
        .map(renderCaseCard)
        .join('');

      grid.innerHTML = items || `
        <div class="tm-surface-muted border tm-border rounded-xl p-6 md:col-span-2 lg:col-span-3">
          <div class="font-semibold">No matches</div>
          <div class="tm-text-muted text-sm mt-1">Try a different search or category.</div>
        </div>
      `;

      Array.prototype.forEach.call(grid.querySelectorAll('.case-open'), (btn) => {
        btn.addEventListener('click', (e) => {
          const target = e.target;
          const card = target && target.closest ? target.closest('[data-case-id]') : null;
          const id = card ? (card.getAttribute('data-case-id') || '') : '';
          const c = getCaseById(id);
          if (!c) return;
          openModal(c);
          setFeatured(c);
          scrollToId('featured');
        });
      });
    }

    function runSelfTests() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('debug') !== '1') return;

      function assert(name, ok) {
        if (!ok) throw new Error(`Test failed: ${name}`);
      }

      const ids = caseData.map(c => c.id);
      const uniqueIds = new Set(ids);

      assert('caseData has 10 cases', Array.isArray(caseData) && caseData.length === 10);
      assert('case IDs are unique', uniqueIds.size === caseData.length);
      assert('case 04 exists', !!getCaseById('04'));
      assert('compare block renders', typeof renderCompareBlock(caseData[0]) === 'string' && renderCompareBlock(caseData[0]).includes('Resolution First'));
      assert(
        'timeline clamp',
        renderTimelineBlock({ timeline: { resolutionFirstWidth: 999, clarityFirstWidth: -10 } }, true).includes('width:100%') &&
        renderTimelineBlock({ timeline: { resolutionFirstWidth: 999, clarityFirstWidth: -10 } }, true).includes('width:0%')
      );
      assert(
        'required keys exist',
        caseData.every(c => typeof c.id === 'string' && typeof c.tagKey === 'string' && typeof c.title === 'string' && c.body && typeof c.body === 'object')
      );
      assert('cta primary text span exists', !!el('cta-primary-text'));
      assert('cta secondary text span exists', !!el('cta-secondary-text'));

      // Modal open/close toggles
      const modal = el('case-modal');
      openModal(caseData[0]);
      assert('modal opens', modal && !modal.classList.contains('hidden') && modal.getAttribute('aria-hidden') === 'false');
      closeModal();
      assert('modal closes', modal && modal.classList.contains('hidden') && modal.getAttribute('aria-hidden') === 'true');

      console.log('Case Studies self-tests passed.');
    }

    document.addEventListener('DOMContentLoaded', () => {
      wireScrollLinks();
      renderGrid();

      const search = el('case-search');
      const filter = el('case-filter');
      if (search) search.addEventListener('input', renderGrid);
      if (filter) filter.addEventListener('change', renderGrid);

      // Featured defaults to Case 05.
      const defaultFeatured = getCaseById('05') || caseData[0];
      if (defaultFeatured) setFeatured(defaultFeatured);

      // Modal close: make it annoyingly reliable.
      const modal = el('case-modal');
      const modalClose = el('modal-close');
      if (modalClose) {
        modalClose.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeModal();
        });
      }
      if (modal) {
        modal.addEventListener('click', (e) => {
          const closeEl = e.target && e.target.closest ? e.target.closest('[data-close="true"]') : null;
          if (closeEl) closeModal();
        });
      }
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
      });

      // Featured open
      const featuredOpen = el('featured-open');
      if (featuredOpen) {
        featuredOpen.addEventListener('click', () => {
          const id = window.__featuredCaseId || '05';
          const c = getCaseById(id);
          if (c) openModal(c);
        });
      }

      // Modal make featured
      const modalFeature = el('modal-feature');
      if (modalFeature) {
        modalFeature.addEventListener('click', () => {
          const id = window.__activeCaseId || '';
          const c = getCaseById(id);
          if (c) setFeatured(c);
          closeModal();
          scrollToId('featured');
        });
      }

      // Intersection animations
      if ('IntersectionObserver' in window) {
        const observerOptions = { rootMargin: '0px 0px -50px 0px', threshold: 0.1 };
        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => { if (entry.isIntersecting) entry.target.classList.add('fade-in'); });
        }, observerOptions);
        Array.prototype.forEach.call(document.querySelectorAll('section'), (section) => observer.observe(section));
      }

      runSelfTests();
    });
  </script>
</body>
</html>